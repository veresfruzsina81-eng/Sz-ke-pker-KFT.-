<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Szőke Épker Webshop</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{--ink:#1f2937;--muted:#6b7280;--bg:#f7f4ef;--card:#fff;--brand:#8b5e34;--ring:0 0 0 3px rgba(193,154,107,.25);--radius:16px}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee3d6}
.head-inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand img{height:26px}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
.filters{max-width:1100px;margin:0 auto;padding:12px 16px;display:grid;grid-template-columns:1fr auto;gap:10px}
#search,#sort{border:1px solid #eadfce;border-radius:12px;padding:10px 12px;background:#fff;font:inherit}
@media(max-width:640px){.filters{grid-template-columns:1fr}}
.container{max-width:1100px;margin:0 auto;padding:6px 16px 16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{background:var(--card);border:1px solid #eee3d6;border-radius:14px;padding:12px;box-shadow:0 10px 24px rgba(87,61,34,.05);display:flex;flex-direction:column}
.card img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid #eee3d6;background:#f7f4ef}
.title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:8px}
.price{color:var(--muted);margin-top:2px}
.actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.qty{display:inline-flex;align-items:center;border:1px solid #eadfce;border-radius:12px;overflow:hidden}
.qty button{background:#fff;color:var(--ink);border:0;padding:6px 10px;cursor:pointer}
.qty input{width:48px;text-align:center;border:0;height:34px}
.cart{position:fixed;right:0;top:0;height:100vh;width:420px;max-width:95vw;background:#fff;border-left:1px solid #eee3d6;box-shadow:-20px 0 40px rgba(0,0,0,.08);transform:translateX(100%);transition:transform .25s ease;z-index:60;display:flex;flex-direction:column}
.cart.open{transform:translateX(0)}
.cart .top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee3d6}
.cart .body{padding:12px 14px;overflow:auto;flex:1}
.cart .foot{padding:12px 14px;border-top:1px solid #eee3d6;background:#faf7f2;position:sticky;bottom:0}
.itemline{display:grid;grid-template-columns:60px 1fr auto;align-items:center;gap:10px;border:1px solid #eee3d6;border-radius:12px;padding:8px 10px}
.itemline img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee3d6}
.itemline .t{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.muted{color:var(--muted)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:70;padding:14px}
.modal.open{display:flex}
.modal>.card{max-width:900px;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:800px){.modal>.card{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="header">
  <div class="head-inner">
    <div class="brand"><img src="logo.png" alt=""><span>Szőke-Épker Kft.</span></div>
    <div class="row">
      <button class="btn ghost" onclick="location.href='/'">Vissza a főoldalra</button>
      <button id="cartBtn" class="btn" type="button">Kosár (<span id="cartCount">0</span>)</button>
    </div>
  </div>
</div>

<div class="filters">
  <input id="search" placeholder="Keresés a termékek közt…">
  <select id="sort">
    <option value="new">Legújabb</option>
    <option value="price_asc">Ár ↑</option>
    <option value="price_desc">Ár ↓</option>
  </select>
</div>

<main class="container">
  <div id="list" class="grid"></div>
  <div id="empty" class="muted">Nincs találat.</div>
</main>

<aside id="cart" class="cart" aria-hidden="true">
  <div class="top"><strong>Kosár</strong><button class="btn ghost" id="cartClose" type="button">✕</button></div>
  <div class="body" id="cartBody"></div>
  <div class="foot">
    <div class="row" style="justify-content:space-between">
      <strong>Összesen: <span id="sum">0</span> Ft</strong>
      <button class="btn" id="checkoutBtn" type="button">Megrendelés</button>
    </div>
    <div id="chk" style="margin-top:10px;display:none">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="c_name" placeholder="Név" style="flex:1 1 240px">
        <input id="c_email" placeholder="Email" style="flex:1 1 200px">
        <input id="c_phone" placeholder="Telefon" style="flex:1 1 160px">
        <input id="c_addr" placeholder="Cím" style="flex:1 1 300px">
        <input id="c_ship" placeholder="Szállítás módja (pl. futár)" style="flex:1 1 240px">
      </div>
      <textarea id="c_note" placeholder="Megjegyzés" rows="3" style="width:100%;margin-top:8px"></textarea>
      <button class="btn" id="sendBtn" type="button" style="margin-top:8px">Rendelés elküldése</button>
    </div>
  </div>
</aside>

<div id="modal" class="modal" aria-hidden="true">
  <div class="card">
    <img id="m_img" src="" alt="">
    <div>
      <div class="row" style="justify-content:space-between">
        <h3 id="m_title" style="margin:0"></h3>
        <button class="btn ghost" id="modalClose" type="button">✕</button>
      </div>
      <div class="muted" id="m_price" style="margin:6px 0"></div>
      <div id="m_desc" class="muted" style="white-space:pre-wrap"></div>
      <div class="row" style="margin-top:12px">
        <div class="qty">
          <button type="button" onclick="incModalQty(-1)">−</button>
          <input id="m_qty" value="1">
          <button type="button" onclick="incModalQty(1)">+</button>
        </div>
        <button class="btn" id="m_add" type="button">Kosárba</button>
      </div>
    </div>
  </div>
</div>

<script>
/*** Supabase ***/
const SUPABASE_URL  = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/*** Állapot ***/
let products = [];
let cart = [];
let current = null;

const nf = n => new Intl.NumberFormat('hu-HU').format(n||0);

/*** Init ***/
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadProducts();
  bindTop();
});

/*** Termékek ***/
async function loadProducts(){
  const {data,error} = await sb
    .from('products')
    .select('id,title,price,description,instock,image_url,created_at')
    .eq('instock',true)
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  products = data||[];
  renderList(products);
}

function renderList(list){
  const wrap = document.getElementById('list');
  if(!list.length){ wrap.innerHTML=''; document.getElementById('empty').style.display='block'; return; }
  document.getElementById('empty').style.display='none';
  wrap.innerHTML = list.map(p=>`
    <article class="card" data-id="${p.id}">
      <img src="${p.image_url||'logo.png'}" alt="">
      <div class="title">${p.title}</div>
      <div class="price">${nf(p.price)} Ft</div>
      <div class="actions">
        <div class="qty">
          <button type="button" onclick="incQty('${p.id}',-1)">−</button>
          <input id="q_${p.id}" value="1">
          <button type="button" onclick="incQty('${p.id}',1)">+</button>
        </div>
        <button class="btn" type="button" onclick="addFromCard('${p.id}')">Kosárba</button>
        <button class="btn ghost" type="button" onclick="openModal('${p.id}')">Megnyitás</button>
      </div>
    </article>
  `).join('');
}

/*** Kártya gombok – közvetlen onclick ***/
function incQty(id, delta){
  const el = document.getElementById('q_'+id);
  let v = parseInt(el.value||'1',10);
  v = isNaN(v)?1:v; v += delta; if(v<1) v=1; if(v>99) v=99;
  el.value = v;
}
function addFromCard(id){
  const el = document.getElementById('q_'+id);
  const q = clampQty(el?.value);
  addToCart(id,q,true);
}

/*** Fejléc/kosár ***/
function bindTop(){
  document.getElementById('cartBtn').onclick = openCart;
  document.getElementById('cartClose').onclick = closeCart;
  document.getElementById('checkoutBtn').onclick = ()=>{
    if(cart.length===0){ alert('A kosár üres.'); return; }
    document.getElementById('chk').style.display='block';
  };
  document.getElementById('sendBtn').onclick = sendOrder;

  document.getElementById('search').oninput = e=>{
    const q = e.target.value.toLowerCase();
    renderList(products.filter(p => (p.title||'').toLowerCase().includes(q)));
  };
  document.getElementById('sort').onchange = e=>{
    const v = e.target.value;
    const arr = [...products];
    if(v==='price_asc') arr.sort((a,b)=>(a.price||0)-(b.price||0));
    else if(v==='price_desc') arr.sort((a,b)=>(b.price||0)-(a.price||0));
    renderList(arr);
  };

  document.getElementById('modalClose').onclick = closeModal;
  document.getElementById('m_add').onclick = ()=>{
    const q = clampQty(document.getElementById('m_qty').value);
    addToCart(current.id,q,true);
    closeModal();
  };
}

/*** Modal ***/
function openModal(id){
  current = products.find(p=>p.id===id);
  if(!current) return;
  document.getElementById('m_img').src = current.image_url||'logo.png';
  document.getElementById('m_title').textContent = current.title;
  document.getElementById('m_price').textContent = nf(current.price)+' Ft';
  document.getElementById('m_desc').textContent = current.description||'Nincs leírás.';
  document.getElementById('m_qty').value = 1;
  document.getElementById('modal').classList.add('open');
}
function closeModal(){ document.getElementById('modal').classList.remove('open'); }
function incModalQty(d){
  const el = document.getElementById('m_qty');
  let v = parseInt(el.value||'1',10); if(isNaN(v)) v=1; v+=d; if(v<1)v=1; if(v>99)v=99; el.value=v;
}

/*** Kosár ***/
function clampQty(v){ v=parseInt(v||'1',10); if(isNaN(v)||v<1) v=1; if(v>99) v=99; return v; }
function openCart(){ document.getElementById('cart').classList.add('open'); }
function closeCart(){ document.getElementById('cart').classList.remove('open'); }

function addToCart(id, qty=1, open=false){
  const p = products.find(x=>x.id===id); if(!p) return;
  const i = cart.findIndex(x=>x.id===id);
  if(i>-1) cart[i].qty += qty; else cart.push({id:p.id,title:p.title,price:p.price,qty:qty,image_url:p.image_url});
  renderCart();
  if(open) openCart();
}
function changeQty(id, d){
  const i = cart.findIndex(x=>x.id===id); if(i<0) return;
  cart[i].qty += d; if(cart[i].qty<1) cart.splice(i,1);
  renderCart();
}
function removeLine(id){ cart = cart.filter(x=>x.id!==id); renderCart(); }

function renderCart(){
  const body = document.getElementById('cartBody');
  if(cart.length===0){ body.innerHTML = '<div class="muted">A kosár üres.</div>'; }
  else{
    body.innerHTML = cart.map(c=>`
      <div class="itemline">
        <img src="${c.image_url||'logo.png'}" alt="">
        <div>
          <div class="t">${c.title}</div>
          <div class="muted">${nf(c.price)} Ft</div>
          <div class="qty" style="margin-top:6px">
            <button type="button" onclick="changeQty('${c.id}',-1)">−</button>
            <input value="${c.qty}" disabled>
            <button type="button" onclick="changeQty('${c.id}',1)">+</button>
          </div>
        </div>
        <div style="text-align:right">
          <div><strong>${nf(c.price*c.qty)} Ft</strong></div>
          <button class="btn ghost" type="button" onclick="removeLine('${c.id}')">Eltávolítás</button>
        </div>
      </div>
    `).join('');
  }
  const sum = cart.reduce((s,x)=>s+x.price*x.qty,0);
  document.getElementById('sum').textContent = nf(sum);
  document.getElementById('cartCount').textContent = cart.reduce((s,x)=>s+x.qty,0);
}

/*** Rendelés ***/
async function sendOrder(){
  if(cart.length===0){ alert('A kosár üres.'); return; }
  const name = document.getElementById('c_name').value.trim();
  const email= document.getElementById('c_email').value.trim();
  const phone= document.getElementById('c_phone').value.trim();
  const addr = document.getElementById('c_addr').value.trim();
  const ship = document.getElementById('c_ship').value.trim();
  const note = document.getElementById('c_note').value.trim();
  if(!name||!email||!phone||!addr){ alert('Kérjük, tölts ki minden mezőt.'); return; }

  const subtotal = cart.reduce((s,x)=>s+x.price*x.qty,0);
  const shipping_cost = 0, total = subtotal+shipping_cost;

  const payload = {
    name,email,phone,address:addr,shipping:ship||'Ismeretlen',note,
    items: cart.map(c=>({id:c.id,title:c.title,price:c.price,qty:c.qty})),
    subtotal,shipping_cost,total
  };
  const {error} = await sb.from('orders').insert(payload);
  if(error){ alert('Hiba: '+error.message); return; }

  cart=[]; renderCart(); document.getElementById('chk').style.display='none';
  alert('Köszönjük! A rendelést rögzítettük.');
  closeCart();
}
</script>
</body>
</html>
