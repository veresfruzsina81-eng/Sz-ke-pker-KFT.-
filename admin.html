<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Szőke Épker – Admin</title>
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/supabase.js"></script>
  <!-- Ikonok -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#0fa3b1;        /* türkizkék gomb */
      --brand-2:#fde68a;      /* finom bézs háttér sáv */
      --ink:#101828;
      --muted:#667085;
      --bg:#f6f7f9;
      --card:#ffffff;
      --bad:#e11d48;
      --ok:#16a34a;
      --ring: 0 0 0 3px rgba(15,163,177,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
      color:var(--ink); background:var(--bg);
    }
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:24px 16px}
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));
      border-bottom:1px solid #eef1f5;
      backdrop-filter:saturate(180%) blur(6px);
    }
    .row{display:flex; align-items:center; gap:16px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .brand img{height:28px}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 16px; font-weight:600;
      background:var(--brand); color:#fff; cursor:pointer; transition:transform .05s ease;
      box-shadow:0 2px 0 rgba(0,0,0,.06);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.outline{background:#fff; color:var(--brand); border:1px solid var(--brand)}
    .btn.bad{background:var(--bad)}
    .btn.ghost{background:transparent; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{background:#fff; border:1px solid #e6e9ef; padding:8px 14px; border-radius:999px; cursor:pointer; color:#475569}
    .tab.active{background:var(--brand); color:#fff; border-color:var(--brand)}
    .panel{display:none}
    .panel.active{display:block}

    .login{
      max-width:600px; margin:32px auto; background:var(--card); border:1px solid #eef1f5;
      border-radius:var(--radius); padding:24px 22px; box-shadow:0 10px 30px rgba(2,6,23,.04);
    }
    .login h1{margin:0 0 12px}
    .muted{color:var(--muted); font-size:14px}
    label.txt{display:block; margin:14px 0}
    label.txt span{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="password"], input[type="search"], textarea, select{
      width:100%; border:1px solid #e6e9ef; border-radius:12px; padding:12px 14px; font:inherit; background:#fff;
    }
    input:focus, textarea:focus, select:focus{outline:none; box-shadow:var(--ring); border-color:#bee7ec}
    textarea{resize:vertical; min-height:84px}

    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:980px){ .grid-2{grid-template-columns:1.1fr 1fr} }

    .card{
      background:var(--card); border:1px solid #eef1f5; border-radius:var(--radius);
      padding:16px; box-shadow:0 10px 30px rgba(2,6,23,.04);
    }
    .card h3{margin:0 0 12px}
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px}
    .search{flex:1}
    .list{display:grid; gap:12px}
    .item{
      display:grid; gap:16px; grid-template-columns:72px 1fr auto; align-items:center;
      border:1px solid #eef1f5; border-radius:14px; padding:8px 10px; background:#fff;
    }
    .thumb{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#f2f4f7;border:1px solid #e6e9ef}
    .title{font-weight:600}
    .price{color:#0f172a; font-weight:700}
    .badgelight{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0;color:#334155;font-size:12px}
    .ok{color:var(--ok)}
    .danger{color:var(--bad)}

    .rowbtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted);}

    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;opacity:0;transition:.2s;pointer-events:none}
    .toast.on{opacity:1}

    .empty{padding:24px 12px; color:var(--muted)}
  </style>
</head>
<body>

  <!-- Fejléc -->
  <header>
    <div class="wrap row">
      <div class="brand"><img src="logo.png" alt=""> Szőke Épker – Admin</div>
      <div class="row" id="topRight">
        <button class="btn outline" id="backHome" onclick="location.href='/'">Vissza a weboldalra</button>
        <button class="btn bad" id="logoutBtn" style="display:none">Kijelentkezés</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Belépő kártya -->
    <section id="loginCard" class="login">
      <h1>Szőke Épker – Admin belépés</h1>
      <p class="muted">Add meg a belépési adatokat.</p>
      <div class="grid" style="gap:10px; margin-top:12px">
        <label class="txt"><span>Felhasználónév</span><input id="u" type="text" placeholder="pl. szokeadmin"></label>
        <label class="txt"><span>Jelszó</span><input id="p" type="password" placeholder="••••••••"></label>
        <div class="row" style="justify-content:flex-start; gap:12px">
          <button class="btn" id="loginBtn">Belépés</button>
          <span class="muted" id="loginHelp" style="display:none"></span>
        </div>
      </div>
    </section>

    <!-- Admin felület -->
    <section id="app" style="display:none">
      <div class="row" style="margin-bottom:14px">
        <h2 style="margin:0">Admin felület</h2>
        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="products">Termékek</button>
          <button class="tab" data-tab="orders">Rendelések</button>
          <button class="tab" data-tab="reviews">Vélemények</button>
        </div>
      </div>

      <!-- TERMÉKEK -->
      <div class="panel active" id="panel-products">
        <div class="grid grid-2">
          <!-- Új termék űrlap -->
          <div class="card">
            <h3>Új termék</h3>
            <div class="grid" style="gap:10px">
              <label class="txt"><span>Termék neve</span><input id="newTitle" type="text" placeholder="pl. Zsák"></label>
              <label class="txt"><span>Ár (Ft)</span><input id="newPrice" type="number" min="0" value="0"></label>
              <label class="txt">
                <span>Leírás (markdown megengedett)</span>
                <textarea id="newDesc" placeholder="pár sor leírás…"></textarea>
              </label>
              <label class="txt">
                <span>Kép (jpg/png)</span>
                <input id="newImg" type="file" accept="image/*">
                <div class="hint">A fájlt a Supabase Storage „products” bucketbe töltjük fel.</div>
              </label>
              <label class="txt"><span>Készleten</span>
                <select id="newInStock">
                  <option value="true" selected>Igen</option>
                  <option value="false">Nem</option>
                </select>
              </label>
              <div class="row" style="gap:10px">
                <button class="btn" id="addBtn">Hozzáadás</button>
                <span class="muted" id="addHint"></span>
              </div>
            </div>
          </div>

          <!-- Lista -->
          <div class="card">
            <div class="toolbar">
              <strong style="font-size:18px">Termékek</strong>
              <input class="search" id="prodSearch" type="search" placeholder="Keresés név szerint…">
            </div>
            <div id="productsList" class="list"></div>
            <div id="productsEmpty" class="empty" style="display:none">Nincs találat.</div>
          </div>
        </div>
      </div>

      <!-- RENDELÉSEK -->
      <div class="panel" id="panel-orders">
        <div class="card">
          <div class="toolbar">
            <strong style="font-size:18px">Rendelések</strong>
            <button class="btn outline" id="refreshOrders">Frissítés</button>
          </div>
          <div id="ordersList" class="list"></div>
          <div id="ordersEmpty" class="empty" style="display:none">Még nincs rendelés.</div>
        </div>
      </div>

      <!-- VÉLEMÉNYEK -->
      <div class="panel" id="panel-reviews">
        <div class="card">
          <div class="toolbar">
            <strong style="font-size:18px">Vélemények</strong>
            <button class="btn outline" id="refreshReviews">Frissítés</button>
          </div>
          <div id="reviewsList" class="list"></div>
          <div id="reviewsEmpty" class="empty" style="display:none">Még nincs vélemény.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
/* ====== CONFIG (a te Supabase-odra beállítva) ====== */
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const BUCKET = "products";

/* ====== HELYI LOGIN (gépre kötött) ====== */
const ADMIN_USER = "szokeadmin";
const ADMIN_PASS = "szoke2025";

/* ====== SUPABASE kliens ====== */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== Segédek ====== */
const $ = s => document.querySelector(s);
const fmt = (n)=> new Intl.NumberFormat("hu-HU").format(n)+" Ft";
const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("on"); setTimeout(()=>el.classList.remove("on"),1600); };

/* ====== Állapot és alap DOM ====== */
const loginCard = $("#loginCard");
const app = $("#app");
const logoutBtn = $("#logoutBtn");
const loginBtn = $("#loginBtn");

/* ====== Login logika ====== */
function showApp(on){
  if(on){ loginCard.style.display="none"; app.style.display="block"; logoutBtn.style.display="inline-flex"; }
  else  { loginCard.style.display="block"; app.style.display="none"; logoutBtn.style.display="none"; }
}
function isAuthed(){ return localStorage.getItem("admin_ok")==="1"; }
function doLogin(){
  const u=$("#u").value.trim(), p=$("#p").value;
  if(u===ADMIN_USER && p===ADMIN_PASS){
    localStorage.setItem("admin_ok","1");
    showApp(true);
    initProducts();
    initOrders();
    initReviews();
    toast("Sikeres belépés.");
  }else{
    $("#loginHelp").style.display="inline"; $("#loginHelp").textContent="Hibás felhasználónév vagy jelszó.";
  }
}
function doLogout(){ localStorage.removeItem("admin_ok"); showApp(false); }

/* ====== Tabok ====== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    $("#panel-"+id).classList.add("active");
  });
});

/* ====== TERMÉKEK ====== */
const productsList = $("#productsList");
const productsEmpty = $("#productsEmpty");
const prodSearch = $("#prodSearch");

let PRODUCTS = [];

async function fetchProducts(){
  const q = await sb.from("products")
    .select("id,title,price,description,instock,image_url,created_at")
    .order("created_at",{ascending:false});
  if(q.error){ console.error(q.error); toast("Hiba a termékek lekérésekor."); return []; }
  return q.data||[];
}
function renderProducts(){
  const q=(prodSearch.value||"").toLowerCase().trim();
  const list = PRODUCTS.filter(p=>!q || p.title?.toLowerCase().includes(q));
  productsList.innerHTML = list.map(p=>`
    <div class="item" data-id="${p.id}">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div>
        <div class="title">${p.title||'Névtelen termék'}</div>
        <div class="hint">${(p.description||'').slice(0,120)}</div>
        <div class="row" style="gap:12px;margin-top:6px">
          <span class="price">${fmt(p.price||0)}</span>
          <span class="badgelight">${p.instock ? 'készleten' : 'nem elérhető'}</span>
        </div>
      </div>
      <div class="rowbtns">
        <button class="btn outline" data-edit="${p.id}">Szerk</button>
        <button class="btn bad" data-del="${p.id}">Törlés</button>
      </div>
    </div>
  `).join("");
  productsEmpty.style.display = list.length ? "none" : "block";
}

async function initProducts(){
  PRODUCTS = await fetchProducts();
  renderProducts();
}

prodSearch.addEventListener("input", renderProducts);

productsList.addEventListener("click", async (e)=>{
  const id = e.target.dataset?.del || e.target.dataset?.edit;
  if(!id) return;

  if(e.target.dataset.del){
    if(!confirm("Biztos törlöd a terméket?")) return;
    const del = await sb.from("products").delete().eq("id", id);
    if(del.error){ alert("Hiba: "+del.error.message); return; }
    toast("Törölve.");
    PRODUCTS = PRODUCTS.filter(x=>x.id!==id);
    renderProducts();
  }

  if(e.target.dataset.edit){
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;
    const title = prompt("Terméknév:", p.title||"") ?? p.title;
    const price = parseInt(prompt("Ár (Ft):", p.price||0) ?? p.price,10);
    const instock = confirm("Készleten? (OK = igen, Mégse = nem)") ? true : false;
    const upd = await sb.from("products")
      .update({ title, price, instock })
      .eq("id", id)
      .select().single();
    if(upd.error){ alert("Hiba: "+upd.error.message); return; }
    toast("Mentve.");
    Object.assign(p, upd.data);
    renderProducts();
  }
});

/* Új termék hozzáadása + kép feltöltés */
$("#addBtn").addEventListener("click", async ()=>{
  const title = $("#newTitle").value.trim();
  const price = parseInt($("#newPrice").value||"0",10);
  const description = $("#newDesc").value.trim();
  const instock = $("#newInStock").value==="true";
  const file = $("#newImg").files[0];

  if(!title || isNaN(price)){ toast("Név és ár kötelező."); return; }

  $("#addBtn").disabled = true;
  $("#addHint").textContent = "Feltöltés…";

  let image_url = null, storage_path = null;

  try{
    if(file){
      const fileExt = file.name.split(".").pop();
      const path = `prod_${Date.now()}.${fileExt}`;
      const up = await sb.storage.from(BUCKET).upload(path, file, { upsert:false });
      if(up.error) throw up.error;
      storage_path = up.data.path;
      const pub = sb.storage.from(BUCKET).getPublicUrl(storage_path);
      image_url = pub?.data?.publicUrl || null;
    }

    const ins = await sb.from("products").insert({
      title, price, description, instock, image_url, storage_path
    }).select().single();

    if(ins.error) throw ins.error;

    toast("Hozzáadva.");
    PRODUCTS.unshift(ins.data);
    renderProducts();

    // ürítés
    $("#newTitle").value=""; $("#newPrice").value="0"; $("#newDesc").value=""; $("#newImg").value="";
    $("#newInStock").value="true";
  }catch(err){
    alert("Hiba: "+(err.message||err));
  }finally{
    $("#addBtn").disabled = false;
    $("#addHint").textContent = "";
  }
});

/* ====== RENDELÉSEK ====== */
const ordersList = $("#ordersList");
const ordersEmpty = $("#ordersEmpty");

async function initOrders(){ await loadOrders(); }
async function loadOrders(){
  const q = await sb.from("orders")
    .select("id,created_at,name,email,phone,address,shipping,note,subtotal,shipping_cost,total")
    .order("created_at",{ascending:false});
  if(q.error){ console.error(q.error); toast("Hiba a rendelések lekérésekor."); return; }
  const list = q.data||[];
  ordersList.innerHTML = list.map(o=>`
    <div class="item">
      <div class="badgelight">${new Date(o.created_at).toLocaleString('hu-HU')}</div>
      <div>
        <div class="title">${o.name} <span class="muted">• ${o.email} • ${o.phone}</span></div>
        <div class="hint">${o.address} — ${o.shipping || 'Szállítás'}</div>
        ${o.note ? `<div class="hint">Megjegyzés: ${o.note}</div>` : ``}
      </div>
      <div class="rowbtns">
        <strong class="price">${fmt(o.total||0)}</strong>
        <button class="btn bad" data-del-order="${o.id}">Törlés</button>
      </div>
    </div>
  `).join("");
  ordersEmpty.style.display = list.length ? "none" : "block";
}
$("#refreshOrders").addEventListener("click", loadOrders);
ordersList.addEventListener("click", async (e)=>{
  const id = e.target.dataset?.delOrder;
  if(!id) return;
  if(!confirm("Biztos törlöd a rendelést?")) return;
  const del = await sb.from("orders").delete().eq("id", id);
  if(del.error){ alert("Hiba: "+del.error.message); return; }
  toast("Rendelés törölve.");
  loadOrders();
});

/* ====== VÉLEMÉNYEK ====== */
const reviewsList = $("#reviewsList");
const reviewsEmpty = $("#reviewsEmpty");

async function initReviews(){ await loadReviews(); }
async function loadReviews(){
  const q = await sb.from("reviews")
    .select("id,created_at,username,text,product_id")
    .order("created_at",{ascending:false});
  if(q.error){ console.error(q.error); toast("Hiba a vélemények lekérésekor."); return; }
  const list = q.data||[];
  reviewsList.innerHTML = list.map(r=>`
    <div class="item">
      <div class="badgelight">${new Date(r.created_at).toLocaleString('hu-HU')}</div>
      <div>
        <div class="title">${r.username||'Névtelen'}</div>
        <div class="hint">${r.text}</div>
      </div>
      <div class="rowbtns">
        <button class="btn bad" data-del-review="${r.id}">Törlés</button>
      </div>
    </div>
  `).join("");
  reviewsEmpty.style.display = list.length ? "none" : "block";
}
$("#refreshReviews").addEventListener("click", loadReviews);
reviewsList.addEventListener("click", async (e)=>{
  const id = e.target.dataset?.delReview;
  if(!id) return;
  if(!confirm("Biztos törlöd a véleményt?")) return;
  const del = await sb.from("reviews").delete().eq("id", id);
  if(del.error){ alert("Hiba: "+del.error.message); return; }
  toast("Vélemény törölve.");
  loadReviews();
});

/* ====== Események ====== */
loginBtn.addEventListener("click", doLogin);
$("#p").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
logoutBtn.addEventListener("click", doLogout);

/* ====== Indítás ====== */
(function boot(){
  if(isAuthed()){
    showApp(true);
    initProducts(); initOrders(); initReviews();
  }else{
    showApp(false);
  }
})();
</script>
</body>
</html>
