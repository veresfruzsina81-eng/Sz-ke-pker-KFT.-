<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pénztár – Szőke-Épker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{--ink:#222;--muted:#7a8594;--bg:#f5f7fb;--card:#fff;--brand:#2f6fed;--brand-2:#245bcb;--ring:0 0 0 3px rgba(47,111,237,.18)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.row{display:flex;align-items:center;gap:12px}
.space{justify-content:space-between}
.btn{appearance:none;border:0;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff}
.btn:hover{background:var(--brand-2)}
.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.card{background:var(--card);border:1px solid #e5e9f2;border-radius:16px;box-shadow:0 14px 32px rgba(22,29,37,.06);padding:16px}
.grid{display:grid;gap:16px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.inp,textarea{width:100%;border:1px solid #e5e9f2;background:#fff;padding:11px 12px;border-radius:10px}
.inp:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
.item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid #e5e9f2;border-radius:12px;padding:8px 10px}
.item img{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid #e5e9f2}
.muted{color:var(--muted)}
.right{text-align:right}
.center{text-align:center}
.bigok{font-size:42px;line-height:1}

/* Előnézet (rendelés összegzés) modal */
.scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:1001;padding:16px}
.modal>div{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);width:min(700px,92vw);padding:16px}
.modal.open{display:grid}.scrim.open{display:block}
.modal h3{margin:0 0 10px}
.summary-row{display:flex;justify-content:space-between;margin:6px 0}
.summary-row.total{border-top:1px solid #e5e9f2;padding-top:8px;font-weight:700}
.table{width:100%;border-collapse:collapse;margin-top:6px}
.table th,.table td{padding:8px;border-bottom:1px solid #eef2f8;text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#245bcb;font-weight:700;font-size:12px}

/* Kupon doboz sor: ne lógjon ki a gomb */
#couponBox .line{display:flex;gap:8px;align-items:center}
#couponInput{flex:1;min-width:0} /* engedje összemenni, ne tolja ki a gombot */
#couponApply{flex:0 0 auto;white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="row space" style="margin-bottom:10px">
    <a class="btn ghost" href="webshop.html">← Vissza a webshopba</a>
    <a class="btn ghost" href="/">Vissza a weboldalra</a>
  </div>

  <div id="checkout" class="grid">
    <div class="card">
      <h2 style="margin:0 0 10px">Számlázási és szállítási adatok</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <input id="name" class="inp" placeholder="Név *">
        <input id="email" class="inp" placeholder="E-mail *">
        <input id="phone" class="inp" placeholder="Telefon *">
        <input id="shipping" class="inp" placeholder="Szállítás módja (pl. futár / személyes)">
        <input id="address" class="inp" placeholder="Szállítási cím *" style="grid-column:1/-1">
        <textarea id="note" rows="4" placeholder="Megjegyzés (opcionális)" style="grid-column:1/-1"></textarea>
      </div>
      <button id="placeBtn" class="btn" style="margin-top:10px">Rendelés leadása</button>
    </div>

    <aside class="card">
      <h2 style="margin:0 0 10px">Rendelés összegzés</h2>
      <div id="items"></div>
      <div class="row space" style="margin-top:8px"><span>Részösszeg</span><strong id="sub">0 Ft</strong></div>
      <div class="row space"><span>Szállítás</span><strong id="ship">0 Ft</strong></div>
      <!-- Kupon kedvezmény sor -->
      <div class="row space" id="discountRow" style="display:none">
        <span>Kedvezmény</span><strong id="discountValue">-0 Ft</strong>
      </div>
      <div class="row space" style="margin-top:6px;border-top:1px solid #e5e9f2;padding-top:8px"><span>Végösszeg</span><strong id="tot">0 Ft</strong></div>

      <!-- Kupon mező -->
      <div id="couponBox" style="margin-top:14px;padding:12px;background:#fff;border:1px solid #e5e9f2;border-radius:12px">
        <label for="couponInput" style="display:block;font-weight:700;margin-bottom:6px">Kuponkód</label>
        <div class="line">
          <input id="couponInput" type="text" placeholder="Pl. SAVE5-ABCD" style="padding:10px 12px;border:1px solid #e5e9f2;border-radius:10px">
          <button id="couponApply" class="btn" type="button">Kupon alkalmazása</button>
        </div>
        <div id="couponMsg" class="muted" style="margin-top:6px;min-height:18px"></div>
      </div>
    </aside>
  </div>

  <!-- Siker nézet -->
  <div id="thanks" class="card center" style="display:none">
    <div class="bigok">✔</div>
    <h2>Köszönjük a rendelést!</h2>
    <p class="muted">Hamarosan felvesszük Önnel a kapcsolatot e-mailben/telefonon.</p>

    <!-- Rendelés befejezése – részletes összegzés -->
    <div id="finalSummary" style="text-align:left;max-width:800px;margin:14px auto 0">
      <h3 style="margin:0 0 8px">Rendelés összefoglaló</h3>
      <div id="finalBuyer" class="muted" style="margin-bottom:8px"></div>
      <table class="table" id="finalItems">
        <thead>
          <tr><th>Termék</th><th>Mennyiség</th><th>Egységár</th><th>Összeg</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="summary-row"><span>Részösszeg</span><strong id="fSub">0 Ft</strong></div>
      <div class="summary-row"><span>Szállítás</span><strong id="fShip">0 Ft</strong></div>
      <div class="summary-row" id="fDiscRow" style="display:none"><span>Kedvezmény <span id="fDiscCode" class="badge"></span></span><strong id="fDisc">-0 Ft</strong></div>
      <div class="summary-row total"><span>Végösszeg</span><strong id="fTot">0 Ft</strong></div>
    </div>

    <div class="row center" style="justify-content:center;margin-top:12px">
      <a class="btn" href="webshop.html">Vissza a webshopba</a>
      <a class="btn ghost" href="/">Vissza a weboldalra</a>
    </div>
  </div>
</div>

<!-- Előnézet modal -->
<div id="reviewScrim" class="scrim"></div>
<div id="reviewModal" class="modal">
  <div>
    <h3>Rendelés összegzés</h3>
    <div id="reviewBuyer" class="muted" style="margin-bottom:8px"></div>
    <table class="table" id="reviewItems">
      <thead>
        <tr><th>Termék</th><th>Mennyiség</th><th>Egységár</th><th>Összeg</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="summary-row"><span>Részösszeg</span><strong id="rSub">0 Ft</strong></div>
    <div class="summary-row"><span>Szállítás</span><strong id="rShip">0 Ft</strong></div>
    <div class="summary-row" id="rDiscRow" style="display:none"><span>Kedvezmény <span id="rDiscCode" class="badge"></span></span><strong id="rDisc">-0 Ft</strong></div>
    <div class="summary-row total"><span>Végösszeg</span><strong id="rTot">0 Ft</strong></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="revBack" class="btn ghost" type="button">Vissza</button>
      <button id="revConfirm" class="btn" type="button">Megerősítem</button>
    </div>
  </div>
</div>

<script>
const SB_URL="https://gckynywmoxylwyppmkck.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const sb=supabase.createClient(SB_URL,SB_KEY);
const HUF=n=>new Intl.NumberFormat('hu-HU').format(n||0)+" Ft";
let CART=JSON.parse(localStorage.getItem("cart")||"[]");

/* ===== Kupon modul ===== */
const COUPON_UI = {
  subtotalEl: '#sub', shippingEl: '#ship',
  discountRow: '#discountRow', discountEl: '#discountValue',
  totalEl: '#tot', inputEl: '#couponInput',
  applyBtn: '#couponApply', msgEl: '#couponMsg'
};
function q(sel){ return document.querySelector(sel); }
function setMsg(text, ok=false){ const el=q(COUPON_UI.msgEl); if(!el) return; el.textContent=text||''; el.style.color= ok?'#16a34a':'#dc2626'; }
function ensureRemoveLink(){
  const msg=q(COUPON_UI.msgEl); if(!msg||msg.querySelector('a')) return;
  const a=document.createElement('a'); a.href='#'; a.textContent='Eltávolítás'; a.style.marginLeft='8px';
  a.addEventListener('click', e=>{e.preventDefault(); localStorage.removeItem('appliedCoupon'); setMsg('Kupon eltávolítva.', true); unlockApplyButton(); recalcTotals();});
  msg.appendChild(a);
}
function lockApplyButton(){ const b=q(COUPON_UI.applyBtn); if(!b) return; b.setAttribute('disabled','true'); b.style.opacity='.7'; b.style.cursor='not-allowed'; b.textContent='Kupon alkalmazva'; }
function unlockApplyButton(){ const b=q(COUPON_UI.applyBtn); if(!b) return; b.removeAttribute('disabled'); b.style.opacity=''; b.style.cursor=''; b.textContent='Kupon alkalmazása'; }
function parseCoupon(code){ if(!code) return null; const m=String(code).trim().toUpperCase().match(/^SAVE(0|3|5|7)-([A-Z0-9]{4})$/); if(!m) return null; const percent=Number(m[1]); if(percent<=0) return null; return { code:m[0], percent }; }
function getAppliedCoupon(){ try{ return JSON.parse(localStorage.getItem('appliedCoupon')); }catch(_){ return null; } }
function saveAppliedCoupon(c){ localStorage.setItem('appliedCoupon', JSON.stringify(c)); }
/* ===== /Kupon modul ===== */

function renderSummary(){
  const box=document.getElementById('items');
  if(!CART.length){ box.innerHTML="<p class='muted'>A kosár üres.</p>"; recalcTotals(); return; }
  box.innerHTML=CART.map(it=>`
    <div class="item">
      <img src="${it.image_url||'logo.png'}" alt="">
      <div>
        <div><strong>${it.title}</strong></div>
        <div class="muted">${HUF(it.price)} • Mennyiség: ${it.qty}</div>
      </div>
      <div class="right"><strong>${HUF(it.price*it.qty)}</strong></div>
    </div>`).join('');
  recalcTotals();
}
function calcSubtotal(){ return CART.reduce((s,x)=>s + x.price * x.qty, 0); }

/* === Szállítás: 30 000 alatt 1 500 Ft (küszöb a RÉSZÖSSZEG alapján) === */
const FREE_THRESHOLD = 30000;
const SHIPPING_FEE  = 1500;
function computeShipping(subtotal){ if(subtotal<=0) return 0; return subtotal>=FREE_THRESHOLD ? 0 : SHIPPING_FEE; }

function recalcTotals(){
  const subtotal = calcSubtotal();
  const shippingBase = computeShipping(subtotal); // küszöböt kupon NÉLKÜL döntjük el
  const applied = getAppliedCoupon();

  let discount = 0;
  if(applied && applied.percent){
    discount = Math.round(subtotal * applied.percent / 100);
    q(COUPON_UI.discountRow).style.display='';
    q(COUPON_UI.discountEl).textContent='-' + HUF(discount).replace('-','');
  }else{
    q(COUPON_UI.discountRow).style.display='none';
    q(COUPON_UI.discountEl).textContent='-0 Ft';
  }

  const total = Math.max(0, subtotal - discount + shippingBase);

  q(COUPON_UI.subtotalEl).textContent=HUF(subtotal);
  q(COUPON_UI.shippingEl).textContent=HUF(shippingBase);
  q(COUPON_UI.totalEl).textContent=HUF(total);

  return { subtotal, shipping: shippingBase, discount, total, coupon: applied||null };
}

renderSummary();

// Kupon események + auto-prefill a szerencsekerékből
(function initCouponBox(){
  const input=q(COUPON_UI.inputEl), btn=q(COUPON_UI.applyBtn);
  let applied=getAppliedCoupon();
  if(applied){
    if(input) input.value=applied.code;
    setMsg(`Kupon alkalmazva: ${applied.code} (−${applied.percent}%)`, true);
    lockApplyButton(); ensureRemoveLink(); recalcTotals();
  } else {
    const wheelCode=sessionStorage.getItem('couponCode');
    const wheelPct=Number(sessionStorage.getItem('couponPercent')||'0');
    if(wheelCode && wheelPct>0){
      const parsed=parseCoupon(wheelCode) || {code:wheelCode, percent:wheelPct};
      saveAppliedCoupon(parsed);
      if(input) input.value=parsed.code;
      setMsg(`Kupon alkalmazva: ${parsed.code} (−${parsed.percent}%)`, true);
      lockApplyButton(); ensureRemoveLink(); recalcTotals();
    }
  }
  if(btn){
    btn.addEventListener('click', ()=>{
      const code=(input?.value||'').trim(); const parsed=parseCoupon(code);
      if(!parsed){ setMsg('Érvénytelen kuponkód. Használható: SAVE3-XXXX, SAVE5-XXXX, SAVE7-XXXX.'); return; }
      saveAppliedCoupon(parsed);
      setMsg(`Kupon alkalmazva: ${parsed.code} (−${parsed.percent}%)`, true);
      lockApplyButton(); ensureRemoveLink(); recalcTotals();
    });
  }
})();

/* ====== Rendelés LEADÁSA – előnézet → megerősítés → mentés ====== */
const placeBtn=document.getElementById('placeBtn');
const reviewModal=document.getElementById('reviewModal');
const reviewScrim=document.getElementById('reviewScrim');
const revBack=document.getElementById('revBack');
const revConfirm=document.getElementById('revConfirm');

placeBtn.addEventListener('click', ()=>{
  const name=document.getElementById('name').value.trim();
  const email=document.getElementById('email').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  if(!CART.length){ alert("A kosár üres."); return; }
  if(!name||!email||!phone||!address){ alert("Kérjük, töltsd ki: Név, E-mail, Telefon, Cím."); return; }
  fillPreview(); openReview();
});
revBack.addEventListener('click', closeReview);
reviewScrim.addEventListener('click', closeReview);
revConfirm.addEventListener('click', placeOrder);

function openReview(){ reviewScrim.classList.add('open'); reviewModal.classList.add('open'); }
function closeReview(){ reviewScrim.classList.remove('open'); reviewModal.classList.remove('open'); }

function fillTableBody(tbodyEl){
  if(!tbodyEl) return;
  tbodyEl.innerHTML=CART.map(it=>`
    <tr>
      <td>${escapeHtml(it.title)}</td>
      <td>${it.qty}</td>
      <td>${HUF(it.price)}</td>
      <td>${HUF(it.price*it.qty)}</td>
    </tr>`).join('');
}

function fillPreview(){
  const buyer = `
    ${escapeHtml(document.getElementById('name').value||'')} •
    ${escapeHtml(document.getElementById('email').value||'')} •
    ${escapeHtml(document.getElementById('phone').value||'')}<br>
    Cím: ${escapeHtml(document.getElementById('address').value||'')} |
    Szállítás módja: ${escapeHtml(document.getElementById('shipping').value||'Ismeretlen')}
  `;
  document.getElementById('reviewBuyer').innerHTML=buyer;
  fillTableBody(document.querySelector('#reviewItems tbody'));
  const t=recalcTotals();
  document.getElementById('rSub').textContent=HUF(t.subtotal);
  document.getElementById('rShip').textContent=HUF(t.shipping);
  document.getElementById('rTot').textContent=HUF(t.total);
  const rDiscRow=document.getElementById('rDiscRow');
  if(t.discount>0 && t.coupon){
    rDiscRow.style.display='';
    document.getElementById('rDisc').textContent='-' + HUF(t.discount).replace('-','');
    document.getElementById('rDiscCode').textContent=t.coupon.code;
  } else rDiscRow.style.display='none';
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* === Mentés Supabase-be – oszlophiány esetén automatikus visszaesés === */
async function placeOrder(){
  closeReview();

  const name=document.getElementById('name').value.trim();
  const email=document.getElementById('email').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const shippingMethod=document.getElementById('shipping').value.trim()||'Ismeretlen';
  const noteRaw=document.getElementById('note').value.trim();

  if(!CART.length){ alert("A kosár üres."); return; }
  if(!name||!email||!phone||!address){ alert("Kérjük, töltsd ki: Név, E-mail, Telefon, Cím."); return; }

  const t=recalcTotals(); // subtotal, shipping, discount, total, coupon

  // Alap payload a kupon mezőkkel
  const payloadBase={
    name,email,phone,address,shipping:shippingMethod,
    note:noteRaw,
    items:CART,
    subtotal:t.subtotal,
    shipping_cost:t.shipping,
    discount:t.discount,
    total:t.total,
    coupon_code: t.coupon?.code ?? null,
    coupon_percent: t.coupon?.percent ?? null
  };

  // 1. kísérlet: teljes payload
  let { error } = await sb.from('orders').insert(payloadBase);

  // Ha nincs 'coupon_code' / 'coupon_percent' oszlop → próbáljuk újra ezek nélkül
  if(error && /coupon_(code|percent)/i.test(error.message||"")){
    const fallback={...payloadBase};
    delete fallback.coupon_code; delete fallback.coupon_percent;
    // kupon infó bekerül a megjegyzés végére, hogy ne vesszen el
    if(t.coupon){
      const addon = ` [Kupon: ${t.coupon.code} (−${t.coupon.percent}%)]`;
      fallback.note = (fallback.note||"") + addon;
    }
    const retry = await sb.from('orders').insert(fallback);
    error = retry.error;
  }

  if(error){ alert("Hiba a mentéskor: "+error.message); return; }

  // siker – végső összegzés + köszönő oldal
  fillFinalSummary(t, {name,email,phone,address,shippingMethod});
  CART=[]; localStorage.setItem("cart","[]");
  document.getElementById('checkout').style.display="none";
  document.getElementById('thanks').style.display="block";
}

function fillFinalSummary(totals, buyer){
  document.getElementById('finalBuyer').innerHTML =
    `${escapeHtml(buyer.name)} • ${escapeHtml(buyer.email)} • ${escapeHtml(buyer.phone)}<br>` +
    `Cím: ${escapeHtml(buyer.address)} | Szállítás módja: ${escapeHtml(buyer.shippingMethod)}`;
  fillTableBody(document.querySelector('#finalItems tbody'));
  document.getElementById('fSub').textContent=HUF(totals.subtotal);
  document.getElementById('fShip').textContent=HUF(totals.shipping);
  document.getElementById('fTot').textContent=HUF(totals.total);
  if(totals.discount>0 && totals.coupon){
    document.getElementById('fDiscRow').style.display='';
    document.getElementById('fDisc').textContent='-' + HUF(totals.discount).replace('-','');
    document.getElementById('fDiscCode').textContent=totals.coupon.code;
  } else document.getElementById('fDiscRow').style.display='none';
}
</script>
</body>
</html>
