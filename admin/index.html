<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Szőke Épker – Admin</title>
<link rel="icon" href="/logo.png">
<style>
  :root{--bg:#f7f7f9;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--ok:#16a34a;--danger:#dc2626;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  header{display:flex;gap:12px;align-items:center;margin:10px 0 24px}
  header img{height:40px}
  header h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:20px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1.2fr 1fr}
  label span{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,textarea,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff}
  textarea{min-height:120px;resize:vertical}
  .btn{background:#e5e7eb;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.outline{background:transparent;border:1px solid #e5e7eb}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0369a1;font-size:12px}
  .muted{color:var(--muted)}
  /* Login sheet */
  .sheet{position:fixed;inset:0;background:linear-gradient(180deg,#fdfefe, #eaf3ff);display:grid;place-items:center}
  .login{width:100%;max-width:420px}
  .login header{justify-content:center}
  .login .card{padding:28px}
  .hint{font-size:12px;color:var(--muted)}
  /* hide while logged out */
  .app[hidden]{display:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .imgthumb{width:56px;height:56px;object-fit:cover;border-radius:8px;background:#f2f2f2}
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tabs button{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .tabs .on{background:var(--brand);color:#fff;border-color:var(--brand)}
  .right{margin-left:auto}
  .notice{padding:10px 12px;border-radius:10px;background:#ecfeff;border:1px solid #b6effb}
</style>
</head>
<body>
<div class="sheet" id="loginSheet">
  <div class="login">
    <header><img src="/logo.png" alt="" /><h1>Szőke Épker – Admin felület</h1></header>
    <div class="card grid" style="gap:12px">
      <div>
        <label><span>Felhasználónév</span><input id="lu" autocomplete="off" placeholder="Felhasználónév"></label>
      </div>
      <div>
        <label><span>Jelszó</span><input id="lp" type="password" placeholder="Jelszó"></label>
      </div>
      <button class="btn primary" id="loginBtn">Belépés</button>
      <div class="hint">Ha ez a gép a megrendelőé, hagyd bejelentkezve. Más nem fog belépni ezzel a felülettel.</div>
    </div>
  </div>
</div>

<div class="app" id="app" hidden>
  <div class="wrap">
    <header>
      <img src="/logo.png" alt="">
      <h1>Termékek & rendeléskezelés</h1>
      <span class="right muted">Bejelentkezve · <a href="#" id="logout">Kijelentkezés</a></span>
    </header>

    <div class="tabs">
      <button class="on" data-tab="productsTab">Termékek</button>
      <button data-tab="ordersTab">Rendelések</button>
      <button data-tab="reviewsTab">Vélemények</button>
    </div>

    <!-- TERMÉKEK -->
    <section id="productsTab">
      <div class="grid cols-2">
        <div class="card">
          <h3>Új / szerkesztett termék</h3>
          <div class="grid">
            <input type="hidden" id="prod_id">
            <label><span>Termék neve</span><input id="prod_title" required></label>
            <label><span>Ár (Ft)</span><input id="prod_price" type="number" min="0" step="1" required></label>
            <label><span>Leírás (markdown megengedett)</span><textarea id="prod_desc"></textarea></label>
            <label class="row"><input type="checkbox" id="prod_instock" checked> <span>Készleten</span></label>
            <div class="row">
              <input type="file" id="prod_img" accept="image/png,image/jpeg" />
              <button class="btn outline" id="clearImg">Kép törlése mezőből</button>
            </div>
            <button class="btn primary" id="saveProduct">Mentés</button>
            <div class="notice" id="saveMsg" hidden></div>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <strong>Legutóbbi 50 termék</strong>
            <button class="btn" id="reloadProducts">Lista frissítése</button>
          </div>
          <table class="table" id="prodTable">
            <thead><tr><th></th><th>Név</th><th>Ár</th><th>Állapot</th><th class="right">Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RENDELÉSEK -->
    <section id="ordersTab" hidden>
      <div class="card">
        <div class="toolbar"><strong>Beérkezett rendelések</strong><button class="btn" id="reloadOrders">Frissítés</button></div>
        <table class="table" id="ordersTable">
          <thead><tr><th>Dátum</th><th>Név</th><th>Email</th><th>Összeg</th><th>Szállítás</th><th>Megjegyzés</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- VÉLEMÉNYEK -->
    <section id="reviewsTab" hidden>
      <div class="card">
        <div class="toolbar"><strong>Vélemények</strong><button class="btn" id="reloadReviews">Frissítés</button></div>
        <table class="table" id="revTable">
          <thead><tr><th>Termék</th><th>Név</th><th>Ért.</th><th>Szöveg</th><th class="right">Törlés</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script type="module">
  // ==== FIX LOGIN (helyi, nem Supabase Auth) ====
  const ADMIN_USER = "szokeadmin";
  const ADMIN_PASS = "szoke2025";
  const TOKEN_KEY = "sz_admin_token_v1";

  const loginSheet = document.getElementById("loginSheet");
  const appEl = document.getElementById("app");

  function loggedIn(){ return sessionStorage.getItem(TOKEN_KEY) === "ok"; }
  function showApp(on){ appEl.hidden = !on; loginSheet.style.display = on ? "none":"grid"; }
  function tryAuto(){ showApp(loggedIn()); }
  tryAuto();

  document.getElementById("loginBtn").onclick = ()=>{
    const u = (document.getElementById("lu").value||"").trim();
    const p = document.getElementById("lp").value;
    if(u===ADMIN_USER && p===ADMIN_PASS){ sessionStorage.setItem(TOKEN_KEY,"ok"); showApp(true); bootstrap(); }
    else alert("Hibás jelszó vagy inaktív fiók.");
  };
  document.getElementById("logout").onclick = (e)=>{ e.preventDefault(); sessionStorage.removeItem(TOKEN_KEY); location.reload(); };

  // ==== SUPABASE KLIENS ====
  const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // ==== TABOK ====
  document.querySelectorAll(".tabs button").forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("on"));
      btn.classList.add("on");
      document.querySelectorAll("section").forEach(s=>s.hidden=true);
      document.getElementById(btn.dataset.tab).hidden=false;
    };
  });

  // ==== TERMÉKEK CRUD ====
  const prodTBody = document.querySelector("#prodTable tbody");
  const saveMsg = document.getElementById("saveMsg");

  async function loadProducts(){
    const { data, error } = await supabase.from("products").select("*").order("id", {ascending:false}).limit(50);
    prodTBody.innerHTML = (data||[]).map(p=>`
      <tr>
        <td>${p.image_url?`<img class="imgthumb" src="${p.image_url}">`:``}</td>
        <td>${p.title||""}</td>
        <td>${(p.price||0).toLocaleString("hu-HU")} Ft</td>
        <td>${p.instock?'<span class="pill">készleten</span>':'<span class="pill" style="background:#fee2e2;color:#991b1b">nem elérhető</span>'}</td>
        <td class="right">
          <button class="btn outline" data-edit="${p.id}">Szerk.</button>
          <button class="btn danger" data-del="${p.id}" style="margin-left:6px">Törlés</button>
        </td>
      </tr>
    `).join("");
  }

  async function upsertProduct(evt){
    evt?.preventDefault();
    const id = document.getElementById("prod_id").value || null;
    const title = document.getElementById("prod_title").value.trim();
    const price = parseInt(document.getElementById("prod_price").value||"0",10);
    const description = document.getElementById("prod_desc").value || "";
    const instock = document.getElementById("prod_instock").checked;
    if(!title || !price){ alert("Név és ár kötelező!"); return; }

    let image_url = null;

    // fájlfeltöltés – ha engedi a bucket policy, különben hanyagolja
    const file = document.getElementById("prod_img").files?.[0];
    if(file){
      const path = `p_${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const up = await supabase.storage.from("products").upload(path, file, {upsert:false});
      if(!up.error){
        const pub = supabase.storage.from("products").getPublicUrl(path);
        image_url = pub.data.publicUrl;
      }else{
        console.warn("Upload error:", up.error.message);
        alert("A képfeltöltés nem engedélyezett. A termék mentésre kerül kép nélkül. (Később beállítható a bucket INSERT jog.)");
      }
    }

    const payload = { title, price, description, instock };
    if(image_url) payload.image_url = image_url;

    const { error } = id
      ? await supabase.from("products").update(payload).eq("id", id)
      : await supabase.from("products").insert(payload);

    if(error){ alert("Hiba: "+error.message); return; }

    saveMsg.textContent = "Mentve.";
    saveMsg.hidden = false; setTimeout(()=> saveMsg.hidden = true, 2000);
    // űrlap ürítése
    document.getElementById("prod_id").value="";
    document.getElementById("prod_title").value="";
    document.getElementById("prod_price").value="";
    document.getElementById("prod_desc").value="";
    document.getElementById("prod_instock").checked=true;
    document.getElementById("prod_img").value="";
    loadProducts();
  }

  document.getElementById("saveProduct").onclick = upsertProduct;
  document.getElementById("reloadProducts").onclick = loadProducts;
  document.getElementById("clearImg").onclick = ()=> document.getElementById("prod_img").value="";

  prodTBody.addEventListener("click", async (e)=>{
    const id = e.target.dataset.edit || e.target.dataset.del;
    if(!id) return;

    if(e.target.dataset.edit){
      const { data } = await supabase.from("products").select("*").eq("id", id).single();
      if(!data) return;
      document.getElementById("prod_id").value = data.id;
      document.getElementById("prod_title").value = data.title||"";
      document.getElementById("prod_price").value = data.price||"";
      document.getElementById("prod_desc").value = data.description||"";
      document.getElementById("prod_instock").checked = !!data.instock;
      window.scrollTo({top:0,behavior:"smooth"});
    }
    if(e.target.dataset.del){
      if(!confirm("Biztosan törlöd a terméket?")) return;
      const { error } = await supabase.from("products").delete().eq("id", id);
      if(error){ alert(error.message); return; }
      loadProducts();
    }
  });

  // ==== RENDELÉSEK LISTA ====
  async function loadOrders(){
    const { data } = await supabase.from("orders").select("*").order("created_at",{ascending:false}).limit(100);
    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = (data||[]).map(o=>`
      <tr>
        <td>${new Date(o.created_at).toLocaleString("hu-HU")}</td>
        <td>${o.name}</td><td>${o.email}</td>
        <td>${(o.total||0).toLocaleString("hu-HU")} Ft</td>
        <td>${o.shipping}</td><td class="muted">${o.note||""}</td>
      </tr>
    `).join("");
  }
  document.getElementById("reloadOrders").onclick = loadOrders;

  // ==== VÉLEMÉNYEK MODERÁLÁS ====
  async function loadReviews(){
    const { data } = await supabase.from("reviews").select("id,product_id,name,rating,text,products(title)").order("id",{ascending:false}).limit(200);
    const tbody = document.querySelector("#revTable tbody");
    tbody.innerHTML = (data||[]).map(r=>`
      <tr>
        <td>${r.products?.title||('#'+r.product_id)}</td>
        <td>${r.name}</td>
        <td>${'★'.repeat(r.rating||0)}</td>
        <td>${r.text}</td>
        <td class="right"><button class="btn danger" data-rdel="${r.id}">Törlés</button></td>
      </tr>
    `).join("");
  }
  document.getElementById("reloadReviews").onclick = loadReviews;
  document.querySelector("#revTable").addEventListener("click", async e=>{
    const id = e.target.dataset.rdel; if(!id) return;
    if(!confirm("Biztosan törlöd a véleményt?")) return;
    await supabase.from("reviews").delete().eq("id", id);
    loadReviews();
  });

  // ==== INIT ====
  function bootstrap(){
    if(!loggedIn()) return;
    loadProducts(); loadOrders(); loadReviews();
    // tab shortcut
    document.querySelectorAll(".tabs button")[0].click();
  }
  if(loggedIn()) bootstrap();

</script>
</body>
</html>
