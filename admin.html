<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Szőke Épker – Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --ink:#222; --muted:#7a8594; --bg:#f5f7fb; --card:#fff;
  --brand:#2f6fed; --brand-2:#245bcb; --ring:0 0 0 3px rgba(47,111,237,.18);
  --radius:16px; --bad:#e23d3d; --ok:#1f8f5f;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.wrap{max-width:1200px;margin:0 auto;padding:18px 14px}
.card{background:var(--card);border:1px solid #e5e9f2;border-radius:var(--radius);padding:16px;box-shadow:0 18px 40px rgba(22,29,37,.05)}
h1{margin:0 0 8px} h2{margin:0 0 10px}
input,textarea,select{width:100%;border:1px solid #e5e9f2;background:#fff;padding:12px 14px;border-radius:12px;font:inherit}
input:focus,textarea:focus,select:focus{outline:none;box-shadow:var(--ring);border-color:#d6def7}
.btn{appearance:none;border:0;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff;transition:.18s}
.btn:hover{background:var(--brand-2)}
.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.btn.bad{background:var(--bad)}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tabs{display:flex;gap:10px;margin:14px 0 18px}
.tab{padding:9px 14px;border-radius:999px;border:1px solid #e5e9f2;background:#fff;cursor:pointer;font-weight:600}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr}
@media(min-width:900px){.grid-2{grid-template-columns:380px 1fr}}

/* Termék kártya */
.item{
  display:grid;grid-template-columns:96px 1fr auto;gap:12px;align-items:center;
  border:1px solid #e5e9f2;border-radius:12px;padding:12px;background:#fff
}
.item + .item{margin-top:10px}
.thumb{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #e5e9f2;background:#fff}
.muted{color:var(--muted)}
.login{max-width:520px;margin:40px auto}
.hidden{display:none}

/* panelek: fix magasság + belső görgetés */
.panel{max-height:72vh;overflow:auto;border-radius:14px}
#plist,#olist,#rlist{padding-right:4px;margin-top:8px}
#olist .card + .card{margin-top:10px}

/* akciógombsor: feszes, nem csúszik szét */
.actions{display:flex;gap:8px;flex-wrap:nowrap}
.actions .btn{min-width:112px}
@media(max-width:640px){.actions{flex-wrap:wrap}}

/* ragadós panelek fejléce */
#tab-products .card h2,#tab-orders .card h2,#tab-reviews .card h2{
  position:sticky;top:0;z-index:2;background:var(--card);
  margin:-16px -16px 10px;padding:12px 16px;border-bottom:1px solid #e5e9f2;
  border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)
}

/* keresők */
.search{display:flex;gap:8px;align-items:center}
.input{border:1px solid #e5e9f2;background:#fff;border-radius:10px;padding:10px 12px}

/* MODAL – termék szerkesztő */
.scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:1001;padding:16px}
.modal>div{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);width:min(720px,92vw);padding:16px}
.modal.open{display:grid}.scrim.open{display:block}

/* badge-ek */
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#245bcb;font-weight:700;font-size:12px}
.badge.gray{background:#eef2f6;color:#4b5563}
.badge.green{background:#e6faef;color:#116b3b}
.badge.yellow{background:#fff7e6;color:#9a5b00}
.badge.red{background:#ffe9eb;color:#962437}

/* Toast */
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:9px 14px;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s;z-index:1202}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <!-- Login -->
  <div id="loginBox" class="card login">
    <div class="row" style="gap:10px;align-items:center;margin-bottom:6px">
      <img src="logo.png" alt="" style="height:28px"><h1 style="margin:0">Szőke Épker – Admin belépés</h1>
    </div>
    <div class="grid" style="gap:10px">
      <label>Felhasználónév<input id="u" placeholder="Felhasználónév"></label>
      <label>Jelszó<input id="p" type="password" placeholder="Jelszó"></label>
      <button id="loginBtn" type="button" class="btn">Belépés</button>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row" style="gap:8px;align-items:center">
        <img src="logo.png" alt="" style="height:28px">
        <h1 style="margin:0">Szőke Épker Adminisztráció</h1>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" onclick="location.href='/webshop.html'">Webshop megnyitása</button>
        <button class="btn" id="logoutBtn" type="button">Kijelentkezés</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="products" type="button">Termékek</button>
      <button class="tab" data-tab="orders" type="button">Rendelések</button>
      <button class="tab" data-tab="reviews" type="button">Vélemények</button>
    </div>

    <div id="tab-products">
      <div class="grid grid-2">
        <div class="card panel">
          <h2>Új termék</h2>
          <div class="grid" style="gap:10px">
            <input id="title" placeholder="Termék neve">
            <input id="price" type="number" placeholder="Ár (Ft)">
            <textarea id="desc" placeholder="Rövid leírás (markdown megengedett)"></textarea>
            <label class="muted">Kép (jpg/png)</label>
            <input id="file" type="file" accept="image/*">
            <label class="row" style="gap:8px"><input id="instock" type="checkbox" checked> Készleten</label>
            <button class="btn" id="addBtn" type="button">Hozzáadás</button>
            <div id="pInfo" class="muted"></div>
          </div>
        </div>

        <div class="card panel">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2 style="margin:0">Termékek</h2>
            <div class="search">
              <input id="psearch" class="input" placeholder="Keresés termékek közt…">
            </div>
          </div>
          <div id="plist"></div>
          <div id="pempty" class="muted">Nincs találat.</div>
        </div>
      </div>
    </div>

    <div id="tab-orders" class="hidden">
      <div class="card panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Rendelések</h2>
          <div class="row">
            <button class="btn ghost" id="exportPdfBtn" type="button">Számlaszerű (PDF)</button>
            <button class="btn ghost" id="exportBtn" type="button">CSV export</button>
            <button class="btn" id="refreshOrders" type="button">Frissítés</button>
          </div>
        </div>
        <div id="olist"></div>
        <div id="oempty" class="muted">Még nincs rendelés.</div>
      </div>
    </div>

    <div id="tab-reviews" class="hidden">
      <div class="card panel">
        <h2>Vélemények</h2>
        <div id="rlist"></div>
        <div id="rempty" class="muted">Még nincs vélemény.</div>
      </div>
    </div>
  </div>
</div>

<!-- Termék szerkesztő modal -->
<div id="editScrim" class="scrim"></div>
<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div>
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="editTitle" style="margin:0">Termék módosítása</h3>
      <button class="btn ghost" type="button" onclick="closeEdit()">Mégse</button>
    </div>
    <div class="grid" style="gap:10px">
      <label>Termék neve<input id="e_title" placeholder="Termék neve"></label>
      <label>Ár (Ft)<input id="e_price" type="number" placeholder="Ár (Ft)"></label>
      <label>Leírás<textarea id="e_desc" placeholder="Leírás"></textarea></label>
      <div class="row" style="gap:8px">
        <label class="row" style="gap:8px"><input id="e_instock" type="checkbox"> Készleten</label>
        <span class="muted">Kép cseréje (opcionális):</span>
        <input id="e_file" type="file" accept="image/*">
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" type="button" onclick="saveEdit()">Mentés</button>
      </div>
      <div id="e_info" class="muted"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Mentve</div>

<script>
/* ===== Beállítások ===== */
const ADMIN_USER = "szokeadmin";
const ADMIN_PASS = "szoke2025";
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const BUCKET = "products";

let sb = null;
function ensureSB(){ try{ if(!sb && window.supabase){ sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } } catch(e){ console.warn("Supabase init hiba:", e); } return sb; }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

function setLogged(v){
  localStorage.setItem("szoke_admin", v?"1":"");
  document.getElementById("loginBox").classList.toggle("hidden", v);
  document.getElementById("app").classList.toggle("hidden", !v);
}

document.addEventListener("DOMContentLoaded", ()=>{
  if(localStorage.getItem("szoke_admin")==="1"){ setLogged(true); loadAll(); }

  document.getElementById("loginBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    const u = document.getElementById("u").value.trim();
    const p = document.getElementById("p").value.trim();
    if(u===ADMIN_USER && p===ADMIN_PASS){ setLogged(true); loadAll(); }
    else alert("Hibás felhasználónév vagy jelszó.");
  });

  document.getElementById("logoutBtn").addEventListener("click", ()=>{ setLogged(false); });

  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.getElementById("tab-products").classList.toggle("hidden", tab!=="products");
      document.getElementById("tab-orders").classList.toggle("hidden", tab!=="orders");
      document.getElementById("tab-reviews").classList.toggle("hidden", tab!=="reviews");
      if(tab==="orders") loadOrders();
      if(tab==="reviews") loadReviews();
    });
  });

  document.getElementById("addBtn").addEventListener("click", addProduct);
  document.getElementById("plist").addEventListener("click", onProductsClick);
  document.getElementById("psearch").addEventListener("input", ()=>renderProductsFiltered());
  document.getElementById("refreshOrders").addEventListener("click", loadOrders);
  document.getElementById("exportBtn").addEventListener("click", exportCSV);
  document.getElementById("exportPdfBtn").addEventListener("click", exportInvoicesPdf);
});

/* ===== Termékek ===== */
let P_ADMIN = []; // utoljára lekért termékek

async function listProducts(){
  if(!ensureSB()) return alert("Supabase nem elérhető (script).");
  const {data,error}=await sb.from('products').select('id,title,price,instock,image_url,description').order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  P_ADMIN = data||[];
  renderProductsFiltered();
}
function renderProductsFiltered(){
  const q = (document.getElementById('psearch').value||'').toLowerCase().trim();
  const filtered = P_ADMIN.filter(p=>{
    const hay = `${p.title||''} ${p.description||''}`.toLowerCase();
    return hay.includes(q);
  });
  const nf=(n)=>new Intl.NumberFormat('hu-HU').format(n||0);
  const wrap=document.getElementById("plist");
  wrap.innerHTML=filtered.map(p=>`
    <div class="item" data-id="${p.id}">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div>
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><strong>${p.title||'-'}</strong></div>
        <div class="muted">${nf(p.price)} Ft • ${p.instock?'készleten':'nem elérhető'}</div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-action="toggle" data-instock="${p.instock?'1':'0'}">${p.instock?'Leállít':'Elérhetővé'}</button>
        <button class="btn" data-action="edit">Módosítás</button>
        <button class="btn bad" data-action="delete">Törlés</button>
      </div>
    </div>`).join("");
  document.getElementById("pempty").style.display=filtered.length?"none":"block";
}

async function addProduct(){
  if(!ensureSB()) return alert("Supabase nem elérhető (script).");
  const title=document.getElementById("title").value.trim();
  const price=parseInt(document.getElementById("price").value||"0",10);
  const description=document.getElementById("desc").value||"";
  const instock=document.getElementById("instock").checked;
  const file=document.getElementById("file").files[0];
  const info=document.getElementById("pInfo"); info.textContent="";

  if(!title || !price){ alert("Név és ár kötelező."); return; }

  let image_url=null;
  if(file){
    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const fname=`${crypto.randomUUID()}.${ext}`;
    const up=await sb.storage.from(BUCKET).upload(fname, file, {upsert:false});
    if(up.error){
      alert("Képfeltöltési hiba: "+up.error.message+"\n(Állíts be INSERT jogot a 'products' bucketre.)");
    }else{
      const { data } = sb.storage.from(BUCKET).getPublicUrl(fname);
      image_url=data.publicUrl;
    }
  }

  const ins=await sb.from('products').insert({title,price,description,instock,image_url}).select().single();
  if(ins.error){ alert("Hiba: "+ins.error.message); return; }
  document.getElementById("title").value=""; document.getElementById("price").value="";
  document.getElementById("desc").value=""; document.getElementById("file").value="";
  info.textContent="Mentve. ID: "+ins.data.id;
  toast("Termék hozzáadva");
  listProducts();
}

/* — gombok eseménykezelése — */
function onProductsClick(e){
  const actionBtn = e.target.closest('[data-action]');
  if(!actionBtn) return;
  const item = e.target.closest('.item'); if(!item) return;
  const id = item.dataset.id;
  const action = actionBtn.dataset.action;

  if(action==='toggle'){ toggleStock(id, actionBtn.dataset.instock==='1', actionBtn, item); }
  else if(action==='edit'){ const p = P_ADMIN.find(x=>String(x.id)===String(id)); if(p) openEdit(p); }
  else if(action==='delete'){ delProduct(id); }
}

async function toggleStock(id, cur, btn, itemEl){
  if(!ensureSB()) return;
  const { data, error } = await sb.from('products').update({instock:!cur}).eq('id',id).select('id,instock').single();
  if(error){ alert("Hiba: "+error.message+"\n(Ellenőrizd az RLS policy-t: UPDATE engedélyezve?)"); return; }
  // azonnali UI frissítés
  btn.dataset.instock = data.instock ? '1':'0';
  btn.textContent = data.instock ? 'Leállít' : 'Elérhetővé';
  const label = itemEl.querySelector('.muted');
  if(label){ label.innerHTML = label.innerHTML.replace(cur?'nem elérhető':'készleten', data.instock?'készleten':'nem elérhető'); }
  toast("Mentve");
  // teljes újratöltés is, hogy kép/ár esetleges változás feljöjjön
  listProducts();
}

async function delProduct(id){
  if(!confirm("Biztos törlöd a terméket?")) return;
  if(!ensureSB()) return;
  const {error}=await sb.from('products').delete().eq('id',id);
  if(error) return alert("Hiba: "+error.message);
  toast("Termék törölve");
  listProducts();
}

/* === Termék szerkesztő (modal) === */
let EDIT_ID = null;
function openEdit(p){
  EDIT_ID = p.id;
  document.getElementById('e_title').value = p.title || '';
  document.getElementById('e_price').value = Number(p.price||0);
  document.getElementById('e_desc').value  = p.description || '';
  document.getElementById('e_instock').checked = !!p.instock;
  document.getElementById('e_file').value = '';
  document.getElementById('e_info').textContent = '';
  document.getElementById('editScrim').classList.add('open');
  document.getElementById('editModal').classList.add('open');
}
function closeEdit(){
  document.getElementById('editScrim').classList.remove('open');
  document.getElementById('editModal').classList.remove('open');
}
async function saveEdit(){
  if(!ensureSB()) return;
  if(!EDIT_ID) return closeEdit();
  const title=document.getElementById('e_title').value.trim();
  const price=parseInt(document.getElementById('e_price').value||'0',10);
  const description=document.getElementById('e_desc').value||'';
  const instock=document.getElementById('e_instock').checked;
  const file=document.getElementById('e_file').files[0];
  const info=document.getElementById('e_info');

  if(!title || !price){ alert("Név és ár kötelező."); return; }

  const patch={ title, price, description, instock };

  // opcionális képcsere
  if(file){
    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const fname=`${crypto.randomUUID()}.${ext}`;
    const up=await sb.storage.from(BUCKET).upload(fname, file, {upsert:false});
    if(up.error){
      alert("Képfeltöltési hiba: "+up.error.message);
    }else{
      const { data } = sb.storage.from(BUCKET).getPublicUrl(fname);
      patch.image_url = data.publicUrl;
    }
  }

  const { data, error } = await sb.from('products').update(patch).eq('id', EDIT_ID).select('id').single();
  if(error){ alert("Hiba: "+error.message+"\n(Ellenőrizd: UPDATE policy megvan?)"); return; }
  info.textContent = "Frissítve.";
  toast("Termék frissítve");
  closeEdit();
  listProducts();
}

/* ===== Rendelések ===== */
let ORDERS_CACHE = [];
async function loadOrders(){
  if(!ensureSB()) return;
  const {data,error}=await sb.from('orders')
    .select('id,created_at,name,email,phone,address,shipping,note,subtotal,shipping_cost,discount,total,coupon_code,coupon_percent,items,status')
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  ORDERS_CACHE = data||[];
  renderOrders(ORDERS_CACHE);
}
function statusBadge(st){
  const map = { 'Új':'badge yellow', 'Folyamatban':'badge', 'Kézbesítve':'badge green', 'Törölve':'badge red' };
  const cls = map[st] || 'badge gray';
  return `<span class="${cls}" style="margin-left:6px">${st||'—'}</span>`;
}
function renderOrders(list){
  const nf = (n)=>new Intl.NumberFormat('hu-HU').format(n||0);
  const HUF = (n)=> nf(n) + ' Ft';
  const box=document.getElementById("olist");
  box.innerHTML=list.map(o=>{
    const items=(o.items||[]).map(it=>`${it.title} × ${it.qty}`).join(", ");
    const couponBits = o.coupon_code
      ? ` • Kedvezmény −${HUF(o.discount||0)} • Kupon ${o.coupon_code}${o.coupon_percent?` (${o.coupon_percent}%)`:''}`
      : (Number(o.discount||0)>0 ? ` • Kedvezmény −${HUF(o.discount)}` : '');
    const sel = `
      <select data-status="${o.id}" class="input" style="width:auto">
        ${['Új','Folyamatban','Kézbesítve','Törölve'].map(s=>`<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('')}
      </select>`;
    return `<div class="card" data-order="${o.id}">
      <div class="row" style="justify-content:space-between">
        <strong>#${String(o.id).slice(-6)}</strong>
        <div class="muted">${new Date(o.created_at).toLocaleString('hu-HU')}</div>
      </div>
      <div> ${o.name} • ${o.email} • ${o.phone} <span class="status-badge">${statusBadge(o.status)}</span></div>
      <div class="muted">Cím: ${o.address} • Szállítás: ${o.shipping||'-'}</div>
      ${o.note?`<div class="muted" style="font-size:13px">${o.note}</div>`:''}
      <div class="muted">Tételek: ${items||'-'}</div>
      <div class="row" style="gap:10px;margin-top:8px;justify-content:space-between;align-items:center">
        <div>
          <strong>Összesen: ${HUF(o.total)}</strong>
          <span class="muted">(Részösszeg ${HUF(o.subtotal)} • Szállítás ${HUF(o.shipping_cost)}${couponBits})</span>
          ${o.coupon_code?` <span class="badge" style="margin-left:6px">${o.coupon_code}</span>`:''}
        </div>
        <div class="row" style="gap:8px">
          ${sel}
          <button class="btn bad" type="button" onclick="deleteOrder('${o.id}')">Rendelés törlése</button>
        </div>
      </div>
    </div>`;
  }).join("");
  document.getElementById("oempty").style.display=list.length?"none":"block";

  // státusz változtatás – azonnali jelzés a kártyán
  box.querySelectorAll('select[data-status]').forEach(sel=>{
    sel.addEventListener('change', async ()=>{
      const id = sel.getAttribute('data-status');
      const val = sel.value;
      const ok = await saveStatus(id, val);
      if(ok){
        const card = sel.closest('[data-order]');
        if(card){
          const sb = card.querySelector('.status-badge');
          if(sb) sb.innerHTML = statusBadge(val);
        }
        toast("Státusz frissítve");
      }else{
        alert("Nem sikerült menteni a státuszt.");
      }
    });
  });
}
async function saveStatus(id, statusValue){
  // 1) mentés 'status' oszlopba
  const res = await sb.from('orders').update({ status: statusValue }).eq('id', id).select('id').single();
  if(!res.error) return true;

  // 2) ha nincs oszlop, a note-hoz fűzzük
  if(/column.*status/i.test(String(res.error.message||''))){
    const cur = await sb.from('orders').select('note').eq('id', id).single();
    if(cur.error) return false;
    const addon = ` [Status: ${statusValue}]`;
    const upd = await sb.from('orders').update({ note: (cur.data?.note||'') + addon }).eq('id', id);
    return !upd.error;
  }
  return false;
}
async function deleteOrder(id){
  if(!confirm("Biztos törlöd a rendelést?")) return;
  const {error}=await sb.from('orders').delete().eq('id',id);
  if(error){ alert("Hiba: "+error.message); return; }
  toast("Rendelés törölve");
  loadOrders();
}

/* === CSV export === */
function exportCSV(){
  if(!ORDERS_CACHE.length){ alert("Nincs exportálható rendelés."); return; }
  const header = ['id','created_at','name','email','phone','address','shipping','subtotal','shipping_cost','discount','total','coupon_code','coupon_percent','status','items'];
  const rows = ORDERS_CACHE.map(o=>{
    const items = Array.isArray(o.items)? o.items.map(it=>`${(it.title||'').replace(/"/g,'""')} x ${it.qty}`).join(' | '):'';
    return [
      o.id, o.created_at, o.name, o.email, o.phone, o.address, o.shipping,
      o.subtotal, o.shipping_cost, o.discount, o.total, o.coupon_code||'', o.coupon_percent||'',
      o.status||'', items
    ].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',');
  });
  const csv = [header.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `orders-${ts}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* === Számlaszerű PDF (print) === */
function exportInvoicesPdf(){
  if(!ORDERS_CACHE.length){ alert("Nincs exportálható rendelés."); return; }
  const HUF = n => (Number(n)||0).toLocaleString('hu-HU') + ' Ft';
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const rows = ORDERS_CACHE.map(o=>{
    const items = (Array.isArray(o.items)? o.items:[]).map(it=>
      `<tr><td>${esc(it.title)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${HUF(it.price)}</td><td style="text-align:right">${HUF(it.price*it.qty)}</td></tr>`
    ).join('');
    const discRow = Number(o.discount||0)>0
      ? `<tr><td colspan="3" style="text-align:right">Kedvezmény</td><td style="text-align:right">-${HUF(o.discount)}</td></tr>` : '';
    const couponRow = o.coupon_code ? `<div style="margin:4px 0 0;color:#374151">Kupon: <b>${esc(o.coupon_code)}</b>${o.coupon_percent?` (${o.coupon_percent}%)`:''}</div>`:'';
    return `
    <section style="page-break-inside:avoid;margin:18px 0;padding:14px;border:1px solid #e5e7eb;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:10px;align-items:center">
          <img src="logo.png" style="height:26px"><h3 style="margin:0">Szőke Épker – Rendelés</h3>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">#${String(o.id).slice(-6)}</div>
          <div style="color:#6b7280">${new Date(o.created_at).toLocaleString('hu-HU')}</div>
        </div>
      </div>
      <div style="margin:8px 0 6px;color:#374151">
        <b>${esc(o.name)}</b> • ${esc(o.email)} • ${esc(o.phone)} ${o.status?`<span style="margin-left:6px;background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:2px 8px;font-weight:700">${esc(o.status)}</span>`:''}<br>
        Cím: ${esc(o.address)} • Szállítás: ${esc(o.shipping||'-')}
        ${couponRow}
      </div>
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px 0">Termék</th>
            <th style="text-align:center;border-bottom:1px solid #e5e7eb;padding:6px 0">Menny.</th>
            <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px 0">Egységár</th>
            <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px 0">Összeg</th>
          </tr>
        </thead>
        <tbody>${items}</tbody>
        <tfoot>
          <tr><td colspan="3" style="text-align:right">Részösszeg</td><td style="text-align:right">${HUF(o.subtotal)}</td></tr>
          <tr><td colspan="3" style="text-align:right">Szállítás</td><td style="text-align:right">${HUF(o.shipping_cost)}</td></tr>
          ${discRow}
          <tr><td colspan="3" style="text-align:right;font-weight:700">Végösszeg</td><td style="text-align:right;font-weight:700">${HUF(o.total)}</td></tr>
        </tfoot>
      </table>
    </section>`;
  }).join('');

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Rendelések – Szőke Épker</title>
  <style>@page{size:A4;margin:16mm}body{font-family:Inter,system-ui;background:#fff;color:#111}
  h3{font-size:18px} table td,table th{font-size:13px;padding:6px 0}</style></head>
  <body>
    ${rows}
    <script>setTimeout(()=>window.print(),250);<\/script>
  </body></html>`;

  const blob = new Blob([html], {type:'text/html;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}

/* ===== Vélemények ===== */
async function loadReviews(){
  if(!ensureSB()) return;
  const {data,error}=await sb.from('reviews').select('id,created_at,username,text,rating,product_id').order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  const list=data||[]; const box=document.getElementById("rlist");
  box.innerHTML=list.map(r=>`
    <div class="item" style="grid-template-columns:1fr auto">
      <div>
        <div><strong>${r.username||'Névtelen'}</strong> ${r.rating?`<span class="muted">• ${"★".repeat(r.rating)}</span>`:''}</div>
        <div class="muted" style="font-size:13px">${new Date(r.created_at).toLocaleString('hu-HU')}</div>
        <div>${r.text}</div>
      </div>
      <button class="btn bad" type="button" onclick="delReview('${r.id}')">Törlés</button>
    </div>`).join("");
  document.getElementById("rempty").style.display=list.length?"none":"block";
}
async function delReview(id){
  if(!confirm("Biztos törlöd a véleményt?")) return;
  const {error}=await sb.from('reviews').delete().eq('id',id);
  if(error) return alert("Hiba: "+error.message);
  toast("Vélemény törölve");
  loadReviews();
}

/* ===== Init ===== */
function loadAll(){ ensureSB(); listProducts(); }
</script>
</body>
</html>
