<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sz≈ëke √âpker Webshop</title>
  <style>
    :root{
      --bg:#f5f6f7;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--brand:#0ea5e9;--brand-ink:#ffffff;
      --ring:rgba(14,165,233,.35);--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:5;background:rgba(245,246,247,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #e5e7eb}
    header .wrap{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:40px}
    .brand h1{font-size:20px;margin:0}
    .btn,.btn-primary{display:inline-flex;align-items:center;gap:8px;border:1px solid #dbe1e8;border-radius:10px;padding:10px 14px;background:#fff;cursor:pointer}
    .btn:hover{border-color:#c9cfd7}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
    .btn-primary:hover{filter:brightness(.95)}
    /* Filter row */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
    .input{height:42px;border:1px solid #dbe1e8;border-radius:10px;padding:0 12px;background:#fff;min-width:240px}
    select.input{padding-right:30px}
    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#f2f4f7;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card .body{padding:14px;display:grid;gap:8px}
    .title{font-weight:600}
    .muted{color:var(--muted);font-size:14px}
    .price{font-weight:700}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid #e5e7eb}
    .badge.ok{color:#065f46;border-color:#a7f3d0;background:#ecfdf5}
    .badge.out{color:#92400e;border-color:#fed7aa;background:#fffbeb}
    /* Drawer cart */
    .drawer{position:fixed;inset:0 0 0 auto;display:none}
    .drawer.open{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(2,6,23,.45)}
    .panel{position:absolute;right:0;top:0;height:100%;width:420px;max-width:100%;background:#fff;
      display:flex;flex-direction:column;border-left:1px solid #e5e7eb}
    .panel header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb}
    .panel header .wrap{padding:12px 16px}
    .panel .content{padding:16px;overflow:auto;display:grid;gap:14px}
    .qty{display:inline-flex;border:1px solid #dbe1e8;border-radius:8px;overflow:hidden}
    .qty button{width:32px;height:32px;background:#fff;border:0;border-right:1px solid #e5e7eb;cursor:pointer}
    .qty input{width:40px;text-align:center;border:0}
    .line{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .line .t{font-weight:600}
    .hr{height:1px;background:#e5e7eb;margin:8px 0}
    form .field{display:grid;gap:6px;margin-bottom:10px}
    input[type="text"],input[type="email"],textarea{border:1px solid #dbe1e8;border-radius:10px;padding:10px 12px}
    textarea{min-height:70px;resize:vertical}
    .note{font-size:12px;color:var(--muted)}
    .empty{padding:26px;border:1px dashed #dbe1e8;border-radius:12px;text-align:center;color:var(--muted)}
    .footer-spacer{height:24px}
  </style>
</head>
<body>
  <header>
    <div class="container wrap">
      <div class="brand">
        <img src="logo.png" alt="Sz≈ëke √âpker Kft">
        <h1>Sz≈ëke √âpker Kft</h1>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn" href="index.html">‚Üê Vissza a weboldalra</a>
        <button class="btn-primary" id="openCart">üõí Kos√°r <span id="cartCount">0</span></button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="filters">
      <input id="search" class="input" type="search" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶">
      <select id="sort" class="input">
        <option value="newest">Leg√∫jabb</option>
        <option value="price-asc">√År szerint n≈ë</option>
        <option value="price-desc">√År szerint cs√∂kken</option>
      </select>
    </div>
    <div id="grid" class="grid"></div>
    <div class="footer-spacer"></div>
  </main>

  <!-- Cart drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" id="backdrop"></div>
    <div class="panel">
      <header>
        <div class="wrap container" style="display:flex;justify-content:space-between;align-items:center">
          <strong>Kos√°r</strong>
          <button class="btn" id="closeCart">‚úï</button>
        </div>
      </header>
      <div class="content">
        <div id="cartLines"></div>
        <div class="hr"></div>
        <div id="totals"></div>
        <form id="orderForm">
          <details open>
            <summary style="cursor:pointer;margin-bottom:10px"><strong>Megrendel√©s adatai</strong></summary>
            <div class="field"><label>N√©v</label><input required type="text" id="name"></div>
            <div class="field"><label>E-mail</label><input required type="email" id="email"></div>
            <div class="field"><label>Telefon</label><input required type="text" id="phone"></div>
            <div class="field"><label>C√≠m</label><input required type="text" id="address"></div>
            <div class="field"><label>Sz√°ll√≠t√°s m√≥dja</label><input required type="text" id="shipping"></div>
            <div class="field"><label>Megjegyz√©s</label><textarea id="note" placeholder="(opcion√°lis)"></textarea></div>
          </details>
          <button class="btn-primary" type="submit" style="width:100%">Rendel√©s elk√ºld√©se</button>
          <p class="note">Megjegyz√©s: elk√ºld√©skor a rendel√©s beker√ºl az ‚Äûorders‚Äù t√°bl√°ba.</p>
        </form>
      </div>
    </div>
  </aside>

  <script type="module">
    // --- Supabase be√°ll√≠t√°sok (a Te projekted) ---
    const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
    const sb = await import("https://esm.sh/@supabase/supabase-js@2");
    const supabase = sb.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- √Ållapot ---
    let products = [];
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

    // --- UI seg√©dek ---
    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const sortSel = document.getElementById("sort");
    const cartBtn = document.getElementById("openCart");
    const closeCart = document.getElementById("closeCart");
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("backdrop");
    const cartLines = document.getElementById("cartLines");
    const totals = document.getElementById("totals");
    const orderForm = document.getElementById("orderForm");
    const cartCount = document.getElementById("cartCount");

    function fmt(n){return new Intl.NumberFormat('hu-HU').format(n)+" Ft";}
    function setCartCount(){cartCount.textContent = cart.reduce((a,x)=>a+x.qty,0);}

    // --- Term√©kek let√∂lt√©se ---
    async function loadProducts(){
      const { data, error } = await supabase
        .from("products")
        .select("id,title,price,instock,image_url,description")
        .order("created_at",{ascending:false});
      if(error){ grid.innerHTML = `<div class="empty">Hiba: ${error.message}</div>`; return; }
      products = data || [];
      renderList();
    }

    function renderList(){
      const q = (search.value||"").toLowerCase();
      let arr = products.filter(p => p.title?.toLowerCase().includes(q));
      if(sortSel.value==="price-asc") arr.sort((a,b)=>a.price-b.price);
      if(sortSel.value==="price-desc") arr.sort((a,b)=>b.price-a.price);
      const html = arr.map(p => `
        <article class="card">
          <a class="thumb" href="product.html?id=${encodeURIComponent(p.id)}" title="${p.title}">
            <img src="${p.image_url||''}" alt="${p.title||''}" onerror="this.src='https://placehold.co/600x450?text=Nincs+k√©p'">
          </a>
          <div class="body">
            <div class="row">
              <div class="title">${p.title||'‚Äî'}</div>
              <div class="price">${fmt(p.price||0)}</div>
            </div>
            <div class="row">
              <span class="badge ${p.instock?'ok':'out'}">${p.instock?'k√©szleten':'nem el√©rhet≈ë'}</span>
              <div style="display:flex;gap:8px">
                <a class="btn" href="product.html?id=${encodeURIComponent(p.id)}">Megnyit√°s</a>
                <button class="btn-primary" ${p.instock?'':'disabled'} data-add="${p.id}">Kos√°rba</button>
              </div>
            </div>
          </div>
        </article>
      `).join("");
      grid.innerHTML = html || `<div class="empty">Nincs tal√°lat.</div>`;
      grid.querySelectorAll("[data-add]").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const id = e.currentTarget.getAttribute("data-add");
          const prod = products.find(x=>String(x.id)===String(id));
          if(!prod) return;
          const line = cart.find(x=>String(x.id)===String(id));
          if(line) line.qty++; else cart.push({id:prod.id,title:prod.title,price:prod.price,image_url:prod.image_url,qty:1});
          localStorage.setItem("cart", JSON.stringify(cart));
          setCartCount();
          openCart();
        });
      });
    }

    // --- Kos√°r rajzol√°s ---
    function renderCart(){
      if(cart.length===0){
        cartLines.innerHTML = `<div class="empty">A kos√°r √ºres.</div>`;
        totals.innerHTML = "";
        return;
      }
      cartLines.innerHTML = cart.map((l,i)=>`
        <div class="line">
          <img src="${l.image_url||''}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" onerror="this.src='https://placehold.co/80'">
          <div>
            <div class="t">${l.title}</div>
            <div class="qty">
              <button data-dec="${i}">‚àí</button>
              <input value="${l.qty}" readonly>
              <button data-inc="${i}">+</button>
            </div>
            <button class="btn" data-del="${i}" style="margin-top:6px">Elt√°vol√≠t√°s</button>
          </div>
          <div>${fmt(l.price*l.qty)}</div>
        </div>
      `).join("");
      const sub = cart.reduce((a,l)=>a+l.price*l.qty,0);
      totals.innerHTML = `
        <div class="line"><div>R√©sz√∂sszeg</div><div></div><div>${fmt(sub)}</div></div>
        <div class="line"><div>Sz√°ll√≠t√°s</div><div></div><div>0 Ft</div></div>
        <div class="line" style="font-weight:700"><div>√ñsszesen</div><div></div><div>${fmt(sub)}</div></div>
      `;
      cartLines.querySelectorAll("[data-inc]").forEach(b=>b.onclick=()=>{cart[b.dataset.inc].qty++;saveCart();});
      cartLines.querySelectorAll("[data-dec]").forEach(b=>b.onclick=()=>{const i=b.dataset.dec;cart[i].qty=Math.max(1,cart[i].qty-1);saveCart();});
      cartLines.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>{cart.splice(b.dataset.del,1);saveCart();});
    }
    function saveCart(){localStorage.setItem("cart",JSON.stringify(cart));renderCart();setCartCount();}
    function openCart(){drawer.classList.add("open");renderCart();}
    function closeDrawer(){drawer.classList.remove("open");}

    // --- Rendel√©s k√ºld√©se ---
    orderForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(cart.length===0) return alert("A kos√°r √ºres.");
      const items = cart.map(l=>({id:l.id,title:l.title,price:l.price,qty:l.qty,image_url:l.image_url}));
      const subtotal = cart.reduce((a,l)=>a+l.price*l.qty,0);
      const shipping_cost = 0;
      const total = subtotal + shipping_cost;
      const payload = {
        name: document.getElementById("name").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        shipping: document.getElementById("shipping").value.trim(),
        note: document.getElementById("note").value.trim(),
        items,
        subtotal, shipping_cost, total
      };
      const { error } = await supabase.from("orders").insert(payload);
      if(error){ alert("Hiba: "+error.message); return; }
      cart = []; saveCart(); closeDrawer();
      alert("K√∂sz√∂nj√ºk a megrendel√©st! ‚úî");
    });

    // --- Esem√©nyek ---
    cartBtn.onclick = openCart;
    closeCart.onclick = closeDrawer;
    backdrop.onclick = closeDrawer;
    search.oninput = ()=>renderList();
    sortSel.onchange = ()=>renderList();

    // Start
    setCartCount();
    loadProducts();
  </script>
</body>
</html>
