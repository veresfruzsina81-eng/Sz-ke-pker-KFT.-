<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Szőke-Épker Kft. – Webshop</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --ink:#222;
  --muted:#7a8594;
  --bg:#f5f7fb;
  --card:#fff;
  --brand:#2f6fed;
  --brand-2:#245bcb;
  --ring:0 0 0 3px rgba(47,111,237,.18);
  --radius:16px;
  --bad:#e23d3d;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#ffffffdd,#ffffffcc);
  backdrop-filter: blur(8px);border-bottom:1px solid #e5e9f2}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:28px}
.brand h1{font-size:18px;margin:0}
.actions{display:flex;gap:10px;align-items:center}
.btn{appearance:none;border:0;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff}
.btn:hover{background:var(--brand-2)}
.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
input[type="search"]{width:100%;border:1px solid #e5e9f2;background:#fff;padding:12px 14px;border-radius:12px}
input[type="search"]:focus{outline:none;box-shadow:var(--ring);border-color:#d6def7}

.grid{display:grid;gap:16px;margin-top:16px}
@media(min-width:800px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--card);border:1px solid #e5e9f2;border-radius:16px;box-shadow:0 16px 40px rgba(22,29,37,.05);overflow:hidden}
.thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-bottom:1px solid #eef2f8;background:#fafbfe}
.px{padding:12px 14px}
.row{display:flex;align-items:center;gap:10px}
.space{justify-content:space-between}
.muted{color:var(--muted)}

.qty{display:inline-flex;align-items:center;border:1px solid #e5e9f2;border-radius:999px;overflow:hidden}
.qty button{background:#fff;border:0;width:28px;height:28px;cursor:pointer}
.qty input{width:34px;border:0;text-align:center}
.qty button:focus{outline:none;box-shadow:var(--ring)}

.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #e5e9f2;background:#fff;font-size:12px}
.price{font-weight:700}

.footer-note{font-size:12px;color:var(--muted);margin-top:10px}

/* Cart drawer */
.drawer{position:fixed;inset:0;pointer-events:none}
.drawer .shade{position:absolute;inset:0;background:rgba(0,0,0,.2);opacity:0;transition:.2s}
.drawer .panel{position:absolute;top:0;right:-420px;width:420px;max-width:90vw;height:100%;background:#fff;border-left:1px solid #e5e9f2;box-shadow:-20px 0 50px rgba(0,0,0,.08);transition:.25s;padding:16px 14px;display:flex;flex-direction:column;gap:12px}
.drawer.show{pointer-events:auto}
.drawer.show .shade{opacity:1}
.drawer.show .panel{right:0}
.x{background:#fff;border:1px solid #e5e9f2;border-radius:10px;width:36px;height:36px;cursor:pointer}
.line{height:1px;background:#eef2f8;margin:8px 0}

/* Product modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal .shade{position:absolute;inset:0;background:rgba(0,0,0,.25)}
.modal .box{position:relative;background:#fff;border:1px solid #e5e9f2;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:min(920px,96vw);max-height:90vh;overflow:auto}
@media(min-width:900px){.modal .content{display:grid;grid-template-columns:380px 1fr}}
.modal .img{width:100%;aspect-ratio:1/1;object-fit:cover;border-right:1px solid #eef2f8;background:#fafbfe}
.close{position:absolute;top:10px;right:10px}
</style>
</head>
<body>

<header class="header">
  <div class="wrap row space">
    <div class="brand">
      <img src="logo.png" alt="Szőke-Épker">
      <h1>Szőke-Épker Kft.</h1>
    </div>
    <div class="actions">
      <a class="btn ghost" href="/">Vissza a weboldalra</a>
      <button id="cartBtn" class="btn" type="button">Kosár</button>
    </div>
  </div>
</header>

<main class="wrap">
  <input id="q" type="search" placeholder="Keresés a termékek közt…">
  <div id="list" class="grid"></div>
  <p id="empty" class="muted" style="display:none">Nincs találat.</p>
</main>

<!-- CART DRAWER -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="shade" onclick="closeCart()"></div>
  <div class="panel">
    <div class="row space">
      <h2 style="margin:0">Kosár</h2>
      <button class="x" onclick="closeCart()">✕</button>
    </div>
    <div id="cartItems" style="flex:1;overflow:auto"></div>
    <div class="line"></div>
    <div id="total" class="row space"><strong>Összesen:</strong><strong>0 Ft</strong></div>
    <details>
      <summary><strong>Megrendelés adatai</strong></summary>
      <div class="row" style="flex-direction:column;gap:8px;margin-top:8px">
        <input id="o_name" placeholder="Név">
        <input id="o_email" placeholder="E-mail">
        <input id="o_phone" placeholder="Telefon">
        <input id="o_address" placeholder="Szállítási cím">
        <input id="o_shipping" placeholder="Szállítás módja (pl. személyes / futár)">
        <textarea id="o_note" placeholder="Megjegyzés" rows="3"></textarea>
      </div>
    </details>
    <button class="btn" onclick="placeOrder()">Rendelés elküldése</button>
    <p class="footer-note">Megjegyzés: elküldéskor a rendelés bekerül az „orders” táblába.</p>
  </div>
</div>

<!-- PRODUCT MODAL -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="shade" onclick="closeModal()"></div>
  <div class="box">
    <button class="x close" onclick="closeModal()">✕</button>
    <div class="content">
      <img id="m_img" class="img" alt="">
      <div class="px">
        <h2 id="m_title" style="margin:0 0 6px"></h2>
        <div class="row" style="gap:10px;margin-bottom:8px">
          <span id="m_price" class="price"></span>
          <span id="m_stock" class="badge">készleten</span>
        </div>
        <div id="m_desc" class="muted" style="white-space:pre-wrap"></div>
        <div class="row" style="gap:10px;margin-top:12px">
          <div class="qty">
            <button onclick="stepQty('m_qty',-1)">−</button>
            <input id="m_qty" value="1" inputmode="numeric" />
            <button onclick="stepQty('m_qty',+1)">+</button>
          </div>
          <button class="btn" onclick="addFromModal()">Kosárba</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Supabase ===== */
const SB_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const sb = supabase.createClient(SB_URL, SB_KEY);

/* ===== State ===== */
let PRODUCTS = [];
let CART = JSON.parse(localStorage.getItem("cart")||"[]");
let MODAL_PRODUCT = null;

/* ===== Helpers ===== */
const HUF = n => new Intl.NumberFormat('hu-HU').format(n||0)+" Ft";

function saveCart(){ localStorage.setItem("cart", JSON.stringify(CART)); }
function stepQty(id,delta){
  const el = document.getElementById(id);
  let v = parseInt(el.value||"1",10);
  v = Math.max(1, v+delta);
  el.value = v;
}
function openCart(){ document.getElementById('drawer').classList.add('show'); renderCart(); }
function closeCart(){ document.getElementById('drawer').classList.remove('show'); }
function openModal(p){ MODAL_PRODUCT=p; document.getElementById('m_img').src=p.image_url||'logo.png';
  document.getElementById('m_title').textContent=p.title||'-';
  document.getElementById('m_price').textContent=HUF(p.price);
  document.getElementById('m_stock').textContent=p.instock?'készleten':'nem elérhető';
  document.getElementById('m_desc').textContent=p.description||'Nincs leírás.';
  document.getElementById('m_qty').value=1;
  document.getElementById('modal').classList.add('show');
}
function closeModal(){ document.getElementById('modal').classList.remove('show'); }

/* ===== Render products ===== */
function renderProducts(list){
  const box = document.getElementById('list');
  box.innerHTML = list.map(p=>`
    <article class="card">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div class="px">
        <div class="row space">
          <strong>${p.title||'-'}</strong>
          <span class="price">${HUF(p.price)}</span>
        </div>
        <div class="row space" style="margin-top:10px">
          <div class="qty">
            <button data-act="minus" data-id="${p.id}">−</button>
            <input value="1" data-qty="${p.id}">
            <button data-act="plus" data-id="${p.id}">+</button>
          </div>
          <div class="row">
            <button class="btn" data-add="${p.id}">Kosárba</button>
            <button class="btn ghost" data-open="${p.id}">Megnyitás</button>
          </div>
        </div>
      </div>
    </article>
  `).join('');
  document.getElementById('empty').style.display = list.length?'none':'block';
}

/* event delegation for qty / add / open */
document.getElementById('list').addEventListener('click', (e)=>{
  const minus = e.target.closest('[data-act="minus"]');
  const plus  = e.target.closest('[data-act="plus"]');
  const add   = e.target.closest('[data-add]');
  const open  = e.target.closest('[data-open]');
  if(minus){ const id=minus.dataset.id; const q=document.querySelector(`[data-qty="${id}"]`); q.value=Math.max(1,parseInt(q.value||"1")-1); }
  if(plus){  const id=plus.dataset.id;  const q=document.querySelector(`[data-qty="${id}"]`); q.value=Math.max(1,parseInt(q.value||"1")+1); }
  if(add){
    const id=add.dataset.add;
    const p = PRODUCTS.find(x=>String(x.id)===String(id));
    const qEl = document.querySelector(`[data-qty="${id}"]`);
    const qty = Math.max(1, parseInt(qEl?.value||"1"));
    addToCart(p, qty);
    openCart();
  }
  if(open){
    const id=open.dataset.open;
    const p = PRODUCTS.find(x=>String(x.id)===String(id));
    openModal(p);
  }
});

/* from modal */
function addFromModal(){
  if(!MODAL_PRODUCT) return;
  const qty = Math.max(1, parseInt(document.getElementById('m_qty').value||"1"));
  addToCart(MODAL_PRODUCT, qty);
  closeModal();
  openCart();
}

/* Add to cart */
function addToCart(p, qty){
  const i = CART.findIndex(x=>String(x.id)===String(p.id));
  if(i>=0){ CART[i].qty += qty; }
  else { CART.push({id:p.id, title:p.title, price:p.price, image_url:p.image_url, qty}); }
  saveCart();
  renderCart();
}

/* Cart render */
function renderCart(){
  const box = document.getElementById('cartItems');
  if(!CART.length){ box.innerHTML = `<p class="muted">A kosár üres.</p>`; document.getElementById('total').lastElementChild.textContent = HUF(0); return; }
  box.innerHTML = CART.map((it,idx)=>`
    <div class="row space" style="align-items:flex-start;border:1px solid #e5e9f2;border-radius:12px;padding:10px;margin-bottom:8px">
      <div class="row" style="gap:10px">
        <img src="${it.image_url||'logo.png'}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid #e5e9f2">
        <div>
          <div><strong>${it.title}</strong></div>
          <div class="muted">${HUF(it.price)}</div>
          <div class="qty" style="margin-top:6px">
            <button onclick="cartStep(${idx},-1)">−</button>
            <input value="${it.qty}" readonly>
            <button onclick="cartStep(${idx},+1)">+</button>
          </div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <strong>${HUF(it.price*it.qty)}</strong>
        <button class="btn ghost" onclick="removeItem(${idx})">Eltávolítás</button>
      </div>
    </div>
  `).join('');
  const sum = CART.reduce((s,x)=>s+x.price*x.qty,0);
  document.getElementById('total').lastElementChild.textContent = HUF(sum);
}
function cartStep(i,d){ CART[i].qty=Math.max(1,CART[i].qty+d); saveCart(); renderCart(); }
function removeItem(i){ CART.splice(i,1); saveCart(); renderCart(); }

/* Place order */
async function placeOrder(){
  if(!CART.length) return alert("A kosár üres.");
  const name   = document.getElementById('o_name').value.trim();
  const email  = document.getElementById('o_email').value.trim();
  const phone  = document.getElementById('o_phone').value.trim();
  const addr   = document.getElementById('o_address').value.trim();
  const ship   = document.getElementById('o_shipping').value.trim();
  const note   = document.getElementById('o_note').value.trim();
  if(!name || !email || !phone || !addr) return alert("Kérjük töltsd ki a kötelező mezőket (Név, E-mail, Telefon, Cím).");

  const subtotal = CART.reduce((s,x)=>s+x.price*x.qty,0);
  const shipping_cost = 0;
  const total = subtotal + shipping_cost;

  const payload = {
    name, email, phone, address:addr, shipping:ship||'Ismeretlen',
    note, items: CART, subtotal, shipping_cost, total
  };

  const { error } = await sb.from('orders').insert(payload);
  if(error){ alert("Hiba a rendelés mentésekor: "+error.message); return; }

  CART = []; saveCart(); renderCart(); closeCart();
  alert("Köszönjük a rendelést! Hamarosan felvesszük a kapcsolatot.");
}

/* Load products */
async function loadProducts(){
  const { data, error } = await sb.from('products')
    .select('id,title,price,description,image_url,instock')
    .eq('instock', true)
    .order('created_at', { ascending:false });
  if(error){ document.getElementById('list').innerHTML = `<p class="muted">Hiba: ${error.message}</p>`; return; }
  PRODUCTS = data||[];
  renderProducts(PRODUCTS);
}

/* Search */
document.getElementById('q').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  const f = !q ? PRODUCTS : PRODUCTS.filter(p =>
    (p.title||'').toLowerCase().includes(q) ||
    (p.description||'').toLowerCase().includes(q)
  );
  renderProducts(f);
});

/* Header buttons */
document.getElementById('cartBtn').addEventListener('click', openCart);

/* Init */
loadProducts();
renderCart();
</script>
</body>
</html>
