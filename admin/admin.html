<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Szőke Épker</title>
  <link rel="icon" href="logo.png">
  <style>
    :root{--brand:#8b5e34;--brand-2:#c19a6b;--bg:#fbf7f3}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#222}
    header{position:sticky;top:0;background:#1e293b;color:#fff;padding:.9rem 1rem;display:flex;align-items:center;gap:.75rem}
    header img{height:28px} header h1{font-size:1.1rem;margin:0;font-weight:700}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 8px 24px rgba(10,10,10,.05);padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    label span{display:block;font-size:.85rem;color:#555;margin-bottom:6px}
    input[type=text],input[type=number],textarea{width:100%;padding:.7rem .8rem;border:1px solid #ddd;border-radius:10px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 160px;gap:12px}
    .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:.75rem 1rem;border-radius:999px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eee;color:#111}
    .btn.danger{background:#dc2626}
    .list .item{display:flex;gap:12px;align-items:center;border:1px solid #eee;border-radius:12px;padding:10px 12px;background:#fff}
    .list img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #eee;background:#fafafa}
    .item h4{margin:0;font-size:1rem} .price{font-weight:700}
    .state{font-size:.8rem;border-radius:999px;padding:.15rem .5rem;border:1px solid #ddd;background:#f5f5f5}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .notice{padding:.7rem 1rem;border-radius:10px;background:#fff;border:1px dashed #e5e7eb;color:#374151}
    .login{max-width:420px;margin:60px auto}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <img src="logo.png" alt="">
  <h1>Admin felület</h1>
</header>

<main id="app"></main>

<script>
/*** TÖLTSD KI EZT A KÉT SORT ***/
const SUPABASE_URL =https://gckynywmoxylwyppmkck.supabase.co
 'https://<PROJECT>.supabase.co';
const SUPABASE_ANON_KEY = '<PUBLIC-ANON-KEY>';
/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI/

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Egyszerű (helyi) belépés – csak ez az 1 fiók léphet be
const USERNAME = 'szokeadmin';
const PASSWORD = 'szoke2025';

const el = s => document.querySelector(s);
const fmt = n => new Intl.NumberFormat('hu-HU').format(n)+' Ft';

function renderLogin(){
  el('#app').innerHTML = `
    <div class="card login">
      <h2 style="margin-top:0">Admin belépés</h2>
      <div style="display:grid;gap:10px">
        <label><span>Felhasználónév</span><input id="u" type="text" autocomplete="off"></label>
        <label><span>Jelszó</span><input id="p" type="password" autocomplete="off"></label>
        <button class="btn" id="loginBtn">Belépés</button>
        <div class="notice">Ha ez a gép a megrendelőé, maradhat bejelentkezve. Más nem fog belépni.</div>
      </div>
    </div>`;
  el('#loginBtn').onclick = () => {
    const ok = (el('#u').value.trim()===USERNAME && el('#p').value===PASSWORD);
    if(!ok){ alert('Hibás jelszó vagy inaktív fiók.'); return; }
    sessionStorage.setItem('adm','1');
    renderDashboard();
  };
}

function requireLogin(){
  if(sessionStorage.getItem('adm')==='1') return true;
  renderLogin(); return false;
}

async function renderDashboard(){
  if(!requireLogin()) return;

  el('#app').innerHTML = `
    <section class="card" style="margin-bottom:16px">
      <div class="toolbar">
        <h2 style="margin:0">Új termék</h2>
        <button class="btn secondary" id="reloadBtn">Lista frissítése</button>
      </div>
      <div class="row" style="margin-bottom:10px">
        <label><span>Termék neve</span><input id="title" type="text" placeholder="pl. Zsák"></label>
        <label><span>Ár (Ft)</span><input id="price" type="number" min="0" step="1" placeholder="0"></label>
      </div>
      <div class="row" style="margin-bottom:10px">
        <label style="grid-column:1/-1"><span>Rövid leírás (opcionális)</span><textarea id="desc" placeholder="Markdown is mehet"></textarea></label>
      </div>
      <div class="row" style="margin-bottom:10px">
        <label><span>Készleten</span><input id="instock" type="checkbox" checked></label>
        <label><span>Kép (jpg/png)</span><input id="file" type="file" accept="image/*"></label>
      </div>
      <button class="btn" id="saveBtn">Hozzáadás</button>
      <div class="notice" style="margin-top:10px">A kép a <b>products</b> bucketbe kerül. Ha nincs feltöltési jog, a termék kép nélkül mentődik.</div>
    </section>

    <section class="card">
      <div class="toolbar">
        <h2 style="margin:0">Legutóbbi termékek</h2>
      </div>
      <div id="list" class="grid list"></div>
    </section>
  `;

  el('#reloadBtn').onclick = loadList;
  el('#saveBtn').onclick = onSave;
  await loadList();
}

async function onSave(){
  if(!requireLogin()) return;
  const title = el('#title').value.trim();
  const price = parseInt(el('#price').value||'0',10);
  const description = el('#desc').value.trim();
  const instock = el('#instock').checked;
  const file = el('#file').files[0];

  if(!title || price<0){ alert('Adj meg nevet és árat.'); return; }

  // 1) kép feltöltés (opcionális)
  let image_url = null;
  let objectPath = null;
  if(file){
    try{
      const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
      const path = `admin/${crypto.randomUUID()}.${ext}`;
      objectPath = path;
      const { error:upErr } = await sb.storage.from('products').upload(path, file, { upsert:false });
      if(upErr) throw upErr;
      const { data } = sb.storage.from('products').getPublicUrl(path);
      image_url = data.publicUrl;
    }catch(e){
      alert('A képfeltöltés nem engedélyezett. A termék kép nélkül mentődik.\n(Később beállítható a bucket INSERT jog.)');
    }
  }

  // 2) beszúrás DB-be
  const { error:dbErr } = await sb.from('products').insert({
    title, price, instock, image_url, description
  });
  if(dbErr){ alert('Hiba: '+dbErr.message); return; }

  el('#title').value=''; el('#price').value=''; el('#desc').value=''; el('#instock').checked=true; el('#file').value='';
  await loadList();
}

async function loadList(){
  const list = el('#list');
  list.innerHTML = 'Betöltés...';
  const { data, error } = await sb.from('products')
    .select('id,title,price,instock,image_url,created_at')
    .order('created_at',{ascending:false})
    .limit(50);
  if(error){ list.innerHTML='Hiba: '+error.message; return; }
  if(!data.length){ list.innerHTML='<div class="notice">Még nincs termék.</div>'; return; }
  list.innerHTML = data.map(p=>`
    <div class="item">
      <img src="${p.image_url||'logo.png'}" alt="">
      <div style="flex:1 1 auto">
        <h4>${p.title||'(névtelen)'}</h4>
        <div class="price">${fmt(p.price||0)}</div>
        <div class="state">${p.instock?'készleten':'nem elérhető'}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <a class="btn secondary" href="product.html?id=${p.id}" target="_blank">Megnyitás</a>
        <button class="btn danger" onclick="delProduct('${p.id}','${p.image_url||''}')">Törlés</button>
      </div>
    </div>
  `).join('');
}

window.delProduct = async function(id, url){
  if(!confirm('Biztos törlöd?')) return;
  // próbáljuk a tárhelyről is törölni (ha az URL-ből ki tudjuk szedni az object path-ot)
  if(url && url.includes('/object/public/')){
    const path = url.split('/object/public/')[1];
    await sb.storage.from('products').remove([path]).catch(()=>{});
  }
  const { error } = await sb.from('products').delete().eq('id', id);
  if(error){ alert('Hiba: '+error.message); return; }
  await loadList();
}

// indulás
if(sessionStorage.getItem('adm')==='1') renderDashboard(); else renderLogin();
</script>
</body>
</html>

