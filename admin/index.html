<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Szőke Épker – Admin felület</title>
  <link rel="icon" href="/logo.png">
  <style>
    :root{
      --bg:#0b0f14; --card:#141b22; --muted:#7b8a97; --text:#e9eef2; --brand:#3fb3ff; --ok:#1ecb75; --danger:#ff7272;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0f1620);color:var(--text);font:500 15px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .top{display:flex;align-items:center;gap:14px;margin-bottom:22px}
    .logo{width:40px;height:40px;border-radius:10px;background:#000 url(/logo.png) center/contain no-repeat}
    h1{font-size:24px;margin:0}
    .card{background:var(--card);border:1px solid #1e2833;border-radius:var(--radius);padding:20px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:#1d2733;color:#fff;cursor:pointer}
    .btn.primary{background:var(--brand)}
    .btn.ghost{background:transparent;border:1px solid #293645}
    .btn.danger{background:var(--danger)}
    .row{display:flex;gap:12px;align-items:center}
    label{display:block;margin:10px 0 6px;color:#9fb1c2;font-size:13px}
    input[type="text"],input[type="number"],input[type="file"],textarea{
      width:100%;padding:12px 14px;border:1px solid #2a3746;border-radius:12px;background:#0f1620;color:#e9eef2;
    }
    textarea{min-height:110px;resize:vertical}
    .hint{color:var(--muted);font-size:13px}
    .list{margin-top:18px;display:grid;gap:12px}
    .item{display:grid;grid-template-columns:80px 1fr auto;gap:14px;align-items:center;padding:10px;border:1px solid #253140;border-radius:12px;background:#0e141c}
    .item img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #263140;background:#000}
    .price{color:#cfe7ff}
    .pill{font-size:12px;border:1px solid #314156;padding:4px 8px;border-radius:999px;color:#b9c8d6}
    .sep{height:1px;background:#192230;margin:18px 0}
    /* LOGIN */
    .center{min-height:100dvh;display:grid;place-items:center;padding:18px}
    .login{width:min(460px,92vw)}
    .login h2{margin:0 0 8px}
    .err{margin-top:10px;color:#ff9b9b}
    .right{display:flex;gap:10px;justify-content:flex-end}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .right{justify-content:flex-start} }
  </style>
</head>
<body>

<div class="wrap" id="app" hidden>
  <div class="top">
    <div class="logo" aria-hidden="true"></div>
    <h1>Szőke Épker – Admin felület</h1>
    <span class="pill" id="authInfo"></span>
    <div style="flex:1"></div>
    <button class="btn ghost" id="logoutBtn">Kijelentkezés</button>
  </div>

  <div class="card">
    <div class="grid">
      <!-- ÚJ TERMÉK -->
      <div>
        <h3 style="margin:0 0 8px">Új termék</h3>
        <p class="hint" style="margin:0 0 14px">Terméknév, ár, (opcionális) leírás, kép feltöltése. Mentés után azonnal megjelenik a webshopban.</p>
        <label>Termék neve *</label>
        <input id="pName" type="text" required placeholder="Pl. Zsák">

        <div class="row">
          <div style="flex:1">
            <label>Ár (Ft) *</label>
            <input id="pPrice" type="number" min="0" step="1" required placeholder="5000">
          </div>
          <div class="row" style="margin-top:28px">
            <input id="pInStock" type="checkbox" checked>
            <label for="pInStock" style="margin:0">Készleten</label>
          </div>
        </div>

        <label>Rövid leírás (markdown megengedett)</label>
        <textarea id="pDesc" placeholder="Rövid leírás…"></textarea>

        <label>Kép (jpg/png)</label>
        <input id="pFile" type="file" accept="image/*">

        <div class="row" style="margin-top:14px">
          <button class="btn primary" id="saveBtn">Mentés</button>
          <span id="saveMsg" class="hint"></span>
        </div>

        <div class="sep"></div>
        <div class="row">
          <button class="btn ghost" id="refreshBtn">Lista frissítése</button>
          <span class="hint">Legutóbbi 50 termék, törlés a listából.</span>
        </div>
      </div>

      <!-- LISTA -->
      <div>
        <h3 style="margin:0 0 8px">Legutóbbi termékek</h3>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN KÁRTYA -->
<div class="center" id="loginView">
  <div class="card login">
    <div class="row" style="align-items:center;gap:12px;margin-bottom:8px">
      <div class="logo" aria-hidden="true"></div>
      <h2>Bejelentkezés</h2>
    </div>

    <label>Felhasználónév</label>
    <input id="lu" type="text" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="">

    <label>Jelszó</label>
    <input id="lp" type="password" autocomplete="new-password" placeholder="">

    <div class="right" style="margin-top:12px">
      <button class="btn primary" id="loginBtn">Belépés</button>
    </div>
    <div id="lerr" class="err" hidden>Hibás jelszó vagy inaktív fiók.</div>
  </div>
</div>

<script type="module">
/** ====== Beállítások ====== **/
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";

/* FIX – gyors belépés (egyszerű, nem szerveroldali):
   A mezőkben NEM jelenik meg, csak a kódban szerepel. */
const USERNAME = "szokeadmin";
const PASSWORD = "szoke2025";

/** ====== Supabase kliens ====== **/
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/** ====== Elemek ====== **/
const loginView = document.querySelector("#loginView");
const app       = document.querySelector("#app");
const loginBtn  = document.querySelector("#loginBtn");
const luser     = document.querySelector("#lu");
const lpass     = document.querySelector("#lp");
const lerr      = document.querySelector("#lerr");

const nameEl    = document.querySelector("#pName");
const priceEl   = document.querySelector("#pPrice");
const descEl    = document.querySelector("#pDesc");
const fileEl    = document.querySelector("#pFile");
const inStockEl = document.querySelector("#pInStock");
const saveBtn   = document.querySelector("#saveBtn");
const saveMsg   = document.querySelector("#saveMsg");
const listWrap  = document.querySelector("#list");
const refreshBtn= document.querySelector("#refreshBtn");
const logoutBtn = document.querySelector("#logoutBtn");
const authInfo  = document.querySelector("#authInfo");

/** ====== Gyors login & session ====== **/
function isLogged(){ return localStorage.getItem("se_admin_session") === "ok_v1"; }
function loginOk(){
  localStorage.setItem("se_admin_session","ok_v1");
  loginView.hidden = true; app.hidden = false;
  authInfo.textContent = "Bejelentkezve";
  loadList();
}
function requireAuth(){
  if(isLogged()){ loginOk(); }
  else{ loginView.hidden = false; app.hidden = true; }
}
loginBtn?.addEventListener("click", ()=>{
  const u = (luser.value||"").trim();
  const p = lpass.value||"";
  if(u===USERNAME && p===PASSWORD){ lerr.hidden=true; loginOk(); }
  else{ lerr.hidden=false; }
});
logoutBtn?.addEventListener("click", ()=>{
  localStorage.removeItem("se_admin_session");
  location.reload();
});
requireAuth();

/** ====== Tároló: products bucket publikus olvasás, admin feltöltés ====== **/
const BUCKET = "products";

/** ====== Termék mentés ====== **/
saveBtn?.addEventListener("click", async ()=>{
  if(!isLogged()) return;
  const title = nameEl.value.trim();
  const price = parseInt(priceEl.value,10);
  const desc  = descEl.value.trim();
  const inStock = !!inStockEl.checked;

  if(!title || !(price>=0)){
    saveMsg.textContent = "Hiányzó név vagy ár.";
    return;
  }
  saveBtn.disabled = true; saveMsg.textContent = "Feltöltés…";

  try{
    // 1) kép feltöltés (ha választott)
    let image_url = null, objectName = null;
    const file = fileEl.files?.[0];
    if(file){
      const safeName = `${Date.now()}_${file.name.replace(/[^a-z0-9.\-_]/gi,"_")}`;
      objectName = `public/${safeName}`;
      const up = await supabase.storage.from(BUCKET).upload(objectName, file, { upsert:false });
      if(up.error) throw up.error;
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(objectName);
      image_url = data.publicUrl;
    }

    // 2) termék sor
    const ins = await supabase.from("products").insert({
      title, price, description: desc, in_stock: inStock, image_url
    }).select("id").single();
    if(ins.error) throw ins.error;

    // 3) űrlap ürítés + lista
    nameEl.value = ""; priceEl.value=""; descEl.value=""; fileEl.value=""; inStockEl.checked=true;
    saveMsg.textContent = "✔ Mentve!";
    loadList();
    setTimeout(()=> saveMsg.textContent="", 2000);
  }catch(e){
    console.error(e);
    saveMsg.textContent = "Hiba: " + (e?.message || e);
  }finally{
    saveBtn.disabled = false;
  }
});

refreshBtn?.addEventListener("click", loadList);

/** ====== Lista & törlés (kép + adat) ====== **/
async function loadList(){
  if(!isLogged()) return;
  listWrap.innerHTML = `<div class="hint">Betöltés…</div>`;
  const { data, error } = await supabase
    .from("products")
    .select("id,title,price,image_url,in_stock,created_at")
    .order("created_at", { ascending:false })
    .limit(50);
  if(error){ listWrap.innerHTML = `<div class="err">${error.message}</div>`; return; }
  if(!data?.length){ listWrap.innerHTML = `<div class="hint">Még nincs termék.</div>`; return; }

  listWrap.innerHTML = data.map(p=>{
    const img = p.image_url ? `<img src="${p.image_url}" alt="">` : `<div style="width:80px;height:80px;border:1px dashed #2a3746;border-radius:10px;display:grid;place-items:center;color:#44607a">N/A</div>`;
    return `
      <div class="item" data-id="${p.id}" data-img="${p.image_url||''}">
        ${img}
        <div>
          <div class="row" style="gap:8px;align-items:baseline">
            <strong>${escapeHTML(p.title||"Névtelen")}</strong>
            <span class="price">${fmt(p.price||0)}</span>
            ${p.in_stock ? `<span class="pill">készleten</span>` : `<span class="pill" style="border-color:#5a2e2e;color:#ffb0b0">nincs</span>`}
          </div>
          <div class="hint">${new Date(p.created_at).toLocaleString("hu-HU")}</div>
        </div>
        <div class="row">
          <button class="btn danger" data-del="${p.id}">Törlés</button>
        </div>
      </div>
    `;
  }).join("");
}

// delegált törlés
document.addEventListener("click", async (e)=>{
  const btn = e.target.closest?.("[data-del]");
  if(!btn || !isLogged()) return;
  const id = btn.getAttribute("data-del");
  const row = btn.closest(".item");
  const imgUrl = row?.getAttribute("data-img") || "";
  if(!confirm("Biztosan törlöd a terméket?")) return;

  btn.disabled = true; btn.textContent = "Törlés…";
  try{
    // 1) töröljük a DB rekordot
    const del = await supabase.from("products").delete().eq("id", id);
    if(del.error) throw del.error;

    // 2) ha volt kép, a storage-ból is töröljük
    if(imgUrl){
      const idx = imgUrl.indexOf("/storage/v1/object/public/"+BUCKET+"/");
      if(idx>-1){
        const path = imgUrl.substring(idx + ("/storage/v1/object/public/".length + BUCKET.length + 1));
        await supabase.storage.from(BUCKET).remove([path]);
      }
    }
    row.remove();
  }catch(err){
    alert("Törlés hiba: " + (err?.message || err));
    btn.disabled = false; btn.textContent = "Törlés";
  }
});

/** ====== Segédek ====== **/
function fmt(n){ return new Intl.NumberFormat("hu-HU").format(n||0) + " Ft"; }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])) }
</script>
</body>
</html>
