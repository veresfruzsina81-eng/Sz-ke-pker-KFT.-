<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Szőke Épker – Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{--ink:#1f2937;--muted:#6b7280;--bg:#f7f4ef;--card:#fff;--brand:#8b5e34;--ring:0 0 0 3px rgba(193,154,107,.25);--radius:16px;--bad:#e11d48}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:18px 14px}
.card{background:var(--card);border:1px solid #eee3d6;border-radius:var(--radius);padding:14px;box-shadow:0 12px 30px rgba(87,61,34,.05)}
h1{margin:0 0 8px} h2{margin:10px 0}
input,textarea,select{width:100%;border:1px solid #e7dbc8;background:#fff;padding:12px 14px;border-radius:12px;font:inherit}
input:focus,textarea:focus,select:focus{outline:none;box-shadow:var(--ring);border-color:#e0c9aa}
.btn{appearance:none;border:0;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff}
.btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
.btn.bad{background:var(--bad)}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tabs{display:flex;gap:8px;margin:10px 0}
.tab{padding:8px 12px;border-radius:999px;border:1px solid #eadfce;background:#fff;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr}
@media(min-width:900px){.grid-2{grid-template-columns:360px 1fr}}
.item{display:grid;grid-template-columns:80px 1fr auto;gap:10px;align-items:center;border:1px solid #eee3d6;border-radius:12px;padding:8px 10px}
.thumb{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #eee3d6;background:#f7f4ef}
.muted{color:var(--muted)}
.login{max-width:520px;margin:40px auto}
.hidden{display:none}

/* ÚJ: fix magasság, belső görgetés */
.panel{max-height:72vh; overflow:auto; border-radius:14px}
#plist .item + .item{margin-top:8px}
#olist .card + .card{margin-top:10px}
#rlist .item + .item{margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Login -->
  <div id="loginBox" class="card login">
    <div class="row" style="gap:10px;align-items:center;margin-bottom:6px">
      <img src="logo.png" alt="" style="height:28px"><h1 style="margin:0">Szőke Épker – Admin belépés</h1>
    </div>
    <div class="grid" style="gap:10px">
      <label>Felhasználónév<input id="u" placeholder="Felhasználónév"></label>
      <label>Jelszó<input id="p" type="password" placeholder="Jelszó"></label>
      <button id="loginBtn" type="button" class="btn">Belépés</button>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <h1>Admin felület</h1>
      <div class="row">
        <button class="btn ghost" type="button" onclick="location.href='/webshop.html'">Webshop megnyitása</button>
        <button class="btn" id="logoutBtn" type="button">Kijelentkezés</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="products" type="button">Termékek</button>
      <button class="tab" data-tab="orders" type="button">Rendelések</button>
      <button class="tab" data-tab="reviews" type="button">Vélemények</button>
    </div>

    <div id="tab-products">
      <div class="grid grid-2">
        <div class="card panel">
          <h2>Új termék</h2>
          <div class="grid" style="gap:10px">
            <input id="title" placeholder="Termék neve">
            <input id="price" type="number" placeholder="Ár (Ft)">
            <textarea id="desc" placeholder="Rövid leírás (markdown megengedett)"></textarea>
            <label class="muted">Kép (jpg/png)</label>
            <input id="file" type="file" accept="image/*">
            <label class="row" style="gap:8px"><input id="instock" type="checkbox" checked> Készleten</label>
            <button class="btn" id="addBtn" type="button">Hozzáadás</button>
            <div id="pInfo" class="muted"></div>
          </div>
        </div>

        <div class="card panel">
          <h2>Termékek</h2>
          <div id="plist"></div>
          <div id="pempty" class="muted">Nincs találat.</div>
        </div>
      </div>
    </div>

    <div id="tab-orders" class="hidden">
      <div class="card panel">
        <h2>Rendelések</h2>
        <div id="olist"></div>
        <div id="oempty" class="muted">Még nincs rendelés.</div>
      </div>
    </div>

    <div id="tab-reviews" class="hidden">
      <div class="card panel">
        <h2>Vélemények</h2>
        <div id="rlist"></div>
        <div id="rempty" class="muted">Még nincs vélemény.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Konstansok ===== */
const ADMIN_USER = "szokeadmin";
const ADMIN_PASS = "szoke2025";
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const BUCKET = "products";

let sb = null;
function ensureSB(){
  try{
    if(!sb && window.supabase){ sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }
  }catch(e){ console.warn("Supabase init hiba:", e); }
  return sb;
}

function setLogged(v){
  localStorage.setItem("szoke_admin", v?"1":"");
  document.getElementById("loginBox").classList.toggle("hidden", v);
  document.getElementById("app").classList.toggle("hidden", !v);
}

document.addEventListener("DOMContentLoaded", ()=>{
  if(localStorage.getItem("szoke_admin")==="1"){ setLogged(true); loadAll(); }

  document.getElementById("loginBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    const u = document.getElementById("u").value.trim();
    const p = document.getElementById("p").value.trim();
    if(u===ADMIN_USER && p===ADMIN_PASS){ setLogged(true); loadAll(); }
    else alert("Hibás felhasználónév vagy jelszó.");
  });

  document.getElementById("logoutBtn").addEventListener("click", ()=>{ setLogged(false); });

  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.getElementById("tab-products").classList.toggle("hidden", tab!=="products");
      document.getElementById("tab-orders").classList.toggle("hidden", tab!=="orders");
      document.getElementById("tab-reviews").classList.toggle("hidden", tab!=="reviews");
      if(tab==="orders") loadOrders();
      if(tab==="reviews") loadReviews();
    });
  });

  document.getElementById("addBtn").addEventListener("click", addProduct);
});

/* ===== Termékek ===== */
async function listProducts(){
  if(!ensureSB()) return alert("Supabase nem elérhető (script).");
  const {data,error}=await sb.from('products').select('id,title,price,instock,image_url').order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  const list=data||[];
  const wrap=document.getElementById("plist");
  wrap.innerHTML=list.map(p=>`
    <div class="item">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div>
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><strong>${p.title||'-'}</strong></div>
        <div class="muted">${new Intl.NumberFormat('hu-HU').format(p.price||0)} Ft • ${p.instock?'készleten':'nem elérhető'}</div>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" onclick="toggleStock('${p.id}', ${!!p.instock})">${p.instock?'Leállít':'Elérhetővé'}</button>
        <button class="btn bad" type="button" onclick="delProduct('${p.id}')">Törlés</button>
      </div>
    </div>`).join("");
  document.getElementById("pempty").style.display=list.length?"none":"block";
}
async function toggleStock(id, cur){
  if(!ensureSB()) return;
  const {error}=await sb.from('products').update({instock:!cur}).eq('id',id);
  if(error) return alert("Hiba: "+error.message);
  listProducts();
}
async function delProduct(id){
  if(!confirm("Biztos törlöd a terméket?")) return;
  if(!ensureSB()) return;
  const {error}=await sb.from('products').delete().eq('id',id);
  if(error) return alert("Hiba: "+error.message);
  listProducts();
}
async function addProduct(){
  if(!ensureSB()) return alert("Supabase nem elérhető (script).");
  const title=document.getElementById("title").value.trim();
  const price=parseInt(document.getElementById("price").value||"0",10);
  const description=document.getElementById("desc").value||"";
  const instock=document.getElementById("instock").checked;
  const file=document.getElementById("file").files[0];
  const info=document.getElementById("pInfo"); info.textContent="";

  if(!title || !price){ alert("Név és ár kötelező."); return; }

  let image_url=null;
  if(file){
    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const fname=`${crypto.randomUUID()}.${ext}`;
    const up=await sb.storage.from(BUCKET).upload(fname, file, {upsert:false});
    if(up.error){
      alert("Képfeltöltési hiba: "+up.error.message+"\n(Állíts be INSERT jogot a 'products' bucketre.)");
    }else{
      const { data } = sb.storage.from(BUCKET).getPublicUrl(fname);
      image_url=data.publicUrl;
    }
  }

  const ins=await sb.from('products').insert({title,price,description,instock,image_url}).select().single();
  if(ins.error){ alert("Hiba: "+ins.error.message); return; }
  document.getElementById("title").value=""; document.getElementById("price").value="";
  document.getElementById("desc").value=""; document.getElementById("file").value="";
  info.textContent="Mentve. ID: "+ins.data.id;
  listProducts();
}

/* ===== Rendelések ===== */
async function loadOrders(){
  if(!ensureSB()) return;
  const {data,error}=await sb.from('orders').select('id,created_at,name,email,phone,address,shipping,subtotal,shipping_cost,total,items').order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  const nf = (n)=>new Intl.NumberFormat('hu-HU').format(n||0);
  const list=data||[]; const box=document.getElementById("olist");
  box.innerHTML=list.map(o=>{
    const items=(o.items||[]).map(it=>`${it.title} × ${it.qty}`).join(", ");
    return `<div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>#${String(o.id).slice(0,8)}</strong>
        <div class="muted">${new Date(o.created_at).toLocaleString('hu-HU')}</div>
      </div>
      <div>${o.name} • ${o.email} • ${o.phone}</div>
      <div class="muted">Cím: ${o.address} • Szállítás: ${o.shipping||'-'}</div>
      <div class="muted">Tételek: ${items||'-'}</div>
      <div class="row" style="gap:10px;margin-top:6px;justify-content:space-between">
        <div><strong>Összesen: ${nf(o.total)} Ft</strong>
          <span class="muted">(Részösszeg ${nf(o.subtotal)} Ft + Szállítás ${nf(o.shipping_cost)} Ft)</span>
        </div>
        <button class="btn bad" type="button" onclick="deleteOrder('${o.id}')">Rendelés törlése</button>
      </div>
    </div>`;
  }).join("");
  document.getElementById("oempty").style.display=list.length?"none":"block";
}
async function deleteOrder(id){
  if(!confirm("Biztos törlöd a rendelést?")) return;
  const {error}=await sb.from('orders').delete().eq('id',id);
  if(error){ alert("Hiba: "+error.message); return; }
  loadOrders();
}

/* ===== Vélemények ===== */
async function loadReviews(){
  if(!ensureSB()) return;
  const {data,error}=await sb.from('reviews').select('id,created_at,username,text,rating,product_id').order('created_at',{ascending:false});
  if(error){ console.error(error); return alert("Hiba: "+error.message); }
  const list=data||[]; const box=document.getElementById("rlist");
  box.innerHTML=list.map(r=>`
    <div class="item" style="grid-template-columns:1fr auto">
      <div>
        <div><strong>${r.username||'Névtelen'}</strong> ${r.rating?`<span class="muted">• ${"★".repeat(r.rating)}</span>`:''}</div>
        <div class="muted" style="font-size:13px">${new Date(r.created_at).toLocaleString('hu-HU')}</div>
        <div>${r.text}</div>
      </div>
      <button class="btn bad" type="button" onclick="delReview('${r.id}')">Törlés</button>
    </div>`).join("");
  document.getElementById("rempty").style.display=list.length?"none":"block";
}
async function delReview(id){
  if(!confirm("Biztos törlöd a véleményt?")) return;
  const {error}=await sb.from('reviews').delete().eq('id',id);
  if(error) return alert("Hiba: "+error.message);
  loadReviews();
}

function loadAll(){ ensureSB(); listProducts(); }
</script>
</body>
</html>
