<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Webshop ‚Äì Sz≈ëke √âpker</title>
<link rel="icon" href="/logo.png">
<link rel="stylesheet" href="/styles.css">
<style>
  :root{--brand:#0ea5e9;--ink:#1f2937}
  body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0;color:var(--ink);background:#fbfbfd}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #eee}
  .container{max-width:1100px;margin:auto;padding:16px}
  .grid{display:grid;gap:16px}
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  input[type=search],select{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff}
  .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
  .card{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .card img{width:100%;height:200px;object-fit:cover}
  .card h3{font-size:16px;margin:10px 12px 4px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:0 12px 12px}
  .price{font-weight:700}
  .btn{border:0;background:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff}
  .pill{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:2px 8px;font-size:12px}
  /* Cart */
  .cart{position:fixed;top:64px;right:16px;width:360px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.08);padding:12px;z-index:30;display:none}
  .cart.on{display:block}
  .cart h4{margin:6px 0 10px}
  .cart-item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border-bottom:1px solid #f1f1f1;padding:8px 0}
  .cart-item img{width:56px;height:56px;object-fit:cover;border-radius:8px}
  .checkout{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:40}
  .checkout.on{display:grid;place-items:center}
  .panel{background:#fff;border-radius:16px;padding:16px;max-width:720px;width:100%;max-height:85vh;overflow:auto}
  .panel h3{margin-top:0}
  .x{float:right;border:0;background:transparent;font-size:22px;cursor:pointer}
  .sumrow{display:flex;justify-content:space-between;margin-top:6px}
  .muted{color:#6b7280}
  a{color:var(--brand);text-decoration:none}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div class="row"><img src="/logo.png" alt="" style="height:36px"><strong>Webshop</strong></div>
    <button id="cartBtn" class="btn">üõí <span id="cc">0</span></button>
  </div>
</header>

<main class="container">
  <p class="muted">Keres√©s √©s rendez√©s</p>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶">
    <select id="sort">
      <option value="new">Leg√∫jabb</option>
      <option value="name">N√©v szerint</option>
      <option value="cheap">Olcs√≥bb el≈ël</option>
      <option value="exp">Dr√°g√°bb el≈ël</option>
    </select>
  </div>
  <div id="grid" class="products"></div>
</main>

<!-- CART -->
<div class="cart" id="cart">
  <h4>Kos√°r</h4>
  <div id="cartItems"></div>
  <div class="sumrow"><span>R√©sz√∂sszeg</span><strong id="sub">0 Ft</strong></div>
  <div class="sumrow muted" id="fs"></div>
  <button class="btn primary" id="goCheckout" style="margin-top:10px">Tov√°bb a p√©nzt√°rhoz</button>
</div>

<!-- CHECKOUT -->
<div class="checkout" id="checkout">
  <div class="panel">
    <button class="x" id="closeCO">√ó</button>
    <h3>Rendel√©s lead√°sa</h3>
    <form id="coForm" class="grid" style="grid-template-columns:1fr 1fr">
      <label><span>N√©v</span><input name="name" required></label>
      <label><span>E-mail</span><input type="email" name="email" required></label>
      <label><span>Telefon</span><input name="phone" required></label>
      <label style="grid-column:1/-1"><span>Sz√°ll√≠t√°si c√≠m</span><input name="address" required></label>
      <label><span>Sz√°ll√≠t√°s</span>
        <select name="shipping" id="shipSel"><option>H√°zhozsz√°ll√≠t√°s</option><option>Szem√©lyes √°tv√©tel</option></select>
      </label>
      <label style="grid-column:1/-1"><span>Megjegyz√©s</span><textarea name="note" rows="3"></textarea></label>
      <div style="grid-column:1/-1">
        <div id="summary"></div>
        <div class="sumrow"><span>V√©g√∂sszeg</span><strong id="tot">0 Ft</strong></div>
      </div>
      <button class="btn primary" type="submit" style="grid-column:1/-1">Rendel√©s lead√°sa</button>
    </form>
  </div>
</div>

<script type="module">
const SUPABASE_URL="https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const sb = createClient(SUPABASE_URL,SUPABASE_ANON);

// ---- helpers
const fmt = n=> (n||0).toLocaleString("hu-HU")+" Ft";
const cartKey="cart_v1";
let cart = JSON.parse(localStorage.getItem(cartKey)||"[]");
function saveCart(){localStorage.setItem(cartKey,JSON.stringify(cart)); renderCart();}

const grid=document.getElementById("grid");
const q=document.getElementById("q"); const sort=document.getElementById("sort");

let PRODUCTS=[];
async function load(){
  const {data} = await sb.from("products").select("*").eq("instock", true).order("id",{ascending:false});
  PRODUCTS=data||[];
  render();
}
function render(){
  let list=[...PRODUCTS];
  const s=(q.value||"").toLowerCase();
  if(s) list=list.filter(p=>p.title?.toLowerCase().includes(s) || (p.description||"").toLowerCase().includes(s));
  switch(sort.value){
    case "name": list.sort((a,b)=>(a.title||"").localeCompare(b.title||"","hu")); break;
    case "cheap": list.sort((a,b)=>(a.price||0)-(b.price||0)); break;
    case "exp": list.sort((a,b)=>(b.price||0)-(a.price||0)); break;
  }
  grid.innerHTML=list.map(p=>`
    <article class="card">
      <a href="/product.html?id=${p.id}" title="Megnyit√°s"><img src="${p.image_url||'/logo.png'}" alt=""></a>
      <h3><a href="/product.html?id=${p.id}">${p.title||''}</a></h3>
      <div class="row">
        <span class="price">${fmt(p.price||0)}</span>
        <button class="btn primary" data-add="${p.id}">Kos√°rba</button>
      </div>
    </article>`).join("");
}
q.oninput=render; sort.onchange=render;

grid.addEventListener("click",(e)=>{
  const id=e.target.dataset.add; if(!id) return;
  const p=PRODUCTS.find(x=>x.id==id); if(!p) return;
  const it=cart.find(x=>x.id==id); if(it) it.qty++; else cart.push({id:p.id,title:p.title,price:p.price,img:p.image_url,qty:1});
  saveCart();
});

// ---- cart
const cartBox=document.getElementById("cart"), cc=document.getElementById("cc"), itemsEl=document.getElementById("cartItems"), subEl=document.getElementById("sub"), fs=document.getElementById("fs");
function subtotal(){return cart.reduce((s,x)=>s+x.price*x.qty,0);}
function shippingCost(sub){return sub>=30000?0:1490;}
function renderCart(){
  cc.textContent=cart.reduce((s,x)=>s+x.qty,0);
  itemsEl.innerHTML = cart.length? cart.map(x=>`
    <div class="cart-item">
      <img src="${x.img||'/logo.png'}"><div><div>${x.title}</div>
      <div class="muted">${fmt(x.price)}</div>
      <div class="row"><button class="btn" data-dec="${x.id}">‚àí</button><span>${x.qty}</span><button class="btn" data-inc="${x.id}">+</button><button class="btn" data-del="${x.id}">T√∂rl√©s</button></div></div>
      <strong>${fmt(x.price*x.qty)}</strong>
    </div>`).join("") : `<p class="muted">√úres a kos√°r.</p>`;
  const sub=subtotal(); subEl.textContent=fmt(sub);
  const sc=shippingCost(sub); fs.textContent = sc?`Sz√°ll√≠t√°s: ${fmt(sc)} ¬∑ 30 000 Ft felett ingyenes`:`üéâ Ingyenes sz√°ll√≠t√°s`;
}
itemsEl.addEventListener("click",e=>{
  const id=e.target.dataset.inc||e.target.dataset.dec||e.target.dataset.del; if(!id) return;
  const it=cart.find(x=>x.id==id); if(!it) return;
  if(e.target.dataset.inc) it.qty++;
  if(e.target.dataset.dec) it.qty=Math.max(1,it.qty-1);
  if(e.target.dataset.del) cart=cart.filter(x=>x.id!=id);
  saveCart();
});

document.getElementById("cartBtn").onclick=()=> cartBox.classList.toggle("on");

// ---- checkout
const checkout=document.getElementById("checkout");
document.getElementById("goCheckout").onclick=()=>{renderSummary(); checkout.classList.add("on");}
document.getElementById("closeCO").onclick=()=> checkout.classList.remove("on");
document.getElementById("shipSel").onchange=renderSummary;
function renderSummary(){
  const box=document.getElementById("summary");
  const sub=subtotal(), ship=shippingCost(sub), tot=sub+ship;
  box.innerHTML = `<ul>${cart.map(x=>`<li>${x.title} √ó ${x.qty} ‚Äì ${fmt(x.price*x.qty)}</li>`).join("")}</ul>
                   <div class="sumrow"><span>Sz√°ll√≠t√°s</span><strong>${fmt(ship)}</strong></div>`;
  document.getElementById("tot").textContent=fmt(tot);
}
document.getElementById("coForm").onsubmit = async (e)=>{
  e.preventDefault();
  if(!cart.length){ alert("A kos√°r √ºres.");return; }
  const fd = Object.fromEntries(new FormData(e.target).entries());
  const sub=subtotal(), ship=shippingCost(sub), tot=sub+ship;
  const payload={created_at:new Date().toISOString(),name:fd.name,email:fd.email,phone:fd.phone,address:fd.address,shipping:fd.shipping,note:fd.note||"",items:cart,subtotal:sub,shipping_cost:ship,total:tot};
  const { error } = await sb.from("orders").insert(payload);
  if(error){ alert("Hiba: "+error.message); return; }
  alert("K√∂sz√∂nj√ºk! Rendel√©s r√∂gz√≠tve.");
  cart=[]; saveCart(); checkout.classList.remove("on");
};

renderCart(); load();
</script>
</body>
</html>
