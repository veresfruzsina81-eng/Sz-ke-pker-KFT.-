<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Szőke Épker Webshop</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{--ink:#1f2937;--muted:#6b7280;--bg:#f7f4ef;--card:#fff;--brand:#8b5e34;--ring:0 0 0 3px rgba(193,154,107,.25);--radius:16px;--bad:#e11d48}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;background:#fff;border-bottom:1px solid #eee3d6;position:sticky;top:0;z-index:50}
.header .brand{display:flex;align-items:center;gap:10px;font-weight:800}
.header .brand img{height:26px}
.container{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{background:var(--card);border:1px solid #eee3d6;border-radius:14px;padding:12px;box-shadow:0 10px 24px rgba(87,61,34,.05)}
.card img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid #eee3d6;background:#f7f4ef}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff}
.btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
.muted{color:var(--muted)}

/* Kosár (jobb oldali fiók) */
.cart{position:fixed;right:0;top:0;height:100vh;width:420px;max-width:95vw;background:#fff;border-left:1px solid #eee3d6;box-shadow:-20px 0 40px rgba(0,0,0,.08);transform:translateX(100%);transition:transform .25s ease;z-index:60;display:flex;flex-direction:column}
.cart.open{transform:translateX(0)}
.cart .top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee3d6}
.cart .body{padding:12px 14px;overflow:auto;flex:1}
.cart .foot{padding:12px 14px;border-top:1px solid #eee3d6;background:#faf7f2;position:sticky;bottom:0}

/* Termék modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:70;padding:14px}
.modal.open{display:flex}
.modal>.card{max-width:900px;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:800px){.modal>.card{grid-template-columns:1fr}}

.qty{display:inline-flex;align-items:center;border:1px solid #eadfce;border-radius:12px}
.qty button{background:#fff;color:var(--ink);border:0;padding:6px 10px;cursor:pointer}
.qty input{width:48px;text-align:center;border:0}
.itemline{display:grid;grid-template-columns:60px 1fr auto;align-items:center;gap:10px;border:1px solid #eee3d6;border-radius:12px;padding:8px 10px}
.itemline img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee3d6}
.itemline .title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
<header class="header">
  <div class="brand"><img src="logo.png" alt=""><span>Szőke-Épker Kft.</span></div>
  <div class="row">
    <button class="btn ghost" onclick="location.href='/'">Vissza a főoldalra</button>
    <button class="btn" onclick="openCart()">Kosár (<span id="cartCount">0</span>)</button>
  </div>
</header>

<main class="container">
  <div class="row" style="justify-content:space-between;margin-bottom:10px">
    <h2 style="margin:0">Webshop</h2>
    <div class="row">
      <input id="search" placeholder="Keresés a termékek közt…" style="padding:10px 12px;border:1px solid #eadfce;border-radius:12px;width:260px;max-width:60vw">
      <select id="sort" style="padding:10px 12px;border:1px solid #eadfce;border-radius:12px">
        <option value="new">Legújabb</option>
        <option value="price_asc">Ár ↑</option>
        <option value="price_desc">Ár ↓</option>
      </select>
    </div>
  </div>

  <div id="list" class="grid"></div>
  <div id="empty" class="muted">Nincs találat.</div>
</main>

<!-- Kosár fiók -->
<aside id="cart" class="cart" aria-hidden="true">
  <div class="top"><strong>Kosár</strong><button class="btn ghost" onclick="closeCart()">✕</button></div>
  <div class="body" id="cartBody"></div>
  <div class="foot">
    <div class="row" style="justify-content:space-between">
      <strong>Összesen: <span id="sum">0</span> Ft</strong>
      <button class="btn" onclick="showCheckout()">Megrendelés</button>
    </div>
    <!-- Checkout űrlap -->
    <div id="chk" style="margin-top:10px;display:none">
      <div class="grid" style="gap:8px">
        <input id="c_name" placeholder="Név">
        <input id="c_email" placeholder="Email">
        <input id="c_phone" placeholder="Telefon">
        <input id="c_addr" placeholder="Cím">
        <input id="c_ship" placeholder="Szállítás módja (pl. futár)">
        <textarea id="c_note" placeholder="Megjegyzés" rows="3"></textarea>
        <button class="btn" onclick="sendOrder()">Rendelés elküldése</button>
      </div>
    </div>
  </div>
</aside>

<!-- Termék modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="card">
    <img id="m_img" src="" alt="">
    <div>
      <div class="row" style="justify-content:space-between">
        <h3 id="m_title" style="margin:0"></h3>
        <button class="btn ghost" onclick="closeModal()">✕</button>
      </div>
      <div class="muted" id="m_price" style="margin:6px 0"></div>
      <div id="m_desc" class="muted" style="white-space:pre-wrap"></div>
      <div class="row" style="margin-top:12px">
        <div class="qty">
          <button onclick="changeModalQty(-1)">−</button>
          <input id="m_qty" value="1">
          <button onclick="changeModalQty(1)">+</button>
        </div>
        <button class="btn" onclick="addFromModal()">Kosárba</button>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let products = [];
let filtered = [];
let cart = []; // {id,title,price,qty,image_url}

function nf(n){ return new Intl.NumberFormat('hu-HU').format(n||0); }

async function loadProducts(){
  const {data,error} = await sb.from('products').select('id,title,price,description,instock,image_url').eq('instock',true).order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  products = data||[];
  filtered = [...products];
  renderList();
}

function renderList(){
  const wrap = document.getElementById('list');
  wrap.innerHTML = filtered.map(p=>`
    <div class="card">
      <img src="${p.image_url||'logo.png'}" alt="">
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div style="min-width:0">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.title}</div>
          <div class="muted">${nf(p.price)} Ft</div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" onclick="openModal('${p.id}')">Megnyitás</button>
        <button class="btn" onclick="addToCart('${p.id}',1,true)">Kosárba</button>
      </div>
    </div>
  `).join('');
  document.getElementById('empty').style.display = filtered.length ? 'none':'block';
}

document.getElementById('search').addEventListener('input', e=>{
  const q = e.target.value.toLowerCase();
  filtered = products.filter(p=> (p.title||'').toLowerCase().includes(q));
  renderList();
});
document.getElementById('sort').addEventListener('change', e=>{
  const v = e.target.value;
  if(v==='price_asc') filtered.sort((a,b)=> (a.price||0)-(b.price||0));
  else if(v==='price_desc') filtered.sort((a,b)=> (b.price||0)-(a.price||0));
  else filtered.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  renderList();
});

/* ===== Modal ===== */
let modalProd=null;
function openModal(id){
  modalProd = products.find(p=>p.id===id);
  if(!modalProd) return;
  document.getElementById('m_img').src = modalProd.image_url||'logo.png';
  document.getElementById('m_title').textContent = modalProd.title;
  document.getElementById('m_price').textContent = nf(modalProd.price)+' Ft';
  document.getElementById('m_desc').textContent = modalProd.description||'Nincs leírás.';
  document.getElementById('m_qty').value=1;
  document.getElementById('modal').classList.add('open');
}
function closeModal(){ document.getElementById('modal').classList.remove('open'); }
function changeModalQty(d){
  const el = document.getElementById('m_qty');
  let q = parseInt(el.value||'1',10)+d;
  if(q<1) q=1; el.value=q;
}
function addFromModal(){
  const q = parseInt(document.getElementById('m_qty').value||'1',10);
  addToCart(modalProd.id, q, true);
  closeModal();
}

/* ===== Kosár ===== */
function openCart(){ document.getElementById('cart').classList.add('open'); }
function closeCart(){ document.getElementById('cart').classList.remove('open'); }

function addToCart(id, qty=1, open=true){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const i = cart.findIndex(x=>x.id===id);
  if(i>-1) cart[i].qty += qty; else cart.push({id:p.id,title:p.title,price:p.price,qty:qty,image_url:p.image_url});
  renderCart();
  if(open) openCart();
}
function changeQty(id, d){
  const i = cart.findIndex(x=>x.id===id); if(i<0) return;
  cart[i].qty += d;
  if(cart[i].qty<1) cart.splice(i,1);
  renderCart();
}
function removeLine(id){
  cart = cart.filter(x=>x.id!==id);
  renderCart();
}
function renderCart(){
  const body = document.getElementById('cartBody');
  if(cart.length===0){ body.innerHTML = '<div class="muted">A kosár üres.</div>'; }
  else{
    body.innerHTML = cart.map(c=>`
      <div class="itemline">
        <img src="${c.image_url||'logo.png'}" alt="">
        <div>
          <div class="title">${c.title}</div>
          <div class="muted">${nf(c.price)} Ft</div>
          <div class="qty" style="margin-top:6px">
            <button onclick="changeQty('${c.id}',-1)">−</button>
            <input value="${c.qty}" disabled>
            <button onclick="changeQty('${c.id}',1)">+</button>
          </div>
        </div>
        <div style="text-align:right">
          <div><strong>${nf(c.price*c.qty)} Ft</strong></div>
          <button class="btn ghost" onclick="removeLine('${c.id}')">Eltávolítás</button>
        </div>
      </div>
    `).join('');
  }
  const sum = cart.reduce((s,x)=>s+x.price*x.qty,0);
  document.getElementById('sum').textContent = nf(sum);
  document.getElementById('cartCount').textContent = cart.reduce((s,x)=>s+x.qty,0);
}

function showCheckout(){
  if(cart.length===0){ alert('A kosár üres.'); return; }
  document.getElementById('chk').style.display='block';
}

/* ===== Rendelés mentés Supabase-be ===== */
async function sendOrder(){
  if(cart.length===0){ alert('A kosár üres.'); return; }
  const name = document.getElementById('c_name').value.trim();
  const email= document.getElementById('c_email').value.trim();
  const phone= document.getElementById('c_phone').value.trim();
  const addr = document.getElementById('c_addr').value.trim();
  const ship = document.getElementById('c_ship').value.trim();
  const note = document.getElementById('c_note').value.trim();
  if(!name||!email||!phone||!addr){ alert('Kérjük, tölts ki minden mezőt.'); return; }

  const subtotal = cart.reduce((s,x)=>s+x.price*x.qty,0);
  const shipping_cost = 0;
  const total = subtotal+shipping_cost;

  const payload = {
    name,email,phone,address:addr,shipping:ship||'Ismeretlen',note,
    items: cart.map(c=>({id:c.id,title:c.title,price:c.price,qty:c.qty})),
    subtotal,shipping_cost,total
  };
  const {error} = await sb.from('orders').insert(payload);
  if(error){ alert('Hiba: '+error.message); return; }

  cart=[]; renderCart();
  document.getElementById('chk').style.display='none';
  alert('Köszönjük! A rendelést rögzítettük.');
  closeCart();
}

document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>
