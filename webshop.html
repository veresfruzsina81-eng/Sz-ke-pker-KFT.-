<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sz≈ëke √âpker Webshop</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fafafb;--card:#fff;--ink:#0b1220;--muted:#6b7280;--brand:#0ea5e9;--ok:#10b981;--bd:#e5e7eb;--shadow:0 6px 24px rgba(16,20,24,.06);
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}
.header{background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
.header-inner{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:14px 20px}
.header img{height:32px}
.header .spacer{flex:1}
.btn{border:1px solid var(--bd);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.container{max-width:1100px;margin:0 auto;padding:22px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
.input,.select{border:1px solid var(--bd);background:#fff;border-radius:12px;padding:10px 12px;font:inherit}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--bd);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
.card img{width:100%;height:210px;object-fit:cover}
.card .pad{padding:12px}
.price{font-weight:700}
.badge{display:inline-block;background:#eef2f7;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px;color:#334155}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.muted{color:var(--muted);font-size:13px}

/* Cart drawer */
.cart{position:fixed;right:0;top:0;height:100%;width:min(440px,92vw);background:#fff;border-left:1px solid var(--bd);box-shadow:var(--shadow);transform:translateX(100%);transition:.25s;display:flex;flex-direction:column;z-index:50}
.cart.open{transform:none}
.cart .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--bd)}
.cart .items{flex:1;overflow:auto}
.item{display:flex;gap:10px;border-bottom:1px solid var(--bd);padding:10px 12px}
.item img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--bd)}
.item .qty button{border:1px solid var(--bd);background:#fff;border-radius:8px;padding:4px 8px;margin:0 4px}

/* Modal (term√©k r√©szletek + v√©lem√©nyek) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
.modal.on{display:flex}
.sheet{width:min(900px,96vw);background:#fff;border-radius:16px;border:1px solid var(--bd);box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 1fr}
@media(max-width:900px){.sheet{grid-template-columns:1fr}}
.sheet img{width:100%;height:100%;object-fit:cover;border-right:1px solid var(--bd)}
.sheet .body{padding:18px}
.rate{display:flex;gap:6px;margin:6px 0 10px}
.star{font-size:20px;cursor:pointer}
.toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(12px);transition:.25s;z-index:80}
.toast.on{opacity:1;transform:translateY(0)}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <img src="logo.png" onerror="this.src='logl.png'" alt="">
    <strong>Sz≈ëke √âpker Webshop</strong>
    <span class="spacer"></span>
    <button class="btn" onclick="history.back()">‚¨Ö Vissza</button>
    <button class="btn" id="openCart">üõí Kos√°r <span id="cCount" class="badge">0</span></button>
  </div>
</header>

<div class="container">
  <h2 style="margin:0 0 6px">Webshop</h2>
  <div class="toolbar">
    <input id="q" class="input" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶">
    <select id="sort" class="select">
      <option value="latest">Leg√∫jabb</option>
      <option value="price-asc">√År szerint (n√∂v.)</option>
      <option value="price-desc">√År szerint (cs√∂kk.)</option>
      <option value="name-asc">N√©v szerint (A‚ÄìZ)</option>
      <option value="name-desc">N√©v szerint (Z‚ÄìA)</option>
    </select>
  </div>
  <div id="grid" class="grid"></div>
  <p id="empty" class="muted" style="display:none">M√©g nincsenek term√©kek.</p>
</div>

<!-- CART -->
<aside class="cart" id="cart">
  <div class="head"><strong>Kos√°r</strong><button class="btn" id="closeCart">‚úï</button></div>
  <div class="items" id="cartItems"></div>
  <div style="padding:12px;border-top:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center">
    <div>Fizetend≈ë: <strong id="sum">0 Ft</strong></div>
    <button class="btn primary" id="checkoutBtn">Megrendel√©s</button>
  </div>
</aside>

<!-- PRODUCT MODAL -->
<div class="modal" id="modal">
  <div class="sheet">
    <img id="mImg" alt="">
    <div class="body">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="mTitle" style="margin:0"></h3>
        <button class="btn" id="mClose">‚úï</button>
      </div>
      <div class="muted" id="mAvail"></div>
      <div style="margin:10px 0" class="price" id="mPrice"></div>
      <div id="mDesc" style="white-space:pre-wrap"></div>

      <div style="display:flex;gap:8px;align-items:center;margin:14px 0">
        <button class="btn primary" id="mAdd">Kos√°rba</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--bd);margin:12px 0">

      <h4 style="margin:0 0 6px">V√©lem√©nyek</h4>
      <div id="revList" class="muted" style="margin-bottom:8px">M√©g nincs v√©lem√©ny.</div>

      <div class="badge" style="margin:8px 0">√çrj v√©lem√©nyt</div>
      <input id="rvName" class="input" placeholder="N√©v">
      <div class="rate" id="rvStars"></div>
      <textarea id="rvText" class="input" placeholder="V√©lem√©ny‚Ä¶" style="min-height:80px"></textarea>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="sendRev">K√ºld√©s</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/** Supabase */
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
if(!window.supabase){await new Promise(r=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";s.onload=r;document.head.appendChild(s);});}
const sb = supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/** UI helpers */
const $=s=>document.querySelector(s);
const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("on");setTimeout(()=>t.classList.remove("on"),1800);}
const fmt=n=> (n||0).toLocaleString('hu-HU')+" Ft";

/** State */
let products=[], filtered=[];
const CART_KEY='shop_cart_v2'; let cart=JSON.parse(localStorage.getItem(CART_KEY)||"[]");
const updateCartUI=()=>{
  $("#cCount").textContent=String(cart.reduce((s,x)=>s+x.qty,0));
  const list=$("#cartItems"); list.innerHTML = cart.map(x=>`
    <div class="item">
      <img src="${x.img||'logo.png'}" alt="">
      <div style="flex:1">
        <div style="font-weight:600">${x.title}</div>
        <div class="muted">${fmt(x.price)}</div>
        <div class="qty"><button data-dec="${x.id}">‚Äì</button><span>${x.qty}</span><button data-inc="${x.id}">+</button></div>
      </div>
      <div><strong>${fmt(x.price*x.qty)}</strong><div><button class="btn" data-del="${x.id}">T√∂rl√©s</button></div></div>
    </div>`).join("") || `<div class="muted" style="padding:12px">√úres a kos√°r.</div>`;
  $("#sum").textContent = fmt(cart.reduce((s,x)=>s+x.price*x.qty,0));
};
const saveCart=()=>{localStorage.setItem(CART_KEY,JSON.stringify(cart));updateCartUI();}

/** Load products */
async function load(){
  const { data, error } = await sb.from("products").select("id,title,price,instock,image_url,description,created_at").order("created_at",{ascending:false});
  if(error){ console.error(error); $("#empty").style.display='block'; return; }
  products=data||[]; filtered=[...products]; render();
}
function render(){
  const g=$("#grid");
  g.innerHTML = filtered.map(p=>`
    <article class="card">
      <img src="${p.image_url||'logo.png'}" alt="">
      <div class="pad">
        <a href="#" class="title" data-open="${p.id}" style="font-weight:700">${p.title||'‚Äî'}</a>
        <div class="muted">${p.instock?'K√©szleten':'Nem el√©rhet≈ë'}</div>
        <div class="footer">
          <div class="price">${fmt(p.price)}</div>
          <button class="btn primary" data-add="${p.id}" ${p.instock?'':'disabled'}>Kos√°rba</button>
        </div>
      </div>
    </article>`).join("");
  $("#empty").style.display = filtered.length? 'none' : 'block';
}
$("#q")?.addEventListener("input", e=>{
  const q=e.target.value.toLowerCase().trim();
  filtered = products.filter(p=> !q || (p.title||"").toLowerCase().includes(q));
  render();
});
$("#sort")?.addEventListener("change", e=>{
  const v=e.target.value;
  if(v==="price-asc") filtered.sort((a,b)=>a.price-b.price);
  else if(v==="price-desc") filtered.sort((a,b)=>b.price-a.price);
  else if(v==="name-asc") filtered.sort((a,b)=> (a.title||"").localeCompare(b.title||"",'hu'));
  else if(v==="name-desc") filtered.sort((a,b)=> (b.title||"").localeCompare(a.title||"",'hu'));
  else filtered.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  render();
});

/** Cart events */
document.addEventListener("click", (e)=>{
  const t=e.target;
  if(t.id==="openCart") $("#cart").classList.add("open");
  if(t.id==="closeCart") $("#cart").classList.remove("open");
  if(t.matches("[data-add]")){
    const id=t.getAttribute("data-add"); const p=products.find(x=>String(x.id)===String(id));
    if(!p) return; const it=cart.find(x=>x.id==id);
    if(it) it.qty++; else cart.push({id:p.id,title:p.title,price:p.price,qty:1,img:p.image_url});
    saveCart(); toast("Hozz√°adva a kos√°rhoz");
  }
  if(t.matches("[data-inc]")){ const it=cart.find(x=>x.id==t.getAttribute("data-inc")); if(it){it.qty++; saveCart();} }
  if(t.matches("[data-dec]")){ const it=cart.find(x=>x.id==t.getAttribute("data-dec")); if(it){it.qty=Math.max(1,it.qty-1); saveCart();} }
  if(t.matches("[data-del]")){ cart=cart.filter(x=>x.id!=t.getAttribute("data-del")); saveCart(); }
  if(t.matches(".title,[data-open]")){ e.preventDefault(); const id=(t.getAttribute("data-open")||t.closest("[data-open]")?.getAttribute("data-open")); openModal(id); }
});

$("#checkoutBtn")?.addEventListener("click", ()=>{
  alert("A p√©nzt√°r ≈±rlap a kor√°bbihoz hasonl√≥an bek√∂thet≈ë (Netlify/Supabase Orders). Most csak minta gomb.");
});

/** Modal + reviews */
const starsWrap=$("#rvStars"); let selStars=5; for(let i=1;i<=5;i++){const b=document.createElement("span");b.textContent="‚òÜ";b.className="star";b.dataset.v=i;starsWrap.appendChild(b);}
starsWrap.addEventListener("click", e=>{ if(e.target.classList.contains("star")){ selStars=+e.target.dataset.v; [...starsWrap.children].forEach((s,i)=> s.textContent = (i<selStars)?"‚òÖ":"‚òÜ"); }});

let current=null;
async function openModal(id){
  const p=products.find(x=>String(x.id)===String(id)); if(!p) return;
  current=p; $("#mImg").src=p.image_url||'logo.png'; $("#mTitle").textContent=p.title||""; $("#mPrice").textContent=fmt(p.price||0);
  $("#mAvail").textContent = p.instock ? "K√©szleten" : "Nem el√©rhet≈ë"; $("#mDesc").textContent = p.description||"";
  $("#modal").classList.add("on"); loadProductReviews(p.id);
}
$("#mClose")?.addEventListener("click", ()=> $("#modal").classList.remove("on"));
$("#mAdd")?.addEventListener("click", ()=>{ if(!current) return; const it=cart.find(x=>x.id==current.id); if(it) it.qty++; else cart.push({id:current.id,title:current.title,price:current.price,qty:1,img:current.image_url}); saveCart(); toast("Hozz√°adva"); });

async function loadProductReviews(pid){
  const box=$("#revList"); box.textContent="Bet√∂lt√©s‚Ä¶";
  const { data, error } = await sb.from("reviews").select("username,stars,text,created_at").eq("product_id", pid).order("created_at",{ascending:false});
  if(error){ box.textContent="Nem √©rhet≈ëk el a v√©lem√©nyek."; return; }
  if(!data?.length){ box.textContent="M√©g nincs v√©lem√©ny."; return; }
  box.innerHTML = data.map(r=>`
    <div style="border:1px solid var(--bd);border-radius:12px;padding:10px;margin:8px 0;background:#fff">
      <div style="display:flex;justify-content:space-between">
        <strong>${r.username||"Vend√©g"}</strong>
        <span>${"‚òÖ".repeat(+r.stars||0)}${"‚òÜ".repeat(5-(+r.stars||0))}</span>
      </div>
      <div class="muted" style="font-size:12px">${new Date(r.created_at).toLocaleString('hu-HU')}</div>
      <div style="margin-top:6px;white-space:pre-wrap">${r.text||""}</div>
    </div>`).join("");
}
$("#sendRev")?.addEventListener("click", async ()=>{
  if(!current) return;
  const username=$("#rvName").value.trim()||"Vend√©g";
  const text=$("#rvText").value.trim();
  const stars=selStars||5;
  const { error } = await sb.from("reviews").insert({ product_id: current.id, username, text, stars });
  if(error){ alert("Nem siker√ºlt elk√ºldeni: "+error.message); return; }
  $("#rvName").value=""; $("#rvText").value=""; selStars=5; [...$("#rvStars").children].forEach((s,i)=> s.textContent = (i<5)?"‚òÖ":"‚òÜ");
  toast("K√∂sz√∂nj√ºk a v√©lem√©nyt!");
  loadProductReviews(current.id);
});

/** Start */
updateCartUI(); load();
</script>
</body>
</html>
