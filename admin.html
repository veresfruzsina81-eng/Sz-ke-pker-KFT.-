<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Szőke Épker – Admin</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --brand:#0ea5b7; /* türkizkék */
    --ink:#0f172a;   /* sötét szöveg */
    --muted:#6b7280; /* halvány szöveg */
    --bg:#f6f7fb;
    --card:#ffffff;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--brand);text-decoration:none}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin:10px 0 18px}
  header img{height:34px;width:auto}
  header h1{font-size:22px;margin:0 0 0 6px;font-weight:700}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 24px rgba(15,23,42,.06);padding:22px}
  .grid{display:grid;gap:18px}
  .grid-2{grid-template-columns: 1.1fr 1fr}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;margin:14px 0}
  .tab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
  .btn.ghost{background:#eef5f7;color:#0b6170}
  .btn.bad{background:var(--bad)}
  .btn.warn{background:var(--warn);color:#111}
  .btn.sm{padding:6px 10px;border-radius:8px;font-weight:600}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
  .field input,.field textarea,.field select{
    border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px 14px;font:inherit
  }
  .row{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .list{display:grid;gap:12px}
  .item{display:grid;grid-template-columns:72px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid #eef2f7;border-radius:14px;padding:10px}
  .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;background:#f2f4f8}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb}
  .pill.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
  .pill.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
  .empty{padding:30px;text-align:center;color:var(--muted)}
  .login-card{max-width:540px;margin:30px auto}
  .hide{display:none}
  .hint{font-size:12px;color:#6b7280;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/logo.png" alt="Szőke Épker">
      <h1>Szőke Épker – Admin belépés</h1>
      <div class="right muted" id="loginState"></div>
    </header>

    <!-- LOGIN -->
    <section id="loginSection" class="card login-card">
      <div class="field"><label>Felhasználónév
        <input id="u" autocomplete="username" placeholder="pl. szokeadmin"></label>
      </div>
      <div class="field"><label>Jelszó
        <input id="p" type="password" autocomplete="current-password" placeholder="••••••••"></label>
      </div>
      <div class="row">
        <button class="btn" id="loginBtn">Belépés</button>
        <span class="hint">Helyi bejelentkezés – mást nem enged be.</span>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashSection" class="hide">
      <div class="card">
        <div class="row">
          <h2 style="margin:0">Admin felület</h2>
          <div class="right">
            <button class="btn ghost sm" id="refreshAll">Frissítés</button>
            <button class="btn bad sm" id="logoutBtn">Kijelentkezés</button>
          </div>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="products">Termékek</button>
          <button class="tab" data-tab="orders">Rendelések</button>
          <button class="tab" data-tab="reviews">Vélemények</button>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div id="tab-products" class="grid grid-2" style="margin-top:16px">
        <div class="card">
          <h3 style="margin-top:0">Új termék</h3>
          <div class="field"><label>Termék neve
            <input id="prTitle" placeholder="pl. Zsák"></label></div>
          <div class="field"><label>Ár (Ft)
            <input id="prPrice" type="number" min="0" step="1" placeholder="pl. 5000"></label></div>
          <div class="field"><label>Rövid leírás (Markdown megengedett)
            <textarea id="prDesc" rows="4" placeholder="pár sor leírás…"></textarea></label></div>
          <div class="field"><label>Kép (jpg/png)
            <input id="prFile" type="file" accept="image/*"></label></div>
          <div class="row">
            <label class="row"><input id="prStock" type="checkbox" checked> Készleten</label>
            <button class="btn right" id="addProductBtn">Hozzáadás</button>
          </div>
          <div class="hint" id="prodHint"></div>
        </div>

        <div class="card">
          <div class="row">
            <h3 style="margin:0">Termékek</h3>
            <div class="right"><input id="search" placeholder="Keresés…" style="padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb"></div>
          </div>
          <div id="prodList" class="list"></div>
          <div id="prodEmpty" class="empty hide">Nincs találat.</div>
        </div>
      </div>

      <!-- ORDERS -->
      <div id="tab-orders" class="hide" style="margin-top:16px">
        <div class="card">
          <div class="row">
            <h3 style="margin:0">Rendelések</h3>
            <button class="btn ghost sm right" id="reloadOrders">Frissítés</button>
          </div>
          <div id="orderList" class="list"></div>
          <div id="orderEmpty" class="empty hide">Még nincs rendelés.</div>
        </div>
      </div>

      <!-- REVIEWS -->
      <div id="tab-reviews" class="hide" style="margin-top:16px">
        <div class="card">
          <div class="row">
            <h3 style="margin:0">Vélemények</h3>
            <button class="btn ghost sm right" id="reloadReviews">Frissítés</button>
          </div>
          <div id="revList" class="list"></div>
          <div id="revEmpty" class="empty hide">Még nincs vélemény.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.min.js"></script>
  <script>
  // ====== SUPABASE CONFIG (a te projekted) ======
  const SUPA_URL = "https://gckynywmoxylwyppmkck.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
  const supa = supabase.createClient(SUPA_URL, SUPA_KEY);
  const bucket = supa.storage.from('products');

  // ====== HELYI LOGIN (felhasználó/jelszó) ======
  const LOGIN_USER = "szokeadmin";
  const LOGIN_PASS = "szoke2025";
  const state = {
    logged: !!localStorage.getItem('se_admin_logged')
  };

  const $ = s => document.querySelector(s);
  const show = (id, on=true)=>{ const el=$(id); if(!el) return; el.classList.toggle('hide', !on); }
  const toast = msg => { alert(msg); }

  function renderLoginState(){
    $('#loginState').textContent = state.logged ? 'Bejelentkezve' : 'Vendég';
    show('#loginSection', !state.logged);
    show('#dashSection', state.logged);
  }

  $('#loginBtn').onclick = ()=>{
    const u = $('#u').value.trim();
    const p = $('#p').value;
    if(u===LOGIN_USER && p===LOGIN_PASS){
      state.logged = true;
      localStorage.setItem('se_admin_logged','1');
      renderLoginState();
      loadProducts();
      loadOrders();
      loadReviews();
    }else{
      toast('Hibás belépési adatok.');
    }
  };
  $('#logoutBtn').onclick = ()=>{
    localStorage.removeItem('se_admin_logged');
    state.logged = false;
    renderLoginState();
  };

  // ====== TABOK ======
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const k = btn.dataset.tab;
      show('#tab-products', k==='products');
      show('#tab-orders', k==='orders');
      show('#tab-reviews', k==='reviews');
    });
  });

  // ====== TERMÉKEK ======
  let PRODUCTS = [];
  async function loadProducts(){
    if(!state.logged) return;
    const { data, error } = await supa.from('products')
      .select('id,title,price,description,image_url,instock,created_at')
      .order('created_at',{ascending:false});
    if(error){ console.error(error); toast('Terméklista hiba.'); return; }
    PRODUCTS = data || [];
    renderProducts();
  }

  function renderProducts(){
    const q = ($('#search').value||'').toLowerCase();
    const list = $('#prodList'), empty = $('#prodEmpty');
    const rows = PRODUCTS.filter(p=>!q || p.title.toLowerCase().includes(q));
    list.innerHTML = rows.map(p=>`
      <div class="item" data-id="${p.id}">
        <img src="${p.image_url||'/assets/placeholder.png'}" alt="">
        <div>
          <div style="font-weight:700">${p.title}</div>
          <div class="muted">${(p.description||'').slice(0,120)}</div>
          <div class="row" style="margin-top:6px;gap:12px">
            <span class="pill ${p.instock?'ok':'bad'}">${p.instock?'készleten':'nem elérhető'}</span>
            <span class="pill">${new Intl.NumberFormat('hu-HU').format(p.price)} Ft</span>
          </div>
        </div>
        <div class="row">
          <button class="btn ghost sm" data-edit="${p.id}">Szerk.</button>
          <button class="btn bad sm" data-del="${p.id}">Törlés</button>
        </div>
      </div>
    `).join('');
    empty.classList.toggle('hide', rows.length>0);
  }
  $('#search').addEventListener('input', renderProducts);

  // Kép feltöltése + termék beszúrás
  async function uploadImage(file){
    // név: uuid + eredeti név
    const id = crypto.randomUUID();
    const path = `${id}_${file.name.replaceAll(' ','_')}`;
    const { error } = await bucket.upload(path, file, { upsert:false });
    if(error){ throw error; }
    const { data } = bucket.getPublicUrl(path);
    return { publicUrl: data.publicUrl, path };
  }

  $('#addProductBtn').onclick = async ()=>{
    if(!state.logged) return;
    const title = $('#prTitle').value.trim();
    const price = parseInt($('#prPrice').value,10) || 0;
    const desc  = $('#prDesc').value.trim();
    const file  = $('#prFile').files[0] || null;
    const instock = $('#prStock').checked;
    if(!title || price<=0){ toast('Add meg a nevet és az árat!'); return; }

    $('#addProductBtn').disabled = true;
    $('#prodHint').textContent = 'Feltöltés…';
    try{
      let image_url = null, storage_path = null;
      if(file){
        const up = await uploadImage(file);
        image_url = up.publicUrl; storage_path = up.path;
      }
      const { error } = await supa.from('products').insert({
        title, price, description: desc, image_url, instock, storage_path
      });
      if(error) throw error;
      // ürítsd a formot
      $('#prTitle').value=''; $('#prPrice').value=''; $('#prDesc').value=''; $('#prFile').value=''; $('#prStock').checked=true;
      $('#prodHint').textContent = 'Mentve.';
      await loadProducts();
    }catch(e){
      console.error(e);
      toast('Hiba: '+(e.message||e));
      $('#prodHint').textContent = 'Hiba történt.';
    }finally{
      $('#addProductBtn').disabled = false;
      setTimeout(()=>$('#prodHint').textContent='',1500);
    }
  };

  // Szerkesztés + törlés
  document.addEventListener('click', async (e)=>{
    const delId = e.target?.dataset?.del;
    if(delId){
      if(!confirm('Biztos törlöd a terméket?')) return;
      // próbáljuk a storage fájlt is törölni, ha elérhető storage_path mezőben
      const row = PRODUCTS.find(p=>p.id===delId);
      try{
        if(row?.storage_path){ await bucket.remove([row.storage_path]); }
        else if(row?.image_url){
          const idx = row.image_url.indexOf('/products/');
          if(idx>-1){ const pth = row.image_url.slice(idx+('/products/').length); await bucket.remove([pth]); }
        }
      }catch{}
      const { error } = await supa.from('products').delete().eq('id', delId);
      if(error){ toast('Törlés hiba.'); console.error(error); return; }
      PRODUCTS = PRODUCTS.filter(p=>p.id!==delId);
      renderProducts();
      return;
    }
    const editId = e.target?.dataset?.edit;
    if(editId){
      const row = PRODUCTS.find(p=>p.id===editId); if(!row) return;
      const nv = prompt('Új név (ENTER ha marad):', row.title) ?? row.title;
      const ar = prompt('Új ár (Ft):', row.price) ?? row.price;
      const kesz = confirm('Készleten legyen? OK=igen / Mégse=nem');
      const { error } = await supa.from('products').update({
        title: nv || row.title, price: parseInt(ar,10)||row.price, instock: kesz
      }).eq('id', editId);
      if(error){ toast('Szerkesztés hiba.'); console.error(error); return; }
      loadProducts();
      return;
    }
  });

  // ====== RENDELÉSEK ======
  async function loadOrders(){
    if(!state.logged) return;
    const { data, error } = await supa.from('orders')
      .select('id,created_at,name,email,phone,address,shipping,note,items,subtotal,total')
      .order('created_at',{ascending:false});
    if(error){ console.error(error); return; }
    const list = $('#orderList'), empty=$('#orderEmpty');
    if(!data || !data.length){ list.innerHTML=''; empty.classList.remove('hide'); return; }
    empty.classList.add('hide');
    list.innerHTML = data.map(o=>{
      const when = new Date(o.created_at).toLocaleString('hu-HU');
      const items = (o.items||[]).map(x=>`${x.name} × ${x.qty}`).join(', ');
      return `
      <div class="item">
        <div class="pill" style="text-align:center">${when}</div>
        <div>
          <div><strong>${o.name}</strong> – ${o.email} • ${o.phone}</div>
          <div class="muted">${o.address} • Szállítás: ${o.shipping||'-'}</div>
          <div>${items||'-'}</div>
          <div class="pill" style="margin-top:6px">${new Intl.NumberFormat('hu-HU').format(o.total)} Ft</div>
        </div>
        <button class="btn ghost sm" onclick="navigator.clipboard.writeText('Rendelés #${o.id}')">Másol</button>
      </div>`;
    }).join('');
  }
  $('#reloadOrders').onclick = loadOrders;

  // ====== VÉLEMÉNYEK ======
  async function loadReviews(){
    if(!state.logged) return;
    const { data, error } = await supa.from('reviews')
      .select('id,product_id,username,text,created_at,rating')
      .order('created_at',{ascending:false});
    if(error){ console.error(error); return; }
    const list = $('#revList'), empty=$('#revEmpty');
    if(!data || !data.length){ list.innerHTML=''; empty.classList.remove('hide'); return; }
    empty.classList.add('hide');
    list.innerHTML = data.map(r=>{
      const when = new Date(r.created_at).toLocaleString('hu-HU');
      const stars = '★★★★★☆☆☆☆☆'.slice(5-(r.rating||0),10-(r.rating||0));
      return `
      <div class="item">
        <div class="pill">${(r.rating||0)}/5</div>
        <div>
          <div><strong>${r.username||'Ismeretlen'}</strong> • <span class="muted">${when}</span></div>
          <div>${r.text||''}</div>
        </div>
        <button class="btn bad sm" data-del-review="${r.id}">Törlés</button>
      </div>`;
    }).join('');
  }
  $('#reloadReviews').onclick = loadReviews;

  document.addEventListener('click', async (e)=>{
    const rid = e.target?.dataset?.delReview;
    if(rid){
      if(!confirm('Törlöd a véleményt?')) return;
      const { error } = await supa.from('reviews').delete().eq('id', rid);
      if(error){ toast('Nem sikerült törölni.'); return; }
      loadReviews();
    }
  });

  // ====== EGYÉB ======
  $('#refreshAll').onclick = ()=>{ loadProducts(); loadOrders(); loadReviews(); };
  renderLoginState();
  if(state.logged){ loadProducts(); loadOrders(); loadReviews(); }
  </script>
</body>
</html>
