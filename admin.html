<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sz≈ëke √âpker ‚Äì Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#f6f8fb; --surface:#fff; --ink:#16181d; --muted:#727b8e;
  --brand:#2f6fed; --brand-2:#245bcb; --good:#10b981; --bad:#ef4444;
  --radius:18px; --shadow:0 8px 26px rgba(16,24,40,.06); --b:#e9eef6;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
h1,h2,h3{margin:0 0 8px}
input,textarea,select{
  width:100%;border:1px solid var(--b);background:#fff;padding:12px 14px;
  border-radius:12px;font:inherit;transition:.16s
}
input:focus,textarea:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(47,111,237,.18);border-color:#cfe0ff}
.btn{border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;transition:.18s}
.btn.primary{background:var(--brand);color:#fff}.btn.primary:hover{background:var(--brand-2)}
.btn.ghost{background:#fff;border:1px solid var(--brand);color:var(--brand)}
.btn.bad{background:var(--bad);color:#fff}
.muted{color:var(--muted)}
.hidden{display:none}

/* === Layout: sidebar + main === */
.app-wrap{display:grid;grid-template-columns:260px 1fr;gap:20px;max-width:1400px;margin:0 auto;padding:18px}
@media(max-width:980px){.app-wrap{grid-template-columns:1fr}}
.sidebar{background:var(--surface);border:1px solid var(--b);border-radius:16px;box-shadow:var(--shadow);padding:16px;position:sticky;top:16px;height:fit-content}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.brand img{height:28px}
.nav{display:grid;gap:8px;margin-top:10px}
.nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--ink);text-decoration:none;border:1px solid var(--b);background:#fff}
.nav a.active{background:rgba(47,111,237,.10);border-color:#cfe0ff;color:#2559c6;box-shadow:inset 0 0 0 1px rgba(47,111,237,.18)}
.nav svg{width:18px;height:18px}

/* === Topbar anim√°lt === */
.topbar{
  position:sticky;top:0;z-index:5;background:linear-gradient(135deg,rgba(231,240,255,.85),rgba(249,251,255,.85));
  backdrop-filter: blur(8px);border:1px solid #dfe6f6;border-radius:16px;box-shadow:0 10px 30px rgba(34,74,156,.08);
  padding:14px 16px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;
  transform:translateY(-100%);opacity:0;animation:slideDown .7s ease forwards
}
@keyframes slideDown{to{transform:translateY(0);opacity:1}}
.topbar h1{margin:0;color:var(--brand);font-size:18px}

/* === Dashboard cards === */
.dashboard{display:grid;gap:14px;margin-bottom:16px;grid-template-columns:repeat(4,minmax(200px,1fr))}
@media(max-width:980px){.dashboard{grid-template-columns:repeat(2,1fr)}}
.stat{background:#fff;border:1px solid var(--b);border-radius:16px;box-shadow:var(--shadow);padding:16px;display:flex;gap:12px;align-items:center}
.icon{width:36px;height:36px;border-radius:10px;background:#eef4ff;display:grid;place-items:center;border:1px solid #dfe7ff}
.stat h3{margin:0;color:var(--muted);font-size:13px}
.stat strong{font-size:22px}

/* === Cards / lists === */
.card{background:#fff;border:1px solid var(--b);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:380px 1fr}@media(max-width:1100px){.grid-2{grid-template-columns:1fr}}
.item{display:grid;grid-template-columns:96px 1fr auto;gap:12px;align-items:center;border:1px solid var(--b);border-radius:12px;padding:12px;background:#fff}
.thumb{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--b)}
.actions{display:flex;gap:8px}

/* === Sections === */
.section{display:none}
.section.active{display:block}

/* === Modal / Toast (eredetib≈ël) === */
.scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:1001;padding:16px}
.modal>div{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);width:min(720px,92vw);padding:16px}
.modal.open{display:grid}.scrim.open{display:block}
.toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111;color:#fff;padding:9px 14px;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s;z-index:1202}
.toast.show{opacity:1}

/* === Upload box / ≈±rlap kieg√©sz√≠t√©sek === */
.form-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
@media(max-width:980px){.form-grid{grid-template-columns:1fr}}
.input-row{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
@media(max-width:980px){.input-row{grid-template-columns:1fr}}
.dropbox{border:2px dashed #cfe0ff;background:#f9fbff;border-radius:14px;padding:22px;text-align:center;color:#5b6476}
.dropbox small{display:block;color:#7a8594}

/* Profil */
.profile{display:flex;align-items:center;gap:12px;background:#fff;border:1px solid var(--b);border-radius:16px;box-shadow:var(--shadow);padding:14px;margin-top:16px}
.profile img{width:52px;height:52px;border-radius:50%;object-fit:cover}
.profile span{color:var(--muted);font-size:13px}

/* Login */
.login{max-width:520px;margin:40px auto}
</style>
</head>
<body>

<!-- LOGIN (v√°ltozatlan m≈±k√∂d√©s) -->
<div id="loginBox" class="card login">
  <div class="brand"><img src="logo.png" alt=""><h1 style="margin:0">Sz≈ëke √âpker ‚Äì Admin bel√©p√©s</h1></div>
  <div class="grid">
    <label>Felhaszn√°l√≥n√©v<input id="u" placeholder="Felhaszn√°l√≥n√©v"></label>
    <label>Jelsz√≥<input id="p" type="password" placeholder="Jelsz√≥"></label>
    <button id="loginBtn" class="btn primary" type="button">Bel√©p√©s</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="app-wrap">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand"><img src="logo.png" alt=""><strong>Sz≈ëke √âpker Admin</strong></div>
      <nav class="nav" id="sideNav">
        <a href="#" data-goto="dashboard" class="active">üè† Vez√©rl≈ëpult</a>
        <a href="#" data-goto="products">üì¶ Term√©kek</a>
        <a href="#" data-goto="orders">üßæ Rendel√©sek</a>
        <a href="#" data-goto="reviews">‚≠ê V√©lem√©nyek</a>
        <a href="#" data-goto="categories">üóÇÔ∏è Kateg√≥ri√°k</a>
        <a href="#" data-goto="newproduct">‚ûï √öj term√©k</a>
        <a href="#" data-goto="shipping">üöö Sz√°ll√≠t√°si m√≥dok</a>
        <a href="#" data-goto="payment">üí≥ Fizet√©si m√≥dok</a>
        <a href="#" data-goto="columns">üìä T√°bl√°zat oszlopok</a>
        <a href="#" data-goto="csvlog">üìù CSV Szinkron Napl√≥</a>
        <a href="/webshop.html">üåê Webshop megnyit√°sa</a>
      </nav>

      <div class="profile">
        <img src="szokegyula.jpg" alt="Sz≈ëke Gyula">
        <div><strong>Sz≈ëke Gyula</strong><br><span>Adminisztr√°tor</span></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main>
      <!-- TOPBAR -->
      <div class="topbar">
        <h1>Sz≈ëke √âpker Adminisztr√°ci√≥</h1>
        <div class="right">
          <button class="btn ghost" type="button" onclick="location.href='/webshop.html'">Webshop megnyit√°sa</button>
          <button class="btn primary" id="logoutBtn" type="button">Kijelentkez√©s</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="sec-dashboard" class="section active">
        <div class="dashboard">
          <div class="stat"><div class="icon">üì¶</div><div><h3>√ñsszes term√©k</h3><strong id="statTotal">‚Äî</strong></div></div>
          <div class="stat"><div class="icon">‚úÖ</div><div><h3>Akt√≠v term√©kek</h3><strong id="statActive">‚Äî</strong></div></div>
          <div class="stat"><div class="icon">üõí</div><div><h3>Mai rendel√©sek</h3><strong id="statToday">‚Äî</strong></div></div>
          <div class="stat"><div class="icon">üí∞</div><div><h3>Havi bev√©tel</h3><strong id="statRevenue">‚Äî</strong></div></div>
        </div>

        <div class="card">
          <h2 style="margin-bottom:8px">Legut√≥bbi rendel√©sek</h2>
          <div id="recentOrders" class="muted">T√∂lt√©s‚Ä¶</div>
        </div>
      </section>

      <!-- TERM√âKEK LISTA (eredeti logika + UI) -->
      <section id="sec-products" class="section">
        <div class="grid grid-2">
          <div class="card">
            <h2>√öj term√©k</h2>
            <div class="grid">
              <input id="title" placeholder="Term√©k neve">
              <input id="price" type="number" placeholder="√År (Ft)">
              <textarea id="desc" placeholder="R√∂vid le√≠r√°s (markdown megengedett)"></textarea>
              <label class="muted">K√©p (jpg/png)</label>
              <input id="file" type="file" accept="image/*">
              <label class="row" style="gap:8px"><input id="instock" type="checkbox" checked> K√©szleten</label>
              <button class="btn primary" id="addBtn" type="button">Hozz√°ad√°s</button>
              <div id="pInfo" class="muted"></div>
            </div>
          </div>

          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h2 style="margin:0">Term√©kek</h2>
              <input id="psearch" placeholder="Keres√©s term√©kek k√∂z√∂tt‚Ä¶" style="max-width:260px">
            </div>
            <div id="plist"></div>
            <div id="pempty" class="muted">Nincs tal√°lat.</div>
          </div>
        </div>
      </section>

      <!-- RENDEL√âSEK (eredeti logik√°ddal) -->
      <section id="sec-orders" class="section">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2 style="margin:0">Rendel√©sek</h2>
            <button class="btn primary" id="refreshOrders" type="button">Friss√≠t√©s</button>
          </div>
          <div id="olist"></div>
          <div id="oempty" class="muted">M√©g nincs rendel√©s.</div>
        </div>
      </section>

      <!-- V√âLEM√âNYEK -->
      <section id="sec-reviews" class="section">
        <div class="card">
          <h2>V√©lem√©nyek</h2>
          <div id="rlist"></div>
          <div id="rempty" class="muted">M√©g nincs v√©lem√©ny.</div>
        </div>
      </section>

      <!-- KATEG√ìRI√ÅK (placeholder ‚Äì b≈ëv√≠thet≈ë) -->
      <section id="sec-categories" class="section">
        <div class="card">
          <h2>Kateg√≥ri√°k</h2>
          <p class="muted">Itt fog megjelenni a kateg√≥ria-kezel≈ë. (K√©s≈ëbb √∂sszek√∂tj√ºk Supabase t√°bl√°val.)</p>
        </div>
      </section>

      <!-- √öJ TERM√âK ‚Äì nagy ≈±rlap a k√©peid alapj√°n -->
      <section id="sec-newproduct" class="section">
        <div class="card">
          <h2>√öj term√©k hozz√°ad√°sa</h2>
          <p class="muted">T√∂ltsd ki a mez≈ëket az √∫j term√©k l√©trehoz√°s√°hoz.</p>
          <div class="card" style="margin-top:10px">
            <h3 style="margin-bottom:8px">Term√©k csoport be√°ll√≠t√°sok</h3>
            <div class="form-grid">
              <label class="row" style="align-items:flex-start;gap:10px">
                <input type="radio" name="groupMode" checked> 
                <div>
                  <strong>√öj term√©kcsoport l√©trehoz√°sa</strong>
                  <div class="muted" style="font-size:13px">Hozzon l√©tre teljesen √∫j csoportot, t√∂bb v√°ltozattal.</div>
                  <div style="margin-top:8px">
                    <input placeholder="Csoport k√≥d (opcion√°lis) ‚Äì automatikus gener√°l√°s, ha √ºres">
                    <label class="row" style="gap:8px;margin-top:8px"><input type="checkbox"> Tov√°bb term√©k hozz√°ad√°sa ment√©s ut√°n</label>
                  </div>
                </div>
              </label>
              <label class="row" style="align-items:flex-start;gap:10px">
                <input type="radio" name="groupMode"> 
                <div>
                  <strong>Megl√©v≈ë term√©kcsoporthoz ad√°s</strong>
                  <div class="muted" style="font-size:13px">Adjon √∫j v√°ltozatot egy m√°r l√©tez≈ë csoporthoz.</div>
                </div>
              </label>
            </div>
          </div>

          <div class="form-grid" style="margin-top:12px">
            <div>
              <label>Kateg√≥ria<select><option>V√°lasszon kateg√≥ri√°t</option></select></label>
            </div>
            <div>
              <label>Alkateg√≥ria<select><option>V√°lasszon alkateg√≥ri√°t</option></select></label>
            </div>
            <div>
              <label>Term√©k √°r (Ft) *<input placeholder="0"><span class="muted" style="font-size:12px">Ft</span></label>
            </div>
            <div>
              <label>Akci√≥s √°r (Ft)<input placeholder="0"><span class="muted" style="font-size:12px">Ft</span></label>
            </div>
            <div>
              <label>K√©szlet √°llapot<select><option>K√©szleten</option><option>Nincs k√©szleten</option></select></label>
            </div>
            <div class="row" style="align-items:center;gap:8px">
              <input type="checkbox" checked id="np_active"><label for="np_active">Term√©k akt√≠v</label>
            </div>
          </div>

          <div class="input-row" style="margin-top:12px">
            <label>Sz√©less√©g (mm)<input></label>
            <label>Magass√°g (mm)<input></label>
            <label>Vastags√°g (mm)<input></label>
          </div>
          <div class="input-row">
            <label>√Åtm√©r≈ë (mm)<input></label>
            <label>√ârem √°tm√©r≈ë<input></label>
            <label>Talpm√©ret<input></label>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin-bottom:8px">Term√©k k√©pek</h3>
            <div class="dropbox">
              <div style="font-weight:700;margin-bottom:6px">K√©pek felt√∂lt√©se vagy h√∫zza ide a f√°jlokat</div>
              <small>PNG, JPG, GIF ‚Äì maximum 10MB</small>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin-bottom:8px">R√©szletes le√≠r√°s</h3>
            <textarea rows="6" placeholder="R√©szletes le√≠r√°s..."></textarea>
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:12px;gap:10px">
            <button class="btn ghost" type="button" onclick="goto('products')">Vissza</button>
            <button class="btn primary" type="button">Ment√©s</button>
          </div>
        </div>
      </section>

      <!-- BE√ÅLL√çT√ÅSOK ‚Äì placeholderek -->
      <section id="sec-shipping" class="section"><div class="card"><h2>Sz√°ll√≠t√°si m√≥dok</h2><p class="muted">Ide j√∂nnek a sz√°ll√≠t√°si m√≥dok kezel≈ëje.</p></div></section>
      <section id="sec-payment" class="section"><div class="card"><h2>Fizet√©si m√≥dok</h2><p class="muted">Ide j√∂nnek a fizet√©si m√≥dok.</p></div></section>
      <section id="sec-columns" class="section"><div class="card"><h2>T√°bl√°zat oszlopok</h2><p class="muted">Itt lehet √°ll√≠tani a list√°k oszlopait.</p></div></section>
      <section id="sec-csvlog" class="section"><div class="card"><h2>CSV Szinkron Napl√≥</h2><p class="muted">Ide ker√ºl a CSV napl√≥ list√°ja.</p></div></section>
    </main>
  </div>
</div>

<!-- MODAL + TOAST (v√°ltozatlan) -->
<div id="editScrim" class="scrim"></div>
<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div>
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="editTitle" style="margin:0">Term√©k m√≥dos√≠t√°sa</h3>
      <button class="btn ghost" type="button" onclick="closeEdit()">M√©gse</button>
    </div>
    <div class="grid">
      <label>Term√©k neve<input id="e_title" placeholder="Term√©k neve"></label>
      <label>√År (Ft)<input id="e_price" type="number" placeholder="√År (Ft)"></label>
      <label>Le√≠r√°s<textarea id="e_desc" placeholder="Le√≠r√°s"></textarea></label>
      <div class="row" style="gap:8px">
        <label class="row" style="gap:8px"><input id="e_instock" type="checkbox"> K√©szleten</label>
        <span class="muted">K√©p csere (opcion√°lis):</span>
        <input id="e_file" type="file" accept="image/*">
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn primary" type="button" onclick="saveEdit()">Ment√©s</button>
      </div>
      <div id="e_info" class="muted"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Mentve</div>

<script>
/* ===== Be√°ll√≠t√°sok / Seg√©dek (v√°ltozatlan kulcsok) ===== */
const ADMIN_USER = "szokeadmin";
const ADMIN_PASS = "szoke2025";
const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const BUCKET = "products";
let sb=null;
function ensureSB(){try{if(!sb && window.supabase){sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY)}}catch(e){console.warn(e)}return sb;}
const nf=(n)=>new Intl.NumberFormat('hu-HU').format(Number(n)||0);
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}
function setLogged(v){localStorage.setItem("szoke_admin",v?"1":"");document.getElementById("loginBox").classList.toggle("hidden",v);document.getElementById("app").classList.toggle("hidden",!v);}

/* ===== Navig√°ci√≥ (oldals√°v szekci√≥k) ===== */
function goto(sec){
  document.querySelectorAll('#sideNav a').forEach(a=>a.classList.toggle('active',a.dataset.goto===sec));
  document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id==='sec-'+sec));
  if(sec==='orders') loadOrders();
  if(sec==='reviews') loadReviews();
}
document.getElementById('sideNav').addEventListener('click',e=>{
  const a=e.target.closest('a[data-goto]'); if(!a) return;
  e.preventDefault(); goto(a.dataset.goto);
});

/* ===== Init / Login ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  if(localStorage.getItem("szoke_admin")==="1"){ setLogged(true); loadAll(); }
  document.getElementById("loginBtn").onclick=()=>{const u=document.getElementById("u").value.trim();const p=document.getElementById("p").value.trim();if(u===ADMIN_USER&&p===ADMIN_PASS){setLogged(true);loadAll();}else alert("Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥.")};
  document.getElementById("logoutBtn").onclick=()=>setLogged(false);

  document.getElementById("addBtn")?.addEventListener("click",addProduct);
  document.getElementById("plist")?.addEventListener("click", onProductsClick);
  document.getElementById("refreshOrders")?.addEventListener("click", loadOrders);
  document.getElementById("olist")?.addEventListener("click", onOrdersClick);
  document.getElementById("olist")?.addEventListener("change", onOrderStatusChange);
  document.getElementById("rlist")?.addEventListener("click", onReviewsClick);
});

/* ===== Dashboard ‚Äì DINAMIKUS SZ√ÅMOK + utols√≥ rendel√©sek ===== */
async function loadDashboardStats(){
  if(!ensureSB()) return;

  const totalQ = await sb.from('products').select('*',{count:'exact',head:true});
  const activeQ = await sb.from('products').select('*',{count:'exact',head:true}).eq('instock',true);

  const d = new Date(); d.setHours(0,0,0,0);
  const todayQ = await sb.from('orders').select('*',{count:'exact',head:true}).gte('created_at', d.toISOString());

  const mStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  const revQ = await sb.from('orders').select('total,created_at').gte('created_at', mStart.toISOString());
  const revenue = (revQ.data||[]).reduce((s,o)=>s+(Number(o.total)||0),0);

  document.getElementById('statTotal').textContent  = nf(totalQ.count||0);
  document.getElementById('statActive').textContent = nf(activeQ.count||0);
  document.getElementById('statToday').textContent  = nf(todayQ.count||0);
  document.getElementById('statRevenue').textContent= nf(revenue)+' Ft';

  // legut√≥bbi rendel√©sek list√°ja
  const ro = await sb.from('orders').select('id,name,total,created_at,status').order('created_at',{ascending:false}).limit(6);
  const box=document.getElementById('recentOrders');
  if(ro.error){box.textContent='Nem siker√ºlt bet√∂lteni.';return;}
  box.innerHTML=(ro.data||[]).map(o=>`
    <div class="item" style="grid-template-columns:1fr auto">
      <div><strong>#${String(o.id).slice(-6)}</strong> ‚Äì ${o.name||'-'} <span class="muted">‚Ä¢ ${new Date(o.created_at).toLocaleString('hu-HU')}</span></div>
      <div><strong>${nf(o.total||0)} Ft</strong> <span class="muted">‚Ä¢ ${o.status||'‚Äî'}</span></div>
    </div>
  `).join('') || '<span class="muted">M√©g nincs rendel√©s.</span>';
}

/* ===== TERM√âKEK (eredeti logik√°d) ===== */
let P_ADMIN=[];
async function listProducts(){
  if(!ensureSB())return alert("Supabase nem el√©rhet≈ë.");
  const {data,error}=await sb.from('products').select('id,title,price,instock,image_url,description').order('created_at',{ascending:false});
  if(error){alert("Hiba: "+error.message);return;}
  P_ADMIN=data||[]; renderProductsFiltered();
}
function renderProductsFiltered(){
  const q=(document.getElementById('psearch')?.value||'').toLowerCase().trim();
  const filtered=P_ADMIN.filter(p=>(`${p.title||''} ${p.description||''}`).toLowerCase().includes(q));
  const wrap=document.getElementById("plist");
  wrap.innerHTML=filtered.map(p=>`
    <div class="item" data-id="${p.id}">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div>
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><strong>${p.title||'-'}</strong></div>
        <div class="muted">${nf(p.price)} Ft ‚Ä¢ ${p.instock?'k√©szleten':'nem el√©rhet≈ë'}</div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-action="toggle" data-instock="${p.instock?'1':'0'}">${p.instock?'Le√°ll√≠t':'El√©rhet≈ëv√©'}</button>
        <button class="btn primary" data-action="edit">M√≥dos√≠t√°s</button>
        <button class="btn bad" data-action="delete">T√∂rl√©s</button>
      </div>
    </div>`).join("");
  document.getElementById("pempty").style.display=filtered.length?"none":"block";
}
async function addProduct(){
  if(!ensureSB())return;
  const title=document.getElementById("title").value.trim();
  const price=parseInt(document.getElementById("price").value||"0",10);
  const description=document.getElementById("desc").value||"";
  const instock=document.getElementById("instock").checked;
  const file=document.getElementById("file").files[0];
  const info=document.getElementById("pInfo"); info.textContent="";
  if(!title||!price){alert("N√©v √©s √°r k√∂telez≈ë.");return;}
  let image_url=null;
  if(file){
    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const fname=`${crypto.randomUUID()}.${ext}`;
    const up=await sb.storage.from(BUCKET).upload(fname,file,{upsert:false});
    if(up.error){alert("K√©pfelt√∂lt√©si hiba: "+up.error.message);}
    else{ const {data}=sb.storage.from(BUCKET).getPublicUrl(fname); image_url=data.publicUrl; }
  }
  const ins=await sb.from('products').insert({title,price,description,instock,image_url}).select().maybeSingle();
  if(ins.error){alert("Hiba: "+ins.error.message);return;}
  ["title","price","desc","file"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("instock").checked=true;
  info.textContent="Mentve. ID: "+(ins.data?.id||'');
  toast("Term√©k hozz√°adva"); listProducts(); loadDashboardStats();
}
function onProductsClick(e){
  const btn=e.target.closest('[data-action]'); if(!btn) return;
  const item=e.target.closest('.item'); const id=item?.dataset.id;
  const action=btn.dataset.action;
  if(action==='toggle'){ toggleStock(id, btn.dataset.instock==='1', btn, item); }
  else if(action==='edit'){ const p=P_ADMIN.find(x=>String(x.id)===String(id)); if(p) openEdit(p); }
  else if(action==='delete'){ delProduct(id); }
}
async function toggleStock(id,cur,btn,itemEl){
  if(!ensureSB())return;
  const {data,error}=await sb.from('products').update({instock:!cur}).eq('id',/^\d+$/.test(String(id))?parseInt(id,10):id).select('id,instock').maybeSingle();
  if(error){alert("Hiba: "+error.message);return;}
  btn.dataset.instock=data?.instock?'1':'0';
  btn.textContent=data?.instock?'Le√°ll√≠t':'El√©rhet≈ëv√©';
  const lbl=itemEl.querySelector('.muted');
  if(lbl){ lbl.innerHTML = lbl.innerHTML.replace(cur?'nem el√©rhet≈ë':'k√©szleten', data?.instock?'k√©szleten':'nem el√©rhet≈ë'); }
  toast("Mentve"); listProducts(); loadDashboardStats();
}
async function delProduct(id){
  if(!confirm("Biztos t√∂rl√∂d a term√©ket?")) return;
  const {error}=await sb.from('products').delete().eq('id',/^\d+$/.test(String(id))?parseInt(id,10):id);
  if(error){alert("Hiba: "+error.message);return;}
  toast("Term√©k t√∂r√∂lve");
  const el=document.querySelector(`.item[data-id="${CSS.escape(String(id))}"]`); if(el) el.remove();
  listProducts(); loadDashboardStats();
}

/* Modal */
let EDIT_ID=null;
function openEdit(p){
  EDIT_ID=p.id;
  e('e_title').value=p.title||'';
  e('e_price').value=Number(p.price||0);
  e('e_desc').value=p.description||'';
  e('e_instock').checked=!!p.instock;
  e('e_file').value='';
  e('e_info').textContent='';
  addClass('editScrim','open'); addClass('editModal','open');
}
function closeEdit(){ removeClass('editScrim','open'); removeClass('editModal','open'); }
async function saveEdit(){
  if(!EDIT_ID) return closeEdit();
  const title=e('e_title').value.trim();
  const price=parseInt(e('e_price').value||'0',10);
  const description=e('e_desc').value||'';
  const instock=e('e_instock').checked;
  const file=e('e_file').files[0];
  const info=e('e_info');
  if(!title||!price){alert("N√©v √©s √°r k√∂telez≈ë.");return;}
  const patch={title,price,description,instock};
  if(file){
    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const fname=`${crypto.randomUUID()}.${ext}`;
    const up=await sb.storage.from(BUCKET).upload(fname,file,{upsert:false});
    if(up.error){alert("K√©pfelt√∂lt√©si hiba: "+up.error.message);}
    else{ const {data}=sb.storage.from(BUCKET).getPublicUrl(fname); patch.image_url=data.publicUrl; }
  }
  const {error}=await sb.from('products').update(patch).eq('id',/^\d+$/.test(String(EDIT_ID))?parseInt(EDIT_ID,10):EDIT_ID);
  if(error){alert("Hiba: "+error.message);return;}
  info.textContent="Friss√≠tve."; toast("Term√©k friss√≠tve"); closeEdit(); listProducts(); loadDashboardStats();
}

/* ===== RENDEL√âSEK (eredeti logik√°d) ===== */
let ORDERS_CACHE=[];
async function loadOrders(){
  if(!ensureSB())return;
  const {data,error}=await sb.from('orders')
    .select('id,created_at,name,email,phone,address,shipping,note,subtotal,shipping_cost,discount,total,coupon_code,coupon_percent,items,status')
    .order('created_at',{ascending:false});
  if(error){alert("Hiba: "+error.message);return;}
  ORDERS_CACHE=data||[]; renderOrders(ORDERS_CACHE);
}
function statusBadge(st){
  if(st==='√öj') return `<span class="badge-pill" style="background:#e0ecff;color:#1d4ed8">√öj</span>`;
  if(st==='Folyamatban') return `<span class="badge-pill" style="background:#fef3c7;color:#92400e">Folyamatban</span>`;
  if(st==='K√©zbes√≠tve') return `<span class="badge-pill" style="background:#dcfce7;color:#065f46">K√©zbes√≠tve</span>`;
  if(st==='T√∂r√∂lve') return `<span class="badge-pill" style="background:#fee2e2;color:#991b1b">T√∂r√∂lve</span>`;
  return `<span class="badge-pill" style="background:#e5e7eb;color:#374151">${st||'‚Äî'}</span>`;
}
function renderOrders(list){
  const HUF=n=>nf(n)+' Ft';
  const box=document.getElementById("olist");
  box.innerHTML=list.map(o=>{
    const items=(o.items||[]).map(it=>`${it.title} √ó ${it.qty}`).join(", ");
    const couponBits=o.coupon_code ? ` ‚Ä¢ Kedvezm√©ny ‚àí${HUF(o.discount||0)} ‚Ä¢ Kupon ${o.coupon_code}${o.coupon_percent?` (${o.coupon_percent}%)`:''}` : (Number(o.discount||0)>0?` ‚Ä¢ Kedvezm√©ny ‚àí${HUF(o.discount)}`:'');
    return `<div class="card" data-order="${o.id}">
      <div class="row" style="justify-content:space-between">
        <strong>#${String(o.id).slice(-6)}</strong>
        <div class="muted">${new Date(o.created_at).toLocaleString('hu-HU')}</div>
      </div>
      <div>${o.name} ‚Ä¢ ${o.email} ‚Ä¢ ${o.phone} <span class="status-holder">${statusBadge(o.status)}</span></div>
      <div class="muted">C√≠m: ${o.address} ‚Ä¢ Sz√°ll√≠t√°s: ${o.shipping||'-'}</div>
      ${o.note?`<div class="muted" style="font-size:13px">${o.note}</div>`:''}
      <div class="muted">T√©telek: ${items||'-'}</div>
      <div class="row" style="gap:10px;margin-top:8px;justify-content:space-between;align-items:center">
        <div>
          <strong>√ñsszesen: ${HUF(o.total)}</strong>
          <span class="muted">(R√©sz√∂sszeg ${HUF(o.subtotal)} ‚Ä¢ Sz√°ll√≠t√°s ${HUF(o.shipping_cost)}${couponBits})</span>
          ${o.coupon_code?` <span class="badge-pill" style="background:#eef2ff;color:#245bcb">${o.coupon_code}</span>`:''}
        </div>
        <div class="row" style="gap:8px">
          <select data-status="${o.id}" class="input" style="width:auto">
            ${['√öj','Folyamatban','K√©zbes√≠tve','T√∂r√∂lve'].map(s=>`<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('')}
          </select>
          <button class="btn ghost" data-pdf="${o.id}" type="button">PDF</button>
          <button class="btn ghost" data-csv="${o.id}" type="button">CSV</button>
          <button class="btn bad" data-del="${o.id}" type="button">T√∂rl√©s</button>
        </div>
      </div>
    </div>`;
  }).join("");
  document.getElementById("oempty").style.display=list.length?"none":"block";

  box.querySelectorAll('[data-pdf]').forEach(btn=>{
    btn.addEventListener('click',()=>{const id=btn.getAttribute('data-pdf');const o=ORDERS_CACHE.find(x=>String(x.id)===String(id));if(o) exportOrderPdf(o);});
  });
  box.querySelectorAll('[data-csv]').forEach(btn=>{
    btn.addEventListener('click',()=>{const id=btn.getAttribute('data-csv');const o=ORDERS_CACHE.find(x=>String(x.id)===String(id));if(o) exportOrderCsv(o);});
  });
}
function onOrdersClick(e){
  const delBtn=e.target.closest('[data-del]'); if(delBtn){ deleteOrder(delBtn.getAttribute('data-del')); }
}
function onOrderStatusChange(e){
  const sel=e.target.closest('select[data-status]'); if(!sel) return;
  const id=sel.getAttribute('data-status');
  const val=sel.value;
  saveStatusPersistent(id,val).then(ok=>{
    if(ok){
      const holder=sel.closest('[data-order]')?.querySelector('.status-holder');
      if(holder) holder.innerHTML=statusBadge(val);
      toast("St√°tusz friss√≠tve");
    }else{
      alert("Nem siker√ºlt menteni a st√°tuszt.");
    }
  });
}
async function saveStatusPersistent(id,val){
  const key=/^\d+$/.test(String(id))?parseInt(id,10):id;
  const up=await sb.from('orders').update({status:val}).eq('id',key);
  if(up.error){console.warn(up.error);return false;}
  const check=await sb.from('orders').select('status').eq('id',key).maybeSingle();
  if(check.error){console.warn(check.error);return false;}
  return (check.data?.status===val);
}
async function deleteOrder(id){
  if(!confirm("Biztos t√∂rl√∂d a rendel√©st?")) return;
  const key=/^\d+$/.test(String(id))?parseInt(id,10):id;
  const del=await sb.from('orders').delete().eq('id',key);
  if(del.error){alert("Hiba: "+del.error.message);return;}
  toast("Rendel√©s t√∂r√∂lve");
  const card=document.querySelector(`[data-order="${CSS.escape(String(id))}"]`); if(card) card.remove();
  ORDERS_CACHE=ORDERS_CACHE.filter(o=>String(o.id)!==String(id));
  if(!ORDERS_CACHE.length) document.getElementById('oempty').style.display='block';
}
function exportOrderCsv(o){
  const H=['id','created_at','name','email','phone','address','shipping','subtotal','shipping_cost','discount','total','coupon_code','coupon_percent','status','items'];
  const items=Array.isArray(o.items)?o.items.map(it=>`${(it.title||'').replace(/"/g,'""')} x ${it.qty}`).join(' | '):'';
  const row=[o.id,o.created_at,o.name,o.email,o.phone,o.address,o.shipping,o.subtotal,o.shipping_cost,o.discount,o.total,o.coupon_code||'',o.coupon_percent||'',o.status||'',items].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',');
  const csv=[H.join(','),row].join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`order-${String(o.id).slice(-6)}.csv`;document.body.appendChild(a);a.click();a.remove();
}
function exportOrderPdf(o){
  const HUF=n=>(Number(n)||0).toLocaleString('hu-HU')+' Ft';
  const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const items=(Array.isArray(o.items)?o.items:[]).map(it=>`<tr><td>${esc(it.title)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${HUF(it.price)}</td><td style="text-align:right">${HUF(it.price*it.qty)}</td></tr>`).join('');
  const discRow=Number(o.discount||0)>0?`<tr><td colspan="3" style="text-align:right">Kedvezm√©ny</td><td style="text-align:right">-${HUF(o.discount)}</td></tr>`:'';
  const couponRow=o.coupon_code?`<div style="margin:4px 0 0;color:#374151">Kupon: <b>${esc(o.coupon_code)}</b>${o.coupon_percent?` (${o.coupon_percent}%)`:''}</div>`:'';
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>Rendel√©s #${String(o.id).slice(-6)} ‚Äì Sz≈ëke √âpker</title>
  <style>@page{size:A4;margin:16mm}body{font-family:Inter,system-ui;background:#fff;color:#111}h3{font-size:18px}table td,table th{font-size:13px;padding:6px 0}</style></head>
  <body>
  <section style="margin:18px 0;padding:14px;border:1px solid #e5e7eb;border-radius:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:10px;align-items:center"><img src="logo.png" style="height:26px"><h3 style="margin:0">Sz≈ëke √âpker ‚Äì Rendel√©s</h3></div>
      <div style="text-align:right"><div style="font-weight:700">#${String(o.id).slice(-6)}</div><div style="color:#6b7280">${new Date(o.created_at).toLocaleString('hu-HU')}</div></div>
    </div>
    <div style="margin:8px 0 6px;color:#374151">
      <b>${esc(o.name)}</b> ‚Ä¢ ${esc(o.email)} ‚Ä¢ ${esc(o.phone)} ${o.status?`<span style="margin-left:6px;background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:2px 8px;font-weight:700">${esc(o.status)}</span>`:''}<br>
      C√≠m: ${esc(o.address)} ‚Ä¢ Sz√°ll√≠t√°s: ${esc(o.shipping||'-')}
      ${couponRow}
    </div>
    <table style="width:100%;border-collapse:collapse">
      <thead><tr><th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px 0">Term√©k</th><th style="text-align:center;border-bottom:1px solid #e5e7eb;padding:6px 0">Menny.</th><th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px 0">Egys√©g√°r</th><th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px 0">√ñsszeg</th></tr></thead>
      <tbody>${items}</tbody>
      <tfoot>
        <tr><td colspan="3" style="text-align:right">R√©sz√∂sszeg</td><td style="text-align:right">${HUF(o.subtotal)}</td></tr>
        <tr><td colspan="3" style="text-align:right">Sz√°ll√≠t√°s</td><td style="text-align:right">${HUF(o.shipping_cost)}</td></tr>
        ${discRow}
        <tr><td colspan="3" style="text-align:right;font-weight:700">V√©g√∂sszeg</td><td style="text-align:right;font-weight:700">${HUF(o.total)}</td></tr>
      </tfoot>
    </table>
  </section>
  <script>setTimeout(()=>window.print(),250);<\/script></body></html>`;
  const blob=new Blob([html],{type:'text/html;charset=utf-8;'}); const url=URL.createObjectURL(blob); window.open(url,'_blank');
}

/* ===== V√©lem√©nyek (eredeti) ===== */
async function loadReviews(){
  if(!ensureSB())return;
  const {data,error}=await sb.from('reviews').select('id,created_at,username,text,rating,product_id').order('created_at',{ascending:false});
  if(error){alert("Hiba: "+error.message);return;}
  const list=data||[]; const box=document.getElementById("rlist");
  box.innerHTML=list.map(r=>`
    <div class="item" data-review="${r.id}" style="grid-template-columns:1fr auto">
      <div>
        <div><strong>${r.username||'N√©vtelen'}</strong> ${r.rating?`<span class="muted">‚Ä¢ ${"‚òÖ".repeat(r.rating)}</span>`:''}</div>
        <div class="muted" style="font-size:13px">${new Date(r.created_at).toLocaleString('hu-HU')}</div>
        <div>${r.text}</div>
      </div>
      <button class="btn bad" type="button" data-rdel="${r.id}">T√∂rl√©s</button>
    </div>`).join("");
  document.getElementById("rempty").style.display=list.length?"none":"block";
}
function onReviewsClick(e){
  const del=e.target.closest('[data-rdel]'); if(!del) return;
  delReview(del.getAttribute('data-rdel'));
}
async function delReview(id){
  if(!confirm("Biztos t√∂rl√∂d a v√©lem√©nyt?")) return;
  const key=/^\d+$/.test(String(id))?parseInt(id,10):id;
  const {error}=await sb.from('reviews').delete().eq('id',key);
  if(error){alert("Hiba: "+error.message);return;}
  const still=await sb.from('reviews').select('id').eq('id',key).maybeSingle();
  if(!still.error && still.data){ alert("A v√©lem√©nyt nem siker√ºlt elt√°vol√≠tani (adatb√°zis visszaadta)."); return; }
  toast("V√©lem√©ny t√∂r√∂lve");
  const row=document.querySelector(`[data-review="${CSS.escape(String(id))}"]`); if(row) row.remove();
  loadReviews();
}

/* Helpers */
function e(id){return document.getElementById(id)}
function addClass(id,cls){document.getElementById(id).classList.add(cls)}
function removeClass(id,cls){document.getElementById(id).classList.remove(cls)}

/* Init */
function loadAll(){ ensureSB(); goto('dashboard'); listProducts(); loadOrders(); loadReviews(); loadDashboardStats(); }
</script>
</body>
</html>
