<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webshop ‚Äì Sz≈ëke √âpker KFT.</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Oldalspecifikus apr√≥ fixek -->
  <style>
    .shop-header-logo{height:42px;width:auto}
    .checkbox-row{display:flex;align-items:center;gap:8px;margin:12px 0}
    .checkbox-row input[type="checkbox"]{margin:0}
    .shop-empty{padding:24px;border:1px dashed #ddd;border-radius:12px;background:#fafafa;text-align:center}
  </style>
</head>
<body>

  <!-- FEJL√âC -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html#fooldal" class="brand">
        <img src="logo.png" alt="Sz≈ëke √âpker KFT. log√≥" />
        <span class="brand-text">Sz≈ëke √âpker KFT.</span>
      </a>

      <button class="nav-toggle" aria-expanded="false" aria-label="Men√º megnyit√°sa">
        <span></span><span></span><span></span>
      </button>

      <nav class="main-nav">
        <a href="index.html#fooldal">F≈ëoldal</a>
        <a href="index.html#szolgaltatasok">Szolg√°ltat√°sok</a>
        <a href="index.html#rolunk">R√≥lunk</a>
        <a href="index.html#bemutatkozas">Bemutatkoz√°s</a>
        <a href="index.html#referenciak">Referenci√°k</a>
        <a href="index.html#ajanlatkeres">Aj√°nlatk√©r√©s</a>
        <a href="index.html#kapcsolat" class="pill">Kapcsolat</a>
        <a href="webshop.html" class="pill">Webshop</a>
      </nav>

      <button class="shop-cart-toggle" aria-label="Kos√°r megnyit√°sa">üõí <span id="shopCartCount">0</span></button>
    </div>
  </header>

  <main>
    <section class="section soft-bg">
      <div class="container">
        <div class="shop-header">
          <img src="logo.png" alt="Sz≈ëke √âpker KFT. log√≥" class="shop-header-logo">
          <h2 class="section-title">Webshop</h2>
        </div>
        <p class="lead">Hamarosan.</p>

        <!-- Eszk√∂zt√°r -->
        <div class="shop-toolbar">
          <input id="shopSearch" type="search" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶"/>
          <select id="shopSort">
            <option value="relevance">Rendez√©s: Alap√©rtelmezett</option>
            <option value="price-asc">√År szerint (n√∂v.)</option>
            <option value="price-desc">√År szerint (cs√∂kk.)</option>
            <option value="name-asc">N√©v szerint (A‚ÄìZ)</option>
            <option value="name-desc">N√©v szerint (Z‚ÄìA)</option>
          </select>
        </div>

        <!-- Term√©klista -->
        <div id="shopGrid" class="shop-products"></div>
      </div>
    </section>
  </main>

  <!-- KOS√ÅR OLDALS√ÅV -->
  <aside class="shop-cart" aria-hidden="true">
    <div class="shop-cart__head">
      <h3>Kos√°r</h3>
      <button type="button" class="shop-cart__close" aria-label="Kos√°r bez√°r√°sa">√ó</button>
    </div>
    <div class="shop-cart__items" id="shopCartItems"></div>
    <div class="shop-cart__footer">
      <div class="shop-cart__row"><span>R√©sz√∂sszeg:</span><strong id="shopSubtotal">0 Ft</strong></div>
      <div class="shop-cart__row" id="freeShipHint"></div>
      <button class="shop-btn" id="shopGoCheckout">Tov√°bb a p√©nzt√°rhoz</button>
    </div>
  </aside>

  <!-- P√âNZT√ÅR -->
  <div class="shop-checkout" aria-hidden="true" id="shopCheckout">
    <div class="shop-checkout__card">
      <button class="shop-checkout__close" aria-label="P√©nzt√°r bez√°r√°sa">√ó</button>
      <h3>Rendel√©s lead√°sa (ut√°nv√©t)</h3>

      <!-- Siker n√©zet -->
      <div class="shop-success" id="shopSuccess" hidden>
        <div class="shop-success__icon">‚úî</div>
        <h4>K√∂sz√∂nj√ºk a rendel√©st!</h4>
        <p>Hamarosan visszaigazol√≥ emailt kap.</p>
        <button class="shop-btn shop-btn--primary" id="successClose">Bez√°r√°s</button>
      </div>

      <!-- ≈∞rlap -->
      <form id="orderForm" name="webshop-order" method="POST" data-netlify="true" netlify-honeypot="bot-field">
        <input type="hidden" name="form-name" value="webshop-order" />
        <p class="hidden"><label>Ne t√∂ltsd ki: <input name="bot-field" /></label></p>
        <textarea name="order_json" id="orderJson" style="display:none;"></textarea>

        <div class="shop-grid">
          <label class="fl">
            <input name="name" required placeholder=" " />
            <span>N√©v *</span>
          </label>
          <label class="fl">
            <input type="email" name="email" required placeholder=" " />
            <span>E-mail *</span>
          </label>

          <label class="fl">
            <input type="tel" name="phone" required placeholder=" " />
            <span>Telefon *</span>
          </label>

          <label class="fl shop-grid--full">
            <input name="address" required placeholder=" " />
            <span>Sz√°ll√≠t√°si c√≠m *</span>
            <small class="hint">Ir√°ny√≠t√≥sz√°m, v√°ros, utca, h√°zsz√°m</small>
          </label>

          <label class="fl">
            <input value="Ut√°nv√©t" name="payment" readonly placeholder=" " />
            <span>Fizet√©s m√≥dja</span>
          </label>

          <label class="fl fl-select">
            <select name="shipping" id="shippingSelect">
              <option value="H√°zhozsz√°ll√≠t√°s">H√°zhozsz√°ll√≠t√°s</option>
              <option value="Szem√©lyes √°tv√©tel">Szem√©lyes √°tv√©tel</option>
            </select>
            <span>Sz√°ll√≠t√°s</span>
          </label>

          <label class="fl shop-grid--full">
            <textarea name="note" rows="3" placeholder=" "></textarea>
            <span>Megjegyz√©s</span>
          </label>

          <div class="shop-summary shop-grid--full">
            <h4>Rendel√©si √∂sszegz√©s</h4>
            <div id="orderSummary"></div>
            <div class="shop-summary__total">
              <span>V√©g√∂sszeg:</span> <strong id="orderTotal">0 Ft</strong>
            </div>
            <div class="shop-freeship" id="checkoutFreeShip"></div>
          </div>

          <div class="checkbox-row shop-grid--full">
            <input type="checkbox" name="privacy" required id="privacyCb">
            <label for="privacyCb">Elfogadom az Adatkezel√©si t√°j√©koztat√≥t.</label>
          </div>
        </div>

        <div class="shop-checkout__sticky">
          <div class="shop-checkout__sticky-sum">
            <span>Fizetend≈ë:</span> <strong id="stickyTotal">0 Ft</strong>
          </div>
          <button class="shop-btn shop-btn--primary" type="submit">Rendel√©s lead√°sa</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- NAV + SHOP JS -->
  <script>
  /* ===== Hamburger men√º ===== */
  const navToggle = document.querySelector('.nav-toggle');
  const mainNav   = document.querySelector('.main-nav');
  navToggle?.addEventListener('click', ()=>{
    const open = mainNav.classList.toggle('is-open');
    navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  mainNav?.addEventListener('click', (e)=>{
    if(e.target.tagName==='A' && mainNav.classList.contains('is-open')){
      mainNav.classList.remove('is-open'); navToggle.setAttribute('aria-expanded','false');
    }
  });

  /* ===== Supabase be√°ll√≠t√°s ===== */
  const SUPABASE_URL = "https://gckynywmoxylwyppmkck.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== √Ållapot ===== */
  let LOADED_PRODUCTS = []; // Supabase-b≈ël j√∂n
  const LS_KEY = "shop_cart_v1";
  let cart = JSON.parse(localStorage.getItem(LS_KEY) || "[]");

  /* ===== Seg√©dek ===== */
  const fmt = n => new Intl.NumberFormat("hu-HU").format(n) + " Ft";
  const qS = s => document.querySelector(s);
  const FREE_SHIP_LIMIT = 30000;

  const bestPrice = p => p.price || 0;            // nincs akci√≥ mez≈ë az adatb√°zisban
  const inStock   = p => (p.in_stock !== false);  // default: k√©szleten

  /* ===== DOM ref-ek ===== */
  const grid    = qS("#shopGrid");
  const searchEl= qS("#shopSearch");
  const sortEl  = qS("#shopSort");

  /* ===== Term√©kek lek√©r√©se Supabase-b≈ël ===== */
  async function loadProducts(){
    grid.innerHTML = '<p>Bet√∂lt√©s‚Ä¶</p>';
    const { data, error } = await sb.from('products')
      .select('id,title,price,description,image_url,in_stock,created_at')
      .order('created_at', { ascending:false });

    if(error){
      grid.innerHTML = `<p class="shop-empty">Hiba a term√©kek bet√∂lt√©sekor: ${error.message}</p>`;
      LOADED_PRODUCTS = [];
      return;
    }
    LOADED_PRODUCTS = data || [];
    renderProducts();
  }

  /* ===== Term√©klista render ===== */
  function renderProducts(){
    const q = (searchEl?.value || "").toLowerCase().trim();

    let list = LOADED_PRODUCTS.filter(p =>
      !q || (p.title ?? '').toLowerCase().includes(q)
    );

    switch(sortEl?.value){
      case "price-asc":  list.sort((a,b)=>bestPrice(a)-bestPrice(b)); break;
      case "price-desc": list.sort((a,b)=>bestPrice(b)-bestPrice(a)); break;
      case "name-asc":   list.sort((a,b)=>(a.title||'').localeCompare(b.title||'', 'hu')); break;
      case "name-desc":  list.sort((a,b)=>(b.title||'').localeCompare(a.title||'', 'hu')); break;
      default: /* created_at desc already */ break;
    }

    if(!list.length){
      grid.innerHTML = `<div class="shop-empty">Nincs m√©g el√©rhet≈ë term√©k.</div>`;
      return;
    }

    grid.innerHTML = list.map(p=>{
      const out = !inStock(p);
      return `
        <div class="shop-product-card ${out?'is-out':''}">
          <div class="shop-product-media">
            <img src="${p.image_url}" alt="${p.title ?? ''}">
            ${out ? '<span class="shop-badge out">Elfogyott</span>' : ''}
          </div>
          <h3>${p.title ?? ''}</h3>
          <div class="shop-price">
            <strong>${fmt(bestPrice(p))}</strong>
          </div>
          <div class="shop-product-row">
            <div class="qty">
              <button class="qty__btn" data-qty-dec aria-label="Mennyis√©g cs√∂kkent√©se">‚àí</button>
              <input class="qty__input" type="number" min="1" value="1" inputmode="numeric" />
              <button class="qty__btn" data-qty-inc aria-label="Mennyis√©g n√∂vel√©se">+</button>
            </div>
            <button class="shop-btn" data-add-to-cart data-id="${p.id}" ${out ? 'disabled' : ''}>${out?'Nem el√©rhet≈ë':'Kos√°rba'}</button>
          </div>
        </div>
      `;
    }).join("");
  }

  searchEl?.addEventListener('input', renderProducts);
  sortEl?.addEventListener('change', renderProducts);

  /* ===== Kos√°r m≈±veletek + ingyenes sz√°ll√≠t√°s jelz√©s ===== */
  const subtotal = () => cart.reduce((s,x)=>s + x.price*x.qty, 0);
  function saveCart(){ localStorage.setItem(LS_KEY, JSON.stringify(cart)); updateCartUI(); }

  function findProduct(id){
    return LOADED_PRODUCTS.find(p => String(p.id) === String(id));
  }

  function addToCart(id, qty=1){
    const prod = findProduct(id);
    if(!prod || !inStock(prod)) return;
    qty = Math.max(1, parseInt(qty,10) || 1);
    const it = cart.find(x=>String(x.id)===String(id));
    if(it){ it.qty += qty; }
    else {
      cart.push({
        id: prod.id,
        name: prod.title,
        price: bestPrice(prod),
        img: prod.image_url,
        qty
      });
    }
    saveCart(); toast(`${prod.title} √ó ${qty} a kos√°rban`);
  }
  function removeFromCart(id){ cart = cart.filter(x=>String(x.id)!==String(id)); saveCart(); }
  function changeQty(id, d){ const it = cart.find(x=>String(x.id)===String(id)); if(!it) return; it.qty=Math.max(1,it.qty+d); saveCart(); }

  function updateFreeShipHints(){
    const sub = subtotal();
    const remain = Math.max(0, FREE_SHIP_LIMIT - sub);
    const hintEl = qS("#freeShipHint");
    const chkEl  = qS("#checkoutFreeShip");
    const msg = remain>0
      ? `M√©g ${fmt(remain)} az ingyenes sz√°ll√≠t√°shoz.`
      : `üéâ Ingyenes sz√°ll√≠t√°s!`;
    if(hintEl){ hintEl.innerHTML = `<em>${msg}</em>`; }
    if(chkEl){ chkEl.textContent = msg; }
  }

  function updateCartUI(){
    const count = cart.reduce((s,x)=>s+x.qty,0);
    qS("#shopCartCount").textContent = String(count);
    const list  = qS("#shopCartItems");
    if(list){
      list.innerHTML = cart.length ? cart.map(x=>`
        <div class="shop-cart__item">
          <img src="${x.img}" alt="">
          <div>
            <div class="shop-cart__item-title">${x.name}</div>
            <div>${fmt(x.price)}</div>
            <div class="shop-cart__item-qty">
              <button class="shop-btn shop-btn--ghost" data-dec="${x.id}">‚àí</button>
              <span>${x.qty}</span>
              <button class="shop-btn shop-btn--ghost" data-inc="${x.id}">+</button>
              <button class="shop-btn shop-btn--ghost" data-del="${x.id}" style="margin-left:.5rem">T√∂rl√©s</button>
            </div>
          </div>
          <div><strong>${fmt(x.price * x.qty)}</strong></div>
        </div>
      `).join("") : `<p>√úres a kos√°r.</p>`;
    }
    qS("#shopSubtotal").textContent = fmt(subtotal());
    updateFreeShipHints();
  }

  function openCart(){ qS(".shop-cart")?.classList.add("shop-cart--open"); }
  function closeCart(){ qS(".shop-cart")?.classList.remove("shop-cart--open"); }
  function openCheckout(){ qS("#shopCheckout")?.classList.add("shop-checkout--open"); renderSummary(); }
  function closeCheckout(){ qS("#shopCheckout")?.classList.remove("shop-checkout--open"); }

  document.addEventListener("click", (e)=>{
    const t = e.target;

    // qty a k√°rty√°n
    if(t.matches(".qty__btn")){
      const wrap = t.closest(".qty");
      const input = wrap.querySelector(".qty__input");
      let v = parseInt(input.value||"1",10);
      if(t.hasAttribute("data-qty-inc")) v++;
      if(t.hasAttribute("data-qty-dec")) v = Math.max(1, v-1);
      input.value = String(v);
    }

    if(t.matches(".shop-cart-toggle")) openCart();
    if(t.matches(".shop-cart__close")) closeCart();
    if(t.matches("#shopGoCheckout")){ closeCart(); openCheckout(); }
    if(t.matches(".shop-checkout__close")) closeCheckout();

    if(t.dataset?.inc) changeQty(t.dataset.inc, +1);
    if(t.dataset?.dec) changeQty(t.dataset.dec, -1);
    if(t.dataset?.del) removeFromCart(t.dataset.del);

    const addBtn = t.closest?.("[data-add-to-cart]");
    if(addBtn){
      const card = addBtn.closest(".shop-product-card");
      const qtyInput = card.querySelector(".qty__input");
      const qty = parseInt(qtyInput?.value||"1",10);
      addToCart(addBtn.getAttribute("data-id"), qty);
    }
  });

  /* ===== √ñsszegz√©s + ingyenes sz√°ll√≠t√°s a checkoutban ===== */
  function computeShipping(sub){ return sub >= FREE_SHIP_LIMIT ? 0 : 1490; }

  function renderSummary(){
    const wrap = qS("#orderSummary"), totalEl = qS("#orderTotal"), stickyTotal = qS("#stickyTotal");
    if(!wrap || !totalEl) return;
    const shipping = (qS("#shippingSelect")?.value || "H√°zhozsz√°ll√≠t√°s");
    const sub = subtotal(); const shipCost = computeShipping(sub); const tot = sub + shipCost;

    wrap.innerHTML = `
      <ul>${cart.map(x=>`<li>${x.name} √ó ${x.qty} ‚Äî ${fmt(x.price*x.qty)}</li>`).join("")}</ul>
      <div style="margin-top:.5rem;display:flex;justify-content:space-between">
        <span>Sz√°ll√≠t√°s (${shipping}${sub>=FREE_SHIP_LIMIT?' ‚Äì ingyenes 30 000 Ft felett':''}):</span>
        <strong>${fmt(shipCost)}</strong>
      </div>`;
    totalEl.textContent = fmt(tot);
    if(stickyTotal) stickyTotal.textContent = fmt(tot);

    const hidden = qS("#orderJson");
    if(hidden) hidden.value = JSON.stringify({ items: cart, subtotal: sub, shipping_method: shipping, shipping_cost: shipCost, total: tot }, null, 2);

    updateFreeShipHints();
  }
  document.addEventListener("change", (e)=>{ if(e.target.id==="shippingSelect"){ renderSummary(); } });

  /* ===== Bek√ºld√©s Netlifyra ‚Äì oldal n√©lk√ºl, k√∂sz√∂nj√ºk n√©zet ===== */
  const form = qS("#orderForm");
  form?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    renderSummary(); // t√∂lts√ºk ki a hidden JSON-t
    const fd = new FormData(form);
    try{
      await fetch("/", { method:"POST", body: fd });
      qS("#shopSuccess").hidden = false;
      form.style.display = "none";
      cart = []; saveCart(); renderSummary();
    }catch(err){
      alert("Hopp√°, a bek√ºld√©s nem siker√ºlt. Pr√≥b√°ld √∫jra.");
    }
  });
  qS("#successClose")?.addEventListener("click", ()=> closeCheckout());

  /* ===== Mini toast ===== */
  function toast(msg){
    let el = document.createElement('div');
    el.className = 'shop-toast'; el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=> el.classList.add('on'), 10);
    setTimeout(()=> { el.classList.remove('on'); setTimeout(()=> el.remove(), 300); }, 1800);
  }

  // Kezd≈ë lek√©r√©s √©s render
  loadProducts().then(updateCartUI);
  </script>
</body>
</html>
