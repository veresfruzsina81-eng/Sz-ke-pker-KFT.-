<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sz≈ëke √âpker Webshop</title>
<style>
  :root{--brand:#0a4a7a;--bg:#f5f6f8;--card:#fff;--text:#222;--muted:#666}
  *{box-sizing:border-box} body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{background:var(--brand);color:#fff;padding:14px 20px;position:sticky;top:0;z-index:10}
  header .wrap{display:flex;align-items:center;gap:14px;max-width:1100px;margin:0 auto}
  h1{font-size:22px;margin:0}
  .tools{margin-left:auto;display:flex;gap:8px;align-items:center}
  input[type="search"],select{border:1px solid #d0d5dd;border-radius:999px;padding:8px 12px;background:#fff}
  main{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid #e6e8ec;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .card img{width:100%;height:180px;object-fit:cover;background:#eee}
  .card h3{font-size:18px;margin:10px 12px 0}
  .muted{color:var(--muted);font-size:13px;margin:0 12px 10px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:12px}
  .price{font-weight:700}
  .btn{border:none;border-radius:10px;padding:10px 14px;background:#0ea5e9;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  /* kos√°r */
  .cart-fab{position:fixed;right:16px;bottom:16px;background:#0ea5e9;color:#fff;border:none;border-radius:999px;padding:10px 14px;display:flex;gap:8px;align-items:center;box-shadow:0 6px 18px rgba(0,0,0,.2);cursor:pointer}
  .cart{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45)}
  .cart.open{display:block}
  .sheet{position:absolute;right:0;top:0;height:100%;width:min(420px,100%);background:#fff;display:flex;flex-direction:column}
  .sheet h2{margin:0;padding:14px 16px;border-bottom:1px solid #eee}
  .items{flex:1;overflow:auto;padding:8px 12px;display:flex;flex-direction:column;gap:10px}
  .item{display:flex;gap:10px;align-items:center}
  .item img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .qty{display:flex;align-items:center;gap:6px}
  .ghost{background:#f1f5f9;color:#111}
  .sheet .foot{border-top:1px solid #eee;padding:12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  /* p√©nzt√°r mod√°l */
  dialog{border:none;border-radius:16px;max-width:680px;width:96%;padding:0}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #eee;font-weight:700}
  .dlg-body{padding:14px 16px}
  form .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  form .grid2 label{display:flex;flex-direction:column;font-size:14px}
  input,textarea{border:1px solid #d0d5dd;border-radius:10px;padding:10px;background:#fff}
  textarea{min-height:80px;resize:vertical}
  .total{font-weight:700;font-size:18px}
  .success{padding:18px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sz≈ëke √âpker Webshop</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶">
      <select id="sort">
        <option value="new">Leg√∫jabb</option>
        <option value="price-asc">√År ‚Üë</option>
        <option value="price-desc">√År ‚Üì</option>
        <option value="name">N√©v (A‚ÄìZ)</option>
      </select>
    </div>
  </div>
</header>

<main>
  <div id="grid" class="grid" aria-live="polite">Bet√∂lt√©s‚Ä¶</div>
</main>

<button class="cart-fab" id="openCart">üõí <span id="cartCount">0</span></button>

<div class="cart" id="cart">
  <div class="sheet">
    <h2>Kos√°r</h2>
    <div class="items" id="items"></div>
    <div class="foot">
      <div>√ñsszesen: <span class="total" id="sum">0 Ft</span></div>
      <div>
        <button class="btn ghost" id="closeCart">Bez√°r</button>
        <button class="btn" id="checkoutBtn">P√©nzt√°r</button>
      </div>
    </div>
  </div>
</div>

<dialog id="checkout">
  <div class="dlg-head">Rendel√©s lead√°sa</div>
  <div class="dlg-body">
    <form id="orderForm">
      <div class="grid2">
        <label>N√©v*<input required name="name"></label>
        <label>E-mail*<input required type="email" name="email"></label>
        <label>Telefon*<input required name="phone"></label>
        <label>C√≠m*<input required name="address"></label>
      </div>
      <label>Megjegyz√©s<textarea name="note"></textarea></label>
      <p>Fizet√©s: ut√°nv√©t ‚Ä¢ Sz√°ll√≠t√°s: fut√°r (30.000 Ft felett ingyenes)</p>
      <p>Fizetend≈ë: <span class="total" id="pay">0 Ft</span></p>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn ghost" id="dlgClose">M√©gse</button>
        <button class="btn">Rendel√©s elk√ºld√©se</button>
      </div>
    </form>
    <div class="success" id="ok" hidden>‚úî K√∂sz√∂nj√ºk! A rendel√©st r√∂gz√≠tett√ºk.</div>
  </div>
</dialog>

<script type="module">
/*** SUPABASE BE√ÅLL√çT√ÅS ***/
const SUPA_URL = "https://gckynywmoxylwyppmkck.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supa = createClient(SUPA_URL, SUPA_KEY);

/*** KISEG√çT≈êK ***/
const HUF = n => new Intl.NumberFormat('hu-HU').format(n) + " Ft";
const qs = s => document.querySelector(s);
let CART = JSON.parse(localStorage.getItem('cart')||"[]");
function saveCart(){ localStorage.setItem('cart', JSON.stringify(CART)); renderCart(); }

/*** TERM√âKEK BET√ñLT√âSE ***/
const grid = qs('#grid'), q = qs('#q'), sort = qs('#sort');

async function loadProducts(){
  grid.textContent = "Bet√∂lt√©s‚Ä¶";
  let req = supa.from('products').select('id,title,price,description,image_url,instock,created_at');
  // sz≈±r√©s
  const t = (q.value||"").trim();
  if(t) req = req.ilike('title', `%${t}%`);
  // rendez√©s
  if(sort.value==='price-asc') req = req.order('price', {ascending:true});
  else if(sort.value==='price-desc') req = req.order('price', {ascending:false});
  else if(sort.value==='name') req = req.order('title', {ascending:true});
  else req = req.order('created_at', {ascending:false});

  const { data, error } = await req;
  if(error){ grid.textContent = "Hiba a bet√∂lt√©skor."; console.error(error); return; }
  if(!data.length){ grid.textContent = "Jelenleg nincs el√©rhet≈ë term√©k."; return; }

  grid.innerHTML = data.map(p=>`
    <article class="card">
      <img src="${p.image_url || 'https://placehold.co/800x600?text=K%C3%A9p'}" alt="">
      <h3>${p.title||'N√©v n√©lk√ºl'}</h3>
      <p class="muted">${p.description ? p.description.slice(0,120) : ''}</p>
      <div class="row">
        <span class="price">${HUF(p.price||0)}</span>
        <button class="btn" ${p.instock===false?'disabled':''} data-add="${p.id}">Kos√°rba</button>
      </div>
    </article>
  `).join('');
}

q?.addEventListener('input', ()=>loadProducts());
sort?.addEventListener('change', ()=>loadProducts());

/*** KOS√ÅR ***/
function renderCart(){
  const items = qs('#items'), sum = qs('#sum'), cnt = qs('#cartCount');
  let total = 0;
  items.innerHTML = CART.map(x=>{
    total += x.price * x.qty;
    return `<div class="item">
      <img src="${x.image_url || 'https://placehold.co/120'}" alt="">
      <div style="flex:1">
        <div><strong>${x.title}</strong></div>
        <div class="muted">${HUF(x.price)}</div>
        <div class="qty">
          <button class="btn ghost" data-dec="${x.id}">‚àí</button>
          <span>${x.qty}</span>
          <button class="btn ghost" data-inc="${x.id}">+</button>
          <button class="btn ghost" data-del="${x.id}">T√∂rl√©s</button>
        </div>
      </div>
      <div><strong>${HUF(x.price * x.qty)}</strong></div>
    </div>`;
  }).join('');
  sum.textContent = HUF(total);
  cnt.textContent = CART.reduce((s,i)=>s+i.qty,0);
  qs('#pay').textContent = HUF(total >= 30000 ? total : total + 1490);
}
document.addEventListener('click', async e=>{
  const t = e.target;
  if(t.matches('[data-add]')){
    // k√©rj√ºk le a term√©ket
    const id = t.getAttribute('data-add');
    const { data, error } = await supa.from('products').select().eq('id', id).single();
    if(error||!data) return;
    const ex = CART.find(x=>x.id===id);
    if(ex) ex.qty++; else CART.push({...data, qty:1});
    saveCart();
  }
  if(t.matches('#openCart')) qs('#cart').classList.add('open');
  if(t.matches('#closeCart')) qs('#cart').classList.remove('open');
  if(t.matches('[data-inc]')){ const id=t.getAttribute('data-inc'); const it=CART.find(i=>i.id===id); if(it){it.qty++; saveCart();} }
  if(t.matches('[data-dec]')){ const id=t.getAttribute('data-dec'); const it=CART.find(i=>i.id===id); if(it){ it.qty=Math.max(1,it.qty-1); saveCart();} }
  if(t.matches('[data-del]')){ const id=t.getAttribute('data-del'); CART = CART.filter(i=>i.id!==id); saveCart(); }
  if(t.matches('#checkoutBtn')){ qs('#checkout').showModal(); document.body.style.overflow='hidden'; }
  if(t.matches('#dlgClose')){ qs('#checkout').close(); document.body.style.overflow=''; }
});
/*** RENDEL√âS K√úLD√âS (Netlify form helyett egyszer≈± mailto helyett ‚Äì most csak siker√ºzenet) ***/
qs('#orderForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!CART.length) return alert('A kos√°r √ºres.');
  qs('#orderForm').hidden = true;
  qs('#ok').hidden = false;
  CART = []; saveCart();
});

/*** INDUL√ÅS ***/
renderCart();
loadProducts();
</script>
</body>
</html>
