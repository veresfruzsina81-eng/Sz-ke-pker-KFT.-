<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Szőke-Épker – Webshop</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{--ink:#222;--muted:#7a8594;--bg:#f5f7fb;--card:#fff;--brand:#2f6fed;--brand-2:#245bcb;--ring:0 0 0 3px rgba(47,111,237,.18)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #e5e9f2}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
.row{display:flex;align-items:center;gap:10px}
.space{justify-content:space-between}
.brand img{height:26px}
.brand h1{font-size:18px;margin:0}
.btn{appearance:none;border:0;padding:9px 14px;border-radius:12px;cursor:pointer;font-weight:700;background:var(--brand);color:#fff}
.btn:hover{background:var(--brand-2)}
.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.badge{display:inline-flex;min-width:22px;height:22px;padding:0 6px;border-radius:999px;background:#111;color:#fff;font-size:12px;align-items:center;justify-content:center}

.search{margin:14px auto 0;max-width:640px}
.search input{width:100%;border:1px solid #e5e9f2;background:#fff;padding:10px 12px;border-radius:12px}
.search input:focus{outline:none;box-shadow:var(--ring);border-color:#d6def7}

/* TERMÉKKÁRTYÁK */
.grid{display:grid;gap:12px;margin:16px auto;max-width:1200px}
@media(min-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--card);border:1px solid #e5e9f2;border-radius:14px;box-shadow:0 10px 22px rgba(22,29,37,.05);overflow:hidden}
.thumb{
  width:100%;
  height:220px;
  object-fit:contain;
  background:#fff;
  border-bottom:1px solid #eef2f8;
  display:block;
  padding:8px;
  cursor:zoom-in; /* nagyítás jelzése */
}
.px{padding:10px 12px}
.title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.price{font-weight:700}
.muted{color:var(--muted)}
.qty{display:inline-flex;align-items:center;border:1px solid #e5e9f2;border-radius:999px;overflow:hidden}
.qty button{background:#fff;border:0;width:26px;height:26px;cursor:pointer}
.qty input{width:34px;border:0;text-align:center;appearance:textfield}
.qty input::-webkit-outer-spin-button,
.qty input::-webkit-inner-spin-button{appearance:none;margin:0}

/* ikon gomb (maradhat általános célra) */
.icon-btn{
  background:#fff;border:1px solid #e5e9f2;border-radius:10px;
  width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;line-height:1;
}
.icon-btn:hover{box-shadow:var(--ring)}

.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:9px 12px;border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1}

/* LIGHTBOX */
.lb-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);display:grid;place-items:center;z-index:1000}
.lb-backdrop[hidden]{display:none}
.lb-img{max-width:90vw;max-height:90vh;border-radius:12px}
.lb-close{
  position:fixed;top:16px;right:16px;z-index:1001;
  width:40px;height:40px;font-size:28px;line-height:1;border:none;border-radius:50%;background:#fff;cursor:pointer
}

/* OLDALSÓ KOSÁR FIÓK */
.cart-drawer{
  position:fixed;top:0;right:0;height:100%;width:min(420px,92vw);
  background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.15);
  transform:translateX(100%);transition:transform .28s ease;z-index:1002;
  display:flex;flex-direction:column
}
.cart-drawer.open{transform:translateX(0)}
.cart-scrim{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1001}
.cart-scrim[hidden]{display:none}
.cart-head{padding:16px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee}
.cart-list{list-style:none;margin:0;padding:8px 12px;overflow:auto;flex:1}
.cart-row{display:grid;grid-template-columns:1fr auto 92px 32px;align-items:center;gap:8px;padding:10px 6px;border-bottom:1px dashed #eee}
.cart-row .title{font-weight:500}
.cart-row .price{white-space:nowrap}
.cart-row .qty{width:88px;border-radius:10px}
.cart-empty{padding:16px;color:#777}
.btn-primary{width:100%;padding:12px 14px;border:none;border-radius:10px;background:#1a73e8;color:#fff;font-weight:600;cursor:pointer}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.cart-foot{border-top:1px solid #eee;padding:12px}
.cart-foot .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
</style>
</head>
<body>
<header class="header">
  <div class="wrap row space">
    <div class="brand row"><img src="logo.png" alt=""><h1>Szőke-Épker Kft.</h1></div>
    <div class="row">
      <a class="btn ghost" href="/">Vissza a weboldalra</a>
      <!-- KOSÁR: gombbá alakítva, hogy a fiókot nyissa -->
      <button id="cartOpen" class="btn">Kosár <span id="badge" class="badge">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="search"><input id="q" type="search" placeholder="Keresés a termékek közt…"></div>
  <section id="list" class="grid"></section>
  <p id="empty" class="muted" style="display:none;text-align:center">Nincs találat.</p>
</main>

<!-- Lightbox képnagyító -->
<div id="imgLightbox" class="lb-backdrop" hidden>
  <button class="lb-close" aria-label="Bezárás">×</button>
  <img class="lb-img" alt="Preview">
</div>

<!-- Oldalsó kosár fiók -->
<div id="cartDrawer" class="cart-drawer" aria-hidden="true">
  <div class="cart-head">
    <h3>Kosár</h3>
    <button id="cartClose" class="icon-btn" aria-label="Kosár bezárása">×</button>
  </div>
  <ul id="cartItems" class="cart-list"></ul>
  <div class="cart-foot">
    <div class="row">
      <span>Összesen:</span>
      <strong id="cartTotal">0 Ft</strong>
    </div>
    <button id="checkoutBtn" class="btn-primary">Tovább a megrendeléshez</button>
  </div>
</div>
<div id="cartScrim" class="cart-scrim" hidden></div>

<div id="toast" class="toast">Hozzáadva a kosárhoz</div>

<script>
/* --- Supabase beállítások: változatlanul hagyva --- */
const SB_URL="https://gckynywmoxylwyppmkck.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
const sb=supabase.createClient(SB_URL,SB_KEY);

/* --- CART kezelés --- */
let PRODUCTS=[];
/* Frissítéskor (reload) töröljük a kosarat ezen az oldalon */
(function clearCartOnReload(){
  try{
    const nav=performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
    if(nav && nav.type==='reload'){ localStorage.removeItem('cart'); }
    // alternatíva régi böngészőkre:
    // if(performance.navigation && performance.navigation.type===1){ localStorage.removeItem('cart'); }
  }catch(_){}
})();
let CART=JSON.parse(localStorage.getItem("cart")||"[]");

const HUF=n=>new Intl.NumberFormat('hu-HU').format(n||0)+" Ft";
const saveCart=()=>{localStorage.setItem("cart",JSON.stringify(CART)); setBadge();};
const setBadge=()=>{document.getElementById('badge').textContent=CART.reduce((s,x)=>s+(x.qty||0),0);};
const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);};

/* --- Renderelés: termékkártyák --- */
function render(list){
  const box=document.getElementById('list');
  box.innerHTML=list.map(p=>`
    <article class="card">
      <img class="thumb" src="${p.image_url||'logo.png'}" alt="">
      <div class="px">
        <div class="row" style="justify-content:space-between">
          <div class="title" title="${p.title||''}">${p.title||'-'}</div>
          <div class="price">${HUF(p.price)}</div>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:8px;flex-wrap:wrap">
          <div class="qty" style="flex:0 0 auto">
            <button data-act="minus" data-id="${p.id}" aria-label="Mennyiség csökkentése">−</button>
            <input value="1" inputmode="numeric" pattern="[0-9]*" min="1" data-qty="${p.id}">
            <button data-act="plus" data-id="${p.id}" aria-label="Mennyiség növelése">+</button>
          </div>

          <div class="row" style="flex:1 1 auto;justify-content:flex-end;gap:8px">
            <button class="btn" data-add="${p.id}">Kosárba</button>
            <a class="btn ghost" href="product.html?id=${encodeURIComponent(p.id)}">Megnyitás</a>
          </div>
        </div>
      </div>
    </article>`).join('');
  document.getElementById('empty').style.display=list.length?'none':'block';
}

/* --- KOSÁR FIÓK NYITÁS/ZÁRÁS --- */
const drawer = document.getElementById('cartDrawer');
const scrim = document.getElementById('cartScrim');
const openBtn = document.getElementById('cartOpen');
const closeBtn = document.getElementById('cartClose');

function openCart(){ drawer.classList.add('open'); scrim.hidden = false; }
function closeCart(){ drawer.classList.remove('open'); scrim.hidden = true; }

openBtn && openBtn.addEventListener('click', openCart);
closeBtn && closeBtn.addEventListener('click', closeCart);
scrim && scrim.addEventListener('click', closeCart);

/* --- KOSÁR RENDER --- */
function renderCart(){
  const ul = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  ul.innerHTML = '';

  if (!CART.length) {
    ul.innerHTML = `<li class="cart-empty">A kosarad üres.</li>`;
    totalEl.textContent = '0 Ft';
  } else {
    CART.forEach(p=>{
      ul.insertAdjacentHTML('beforeend', `
        <li class="cart-row" data-id="${p.id}">
          <span class="title">${escapeHtml(p.title)}</span>
          <span class="price">${(p.price * p.qty).toLocaleString('hu-HU')} Ft</span>
          <input class="qty" type="number" min="1" value="${p.qty}">
          <button class="icon-btn remove" title="Eltávolítás">×</button>
        </li>
      `);
    });
    totalEl.textContent = CART.reduce((s,p)=> s + p.price*p.qty, 0).toLocaleString('hu-HU') + ' Ft';
  }
  setBadge();
  localStorage.setItem("cart", JSON.stringify(CART));
}

/* Kosárban: X törlés + mennyiség változtatás */
document.getElementById('cartItems').addEventListener('click', (e)=>{
  if (e.target.closest('.remove')) {
    const id = e.target.closest('.cart-row').dataset.id;
    CART = CART.filter(x => String(x.id) !== String(id));
    renderCart();
  }
});
document.getElementById('cartItems').addEventListener('input', (e)=>{
  if (e.target.matches('.qty')) {
    const row = e.target.closest('.cart-row');
    const id = row.dataset.id;
    const item = CART.find(x => String(x.id) === String(id));
    if (item) {
      const v = Math.max(1, parseInt(e.target.value||'1',10));
      item.qty = v;
      renderCart();
    }
  }
});

/* --- Események: termékkártyák --- */
document.getElementById('list').addEventListener('click',e=>{
  const minus=e.target.closest('[data-act="minus"]');
  const plus=e.target.closest('[data-act="plus"]');
  const add=e.target.closest('[data-add]');

  if(minus){
    const id=minus.dataset.id;
    const q=document.querySelector(`[data-qty="${id}"]`);
    q.value=Math.max(1,parseInt(q.value||"1")-1);
  }
  if(plus){
    const id=plus.dataset.id;
    const q=document.querySelector(`[data-qty="${id}"]`);
    q.value=Math.max(1,parseInt(q.value||"1")+1);
  }
  if(add){
    const id=add.dataset.add;
    const p=PRODUCTS.find(x=>String(x.id)===String(id));
    const qEl=document.querySelector(`[data-qty="${id}"]`);
    const qty=Math.max(1,parseInt(qEl?.value||"1"));
    const i=CART.findIndex(x=>String(x.id)===String(id));
    if(i>=0) CART[i].qty += qty;
    else CART.push({id:p.id,title:p.title,price:p.price,image_url:p.image_url,qty});
    saveCart(); toast("Hozzáadva a kosárhoz");
    renderCart();         // frissítjük a fiókot
    openCart();           // nem irányít át, csak megnyitja a kosarat
  }
});

/* mennyiség kézi átírás védelme a kártyán */
document.getElementById('list').addEventListener('input',e=>{
  if(e.target.matches('[data-qty]')){
    const v=parseInt(e.target.value||"1",10);
    e.target.value = isNaN(v) || v<1 ? 1 : v;
  }
});

/* Kereső */
document.getElementById('q').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase().trim();
  const f=!q?PRODUCTS:PRODUCTS.filter(p=>(p.title||'').toLowerCase().includes(q)||(p.description||'').toLowerCase().includes(q));
  render(f);
});

/* --- Lightbox: képnagyítás --- */
const lb = document.getElementById('imgLightbox');
const lbImg = lb.querySelector('.lb-img');
document.addEventListener('click', (e)=>{
  if (e.target.matches('.thumb')) {
    lbImg.src = e.target.src;
    lb.removeAttribute('hidden');
    document.body.style.overflow = 'hidden';
  }
  if (e.target.matches('#imgLightbox, #imgLightbox .lb-close')) {
    lb.setAttribute('hidden','');
    lbImg.src = '';
    document.body.style.overflow = '';
  }
});

/* Checkout gomb: csak gombra lép át */
const CHECKOUT_URL = "checkout.html"; // az eddigi oldalad
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  if (!CART.length) return;
  window.location.href = CHECKOUT_URL;
});

/* --- Betöltés --- */
async function load(){
  const {data,error}=await sb
    .from('products')
    .select('id,title,price,description,image_url,instock,created_at')
    .eq('instock',true)
    .order('created_at',{ascending:false});
  if(error){
    document.getElementById('list').innerHTML="<p>Hiba: "+error.message+"</p>";
    return;
  }
  PRODUCTS=data||[];
  render(PRODUCTS);
  setBadge();
  renderCart();
}
load();

/* segédfüggvény */
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>
</body>
</html>
