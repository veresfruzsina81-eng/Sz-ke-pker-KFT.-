<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sz≈ëke √âpker Webshop</title>
  <style>
    :root{
      --bg:#f5f6f7;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--brand:#0ea5e9;--brand-ink:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:5;background:rgba(245,246,247,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #e5e7eb}
    header .wrap{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:40px}
    .brand h1{font-size:20px;margin:0}
    .btn,.btn-primary{display:inline-flex;align-items:center;gap:8px;border:1px solid #dbe1e8;border-radius:10px;padding:10px 14px;background:#fff;cursor:pointer}
    .btn:hover{border-color:#c9cfd7}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
    .btn-primary:hover{filter:brightness(.95)}
    /* Filter row */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
    .input{height:42px;border:1px solid #dbe1e8;border-radius:10px;padding:0 12px;background:#fff;min-width:240px}
    select.input{padding-right:30px}
    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#f2f4f7;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card .body{padding:12px;display:grid;gap:8px}
    .title{font-weight:600;font-size:15px;line-height:1.3}
    .muted{color:var(--muted);font-size:13px}
    .price{font-weight:700}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid #e5e7eb}
    .badge.ok{color:#065f46;border-color:#a7f3d0;background:#ecfdf5}
    .badge.out{color:#92400e;border-color:#fed7aa;background:#fffbeb}
    /* qty pill a k√°rty√°n */
    .qty{display:inline-flex;border:1px solid #dbe1e8;border-radius:999px;overflow:hidden}
    .qty button{width:28px;height:28px;background:#fff;border:0;border-right:1px solid #dbe1e8;cursor:pointer}
    .qty input{width:36px;text-align:center;border:0;font-size:13px}
    /* Drawer cart */
    .drawer{position:fixed;inset:0 0 0 auto;display:none}
    .drawer.open{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(2,6,23,.45)}
    .panel{position:absolute;right:0;top:0;height:100%;width:420px;max-width:100%;background:#fff;
      display:flex;flex-direction:column;border-left:1px solid #e5e7eb}
    .panel header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb}
    .panel header .wrap{padding:12px 16px}
    .panel .content{padding:16px;overflow:auto;display:grid;gap:14px}
    .line{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .line img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
    .qty2{display:inline-flex;border:1px solid #dbe1e8;border-radius:8px;overflow:hidden}
    .qty2 button{width:32px;height:32px;background:#fff;border:0;border-right:1px solid #e5e7eb;cursor:pointer}
    .qty2 input{width:40px;text-align:center;border:0}
    .hr{height:1px;background:#e5e7eb;margin:8px 0}
    form .field{display:grid;gap:6px;margin-bottom:10px}
    input[type="text"],input[type="email"],textarea{border:1px solid #dbe1e8;border-radius:10px;padding:10px 12px}
    textarea{min-height:70px;resize:vertical}
    .empty{padding:26px;border:1px dashed #dbe1e8;border-radius:12px;text-align:center;color:var(--muted)}
    .footer-spacer{height:24px}
  </style>
</head>
<body>
  <header>
    <div class="container wrap">
      <div class="brand">
        <img src="logo.png" alt="Sz≈ëke √âpker Kft">
        <h1>Sz≈ëke √âpker Kft</h1>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn" href="index.html">‚Üê Vissza a weboldalra</a>
        <button class="btn-primary" id="openCart">üõí Kos√°r <span id="cartCount">0</span></button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="filters">
      <input id="search" class="input" type="search" placeholder="Keres√©s a term√©kek k√∂z√∂tt‚Ä¶">
      <select id="sort" class="input">
        <option value="newest">Leg√∫jabb</option>
        <option value="price-asc">√År szerint n≈ë</option>
        <option value="price-desc">√År szerint cs√∂kken</option>
      </select>
    </div>
    <div id="grid" class="grid"></div>
    <div class="footer-spacer"></div>
  </main>

  <!-- Cart drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" id="backdrop"></div>
    <div class="panel">
      <header>
        <div class="wrap container" style="display:flex;justify-content:space-between;align-items:center">
          <strong>Kos√°r</strong>
          <button class="btn" id="closeCart">‚úï</button>
        </div>
      </header>
      <div class="content">
        <div id="cartLines"></div>
        <div class="hr"></div>
        <div id="totals"></div>
        <form id="orderForm">
          <details open>
            <summary style="cursor:pointer;margin-bottom:10px"><strong>Megrendel√©s adatai</strong></summary>
            <div class="field"><label>N√©v</label><input required type="text" id="name"></div>
            <div class="field"><label>E-mail</label><input required type="email" id="email"></div>
            <div class="field"><label>Telefon</label><input required type="text" id="phone"></div>
            <div class="field"><label>C√≠m</label><input required type="text" id="address"></div>
            <div class="field"><label>Sz√°ll√≠t√°s m√≥dja</label><input required type="text" id="shipping"></div>
            <div class="field"><label>Megjegyz√©s</label><textarea id="note" placeholder="(opcion√°lis)"></textarea></div>
          </details>
          <button class="btn-primary" type="submit" style="width:100%">Rendel√©s elk√ºld√©se</button>
          <p class="note" style="font-size:12px;color:#64748b">Elk√ºld√©skor a rendel√©s beker√ºl az ‚Äûorders‚Äù t√°bl√°ba.</p>
        </form>
      </div>
    </div>
  </aside>

  <!-- Supabase + logika -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase (a Te projekted) ---
    const SUPA_URL = "https://gckynywmoxylwyppmkck.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdja3lueXdtb3h5bHd5cHBta2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODUsImV4cCI6MjA3NDk2MTE4NX0.0p2EsBFpWnYCq5IpQ6T3FsgKkJBNt0kGRd901sNBanI";
    const supa = supabase.createClient(SUPA_URL, SUPA_KEY);

    // --- √Ållapot + DOM ---
    let products = [];
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const sortSel = document.getElementById("sort");
    const cartBtn = document.getElementById("openCart");
    const closeCartBtn = document.getElementById("closeCart");
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("backdrop");
    const cartLines = document.getElementById("cartLines");
    const totals = document.getElementById("totals");
    const orderForm = document.getElementById("orderForm");
    const cartCount = document.getElementById("cartCount");

    function fmt(n){return new Intl.NumberFormat('hu-HU').format(n)+" Ft";}
    function setCartCount(){cartCount.textContent = cart.reduce((a,x)=>a+x.qty,0);}

    // --- Term√©kek let√∂lt√©se ---
    async function loadProducts(){
      const { data, error } = await supa
        .from("products")
        .select("id,title,price,instock,image_url,description")
        .order("created_at",{ascending:false});
      if(error){ grid.innerHTML = `<div class="empty">Hiba: ${error.message}</div>`; return; }
      products = data || [];
      renderList();
    }

    // --- Lista k√°rty√°kkal + qty v√°laszt√≥ ---
    function renderList(){
      const q = (search.value||"").toLowerCase();
      let arr = products.filter(p => (p.title||"").toLowerCase().includes(q));
      if(sortSel.value==="price-asc") arr.sort((a,b)=> (a.price||0)-(b.price||0));
      if(sortSel.value==="price-desc") arr.sort((a,b)=> (b.price||0)-(a.price||0));

      grid.innerHTML = arr.map(p => {
        const img = p.image_url || '';
        const price = fmt(p.price||0);
        const stock = p.instock ? 'ok' : 'out';
        return `
          <article class="card" data-id="${p.id}">
            <a class="thumb" href="product.html?id=${encodeURIComponent(p.id)}" title="${escapeHtml(p.title||'')}">
              <img src="${img}" alt="${escapeHtml(p.title||'')}" onerror="this.src='https://placehold.co/600x450?text=Nincs+k√©p'">
            </a>
            <div class="body">
              <div class="row">
                <div class="title">${escapeHtml(p.title||'‚Äî')}</div>
                <div class="price">${price}</div>
              </div>
              <div class="row">
                <span class="badge ${stock}">${p.instock?'k√©szleten':'nem el√©rhet≈ë'}</span>
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="qty">
                    <button type="button" data-qty="-1">‚àí</button>
                    <input type="text" value="1" inputmode="numeric" maxlength="3" />
                    <button type="button" data-qty="+1">+</button>
                  </div>
                  <button class="btn-primary" ${p.instock?'':'disabled'} data-add>Kos√°rba</button>
                  <a class="btn" href="product.html?id=${encodeURIComponent(p.id)}">Megnyit√°s</a>
                </div>
              </div>
            </div>
          </article>
        `;
      }).join("") || `<div class="empty">Nincs tal√°lat.</div>`;
    }

    // --- K√°rtya esem√©nyek (egy deleg√°lt handler, hogy ne dupl√°z√≥djon) ---
    grid.addEventListener("click", (e)=>{
      const card = e.target.closest(".card"); if(!card) return;
      const id = card.getAttribute("data-id");
      const prod = products.find(x=> String(x.id) === String(id)); if(!prod) return;

      // mennyis√©g gombok
      if (e.target.matches("[data-qty]")) {
        const input = card.querySelector(".qty input");
        let v = parseInt(input.value||"1",10);
        if (e.target.getAttribute("data-qty")==="+1") v++;
        else v = Math.max(1, v-1);
        input.value = String(v);
      }

      // Kos√°rba
      if (e.target.matches("[data-add]")) {
        const input = card.querySelector(".qty input");
        let qty = Math.max(1, parseInt((input?.value||"1"),10)||1);
        addToCart(prod, qty);
        openCart(); // azonnal nyit
      }
    });

    // --- Kos√°r m≈±veletek ---
    function addToCart(p, qty=1){
      const i = cart.findIndex(x => String(x.id) === String(p.id));
      if (i>-1) cart[i].qty += qty;
      else cart.push({ id:p.id, title:p.title, price:p.price||0, image_url:p.image_url, qty });
      saveCart();
    }
    function saveCart(){ localStorage.setItem("cart", JSON.stringify(cart)); setCartCount(); drawCart(); }
    function openCart(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); drawCart(); }
    function closeCart(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }
    document.getElementById("openCart").onclick = openCart;
    closeCartBtn.onclick = closeCart;
    backdrop.onclick = closeCart;

    function drawCart(){
      if(cart.length===0){ cartLines.innerHTML = `<div class="empty">A kos√°r √ºres.</div>`; totals.innerHTML=""; return; }
      cartLines.innerHTML = cart.map((l,i)=>`
        <div class="line">
          <img src="${l.image_url||''}" alt="" onerror="this.src='https://placehold.co/80'">
          <div>
            <div style="font-weight:600">${escapeHtml(l.title||'‚Äî')}</div>
            <div class="qty2" style="margin-top:6px">
              <button data-dec="${i}">‚àí</button>
              <input value="${l.qty}" readonly>
              <button data-inc="${i}">+</button>
            </div>
            <button class="btn" data-del="${i}" style="margin-top:6px">Elt√°vol√≠t√°s</button>
          </div>
          <div style="font-weight:700">${fmt((l.price||0)*l.qty)}</div>
        </div>
      `).join("");

      const sub = cart.reduce((a,l)=>a+(l.price||0)*l.qty,0);
      totals.innerHTML = `
        <div class="line"><div>R√©sz√∂sszeg</div><div></div><div>${fmt(sub)}</div></div>
        <div class="line"><div>Sz√°ll√≠t√°s</div><div></div><div>0 Ft</div></div>
        <div class="line" style="font-weight:700"><div>√ñsszesen</div><div></div><div>${fmt(sub)}</div></div>
      `;

      cartLines.querySelectorAll("[data-inc]").forEach(b=> b.onclick = ()=>{ cart[b.dataset.inc].qty++; saveCart(); });
      cartLines.querySelectorAll("[data-dec]").forEach(b=> b.onclick = ()=>{ const i=b.dataset.dec; cart[i].qty=Math.max(1,cart[i].qty-1); saveCart(); });
      cartLines.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{ cart.splice(b.dataset.del,1); saveCart(); });
    }

    // --- Rendel√©s k√ºld√©se az orders t√°bl√°ba ---
    orderForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(cart.length===0){ alert("A kos√°r √ºres."); return; }
      const subtotal = cart.reduce((a,l)=>a+(l.price||0)*l.qty,0);
      const payload = {
        name: document.getElementById("name").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        shipping: document.getElementById("shipping").value.trim(),
        note: document.getElementById("note").value.trim() || null,
        items: cart.map(l=>({id:l.id,title:l.title,price:l.price,qty:l.qty,image_url:l.image_url})),
        subtotal, shipping_cost:0, total:subtotal, status:'new'
      };
      const { error } = await supa.from("orders").insert(payload);
      if(error){ alert("Hiba: "+error.message); return; }
      cart = []; saveCart(); closeCart();
      alert("K√∂sz√∂nj√ºk a megrendel√©st! ‚úî");
    });

    // --- Esem√©nyek ---
    search.oninput = ()=>renderList();
    sortSel.onchange = ()=>renderList();

    // start
    setCartCount();
    loadProducts();

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  </script>
</body>
</html>
